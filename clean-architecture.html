<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clean Architecture äº’å‹•å­¸ç¿’</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
<style>
:root{
  --bg:#FAFAF8;--bg-card:#FFFFFF;
  --lav:#B8A9E8;--pink:#F2B8C6;--blue:#A8C8E8;--mint:#B8E8D0;
  --txt:#2D2B3A;--txt2:#8E8A9E;--txt3:#C4C0D0;
  --glass:rgba(255,255,255,0.6);--glass-b:rgba(255,255,255,0.3);
  --sh:0 4px 24px rgba(0,0,0,0.04);--sh2:0 8px 32px rgba(0,0,0,0.08);
  --r:20px;--rs:12px;--rxs:8px;
  --ease:all .3s cubic-bezier(.4,0,.2,1);
  --side:280px;--top:64px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans TC','Pretendard',sans-serif;background:var(--bg);color:var(--txt);line-height:1.7;overflow-x:hidden}
h1,h2,h3,h4{font-family:'Pretendard','Noto Sans TC',sans-serif;font-weight:700;line-height:1.3}
code,pre{font-family:'JetBrains Mono',monospace}
a{color:var(--lav);text-decoration:none}
button{cursor:pointer;font-family:inherit;border:none;background:none}

/* Opening */
.opening{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#f5f0ff 0%,#fff5f8 50%,#f0f7ff 100%);transition:opacity .8s ease}
.opening.hide{opacity:0;pointer-events:none}
.opening-box{text-align:center;max-width:520px;padding:60px 40px;animation:fadeUp .8s ease}
.opening-box h1{font-size:2.4rem;background:linear-gradient(135deg,var(--lav),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:12px}
.opening-box .sub{font-size:1.1rem;color:var(--txt2);margin-bottom:32px;line-height:1.8}
.btn-start{display:inline-block;padding:14px 48px;border-radius:50px;font-size:1rem;font-weight:600;color:#fff;
  background:linear-gradient(135deg,var(--lav),var(--pink));box-shadow:0 4px 20px rgba(184,169,232,.4);transition:var(--ease)}
.btn-start:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(184,169,232,.5)}

/* Topbar */
.topbar{position:fixed;top:0;left:0;right:0;height:var(--top);background:var(--glass);backdrop-filter:blur(12px);
  border-bottom:1px solid var(--glass-b);z-index:100;display:flex;align-items:center;padding:0 24px;gap:16px}
.topbar .logo{font-weight:700;font-size:1rem;white-space:nowrap;background:linear-gradient(135deg,var(--lav),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.progress-wrap{flex:1;max-width:300px;height:8px;background:#eee;border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--lav),var(--pink));border-radius:4px;transition:width .5s ease}
.xp-badge{display:flex;align-items:center;gap:6px;font-weight:600;font-size:.9rem;color:var(--lav);white-space:nowrap}
.xp-badge .num{min-width:36px}
.badge-row{display:flex;gap:4px}
.badge-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem;
  background:#f0edf8;transition:var(--ease)}
.badge-icon.earned{background:linear-gradient(135deg,var(--lav),var(--pink));box-shadow:0 2px 8px rgba(184,169,232,.3)}
.hamburger{display:none;font-size:1.4rem;padding:4px}
.streak-tag{font-size:.75rem;padding:3px 10px;border-radius:20px;background:linear-gradient(135deg,var(--mint),var(--blue));color:var(--txt);font-weight:500;white-space:nowrap}

/* Sidebar */
.sidebar{position:fixed;top:var(--top);left:0;bottom:0;width:var(--side);background:var(--glass);backdrop-filter:blur(12px);
  border-right:1px solid var(--glass-b);padding:24px 16px;overflow-y:auto;z-index:90;transition:transform .3s ease}
.sidebar h3{font-size:.75rem;text-transform:uppercase;letter-spacing:2px;color:var(--txt2);margin-bottom:12px}
.side-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:var(--rs);margin-bottom:4px;cursor:pointer;transition:var(--ease);font-size:.9rem}
.side-item:hover{background:rgba(184,169,232,.08)}
.side-item.active{background:rgba(184,169,232,.15);font-weight:600;color:var(--lav)}
.side-item.completed{color:var(--mint)}
.side-item.completed::after{content:'âœ“';margin-left:auto;color:var(--mint);font-weight:700}
.side-item.locked{color:var(--txt3);cursor:not-allowed}
.side-item.locked:hover{background:transparent}
.side-item .lock{margin-left:auto;font-size:.8rem}
.side-sep{height:1px;background:var(--glass-b);margin:16px 0}
.side-stats{font-size:.8rem;color:var(--txt2);line-height:2}
.side-badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.side-badge{font-size:1.2rem;filter:grayscale(1) opacity(.3);transition:var(--ease)}
.side-badge.earned{filter:none}

/* Main */
.main{margin-left:var(--side);margin-top:var(--top);min-height:calc(100vh - var(--top));padding:40px 48px 80px}

/* Cards */
.glass-card{background:var(--bg-card);border:1px solid var(--glass-b);border-radius:var(--r);box-shadow:var(--sh);padding:32px;margin-bottom:24px;transition:var(--ease)}
.glass-card:hover{box-shadow:var(--sh2)}

/* Part header */
.part-hdr{margin-bottom:32px}
.part-hdr .tag{display:inline-block;font-size:.75rem;font-weight:600;padding:4px 14px;border-radius:20px;margin-bottom:12px;
  background:linear-gradient(135deg,var(--lav),var(--pink));color:#fff}
.part-hdr h1{font-size:1.8rem;margin-bottom:8px}
.part-hdr .desc{color:var(--txt2);font-size:1rem}

/* Accordion */
.accordion{border:1px solid #eee;border-radius:var(--rs);overflow:hidden;margin-bottom:12px}
.acc-head{width:100%;text-align:left;padding:16px 20px;font-weight:600;font-size:.95rem;display:flex;justify-content:space-between;align-items:center;
  background:var(--bg-card);transition:var(--ease)}
.acc-head:hover{background:#faf8ff}
.acc-head .arrow{transition:transform .3s ease;font-size:.8rem}
.acc-head.open .arrow{transform:rotate(180deg)}
.acc-body{max-height:0;overflow:hidden;transition:max-height .4s ease;background:#fdfcff}
.acc-body.open{max-height:2000px}
.acc-inner{padding:0 20px 20px}

/* Code */
.code-wrap{background:#1e1e2e;border-radius:var(--rs);padding:20px;margin:12px 0;overflow-x:auto;font-size:.85rem;line-height:1.6}
.code-wrap code{color:#cdd6f4;white-space:pre-wrap;word-break:break-all}
.hl-kw{color:#cba6f7}.hl-ty{color:#89b4fa}.hl-st{color:#a6e3a1}.hl-cm{color:#6c7086;font-style:italic}.hl-an{color:#f9e2af}.hl-fn{color:#89dceb}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 24px;border-radius:50px;font-size:.9rem;font-weight:500;transition:var(--ease)}
.btn-pri{background:linear-gradient(135deg,var(--lav),var(--pink));color:#fff;box-shadow:0 4px 16px rgba(184,169,232,.3)}
.btn-pri:hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(184,169,232,.4)}
.btn-pri:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-sec{background:#f5f3fa;color:var(--lav)}
.btn-sec:hover{background:#ece8f6}
.btn-ghost{color:var(--txt2);padding:8px 16px}
.btn-ghost:hover{color:var(--txt);background:#f5f3fa}

/* Quiz section */
.quiz-box{background:linear-gradient(135deg,#faf8ff,#fff8fa);border:2px solid #ede8f8;border-radius:var(--r);padding:32px;margin:32px 0}
.quiz-box h3{font-size:1.1rem;margin-bottom:20px;display:flex;align-items:center;gap:8px}
.quiz-row{display:flex;gap:12px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.quiz-tag{display:inline-block;padding:8px 16px;border-radius:var(--rxs);font-weight:600;font-size:.9rem;min-width:40px;text-align:center;
  background:var(--bg-card);border:2px solid #e0dce8;cursor:pointer;transition:var(--ease);user-select:none}
.quiz-tag.selected{border-color:var(--lav);background:#f5f0ff;color:var(--lav)}
.quiz-tag.correct{border-color:var(--mint);background:#f0faf5;color:#2d8a5e}
.quiz-tag.wrong{border-color:var(--pink);background:#fff5f8;color:#c44}
.quiz-tag.matched{opacity:.6;cursor:default}
.quiz-select{padding:8px 12px;border-radius:var(--rxs);border:2px solid #e0dce8;font-size:.85rem;font-family:inherit;background:var(--bg-card);min-width:200px}
.quiz-opt{display:block;padding:12px 16px;border-radius:var(--rs);border:2px solid #e0dce8;margin-bottom:8px;cursor:pointer;transition:var(--ease)}
.quiz-opt:hover{border-color:var(--lav);background:#faf8ff}
.quiz-opt.selected{border-color:var(--lav);background:#f5f0ff}
.quiz-opt.correct{border-color:var(--mint);background:#f0faf5}
.quiz-opt.wrong{border-color:var(--pink);background:#fff5f8}
.quiz-result{margin-top:16px;padding:16px;border-radius:var(--rs);font-weight:500}
.quiz-result.pass{background:#f0faf5;color:#2d8a5e}
.quiz-result.fail{background:#fff5f8;color:#c44}

/* Sorting quiz */
.sort-item{display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg-card);border:1px solid #eee;border-radius:var(--rxs);margin-bottom:6px}
.sort-item .num{width:24px;height:24px;border-radius:50%;background:var(--lav);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;flex-shrink:0}
.sort-item .text{flex:1;font-size:.85rem}
.sort-btn{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.7rem;background:#f5f3fa;color:var(--txt2);transition:var(--ease)}
.sort-btn:hover{background:var(--lav);color:#fff}

/* TF quiz */
.tf-row{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;background:var(--bg-card);border:1px solid #eee;border-radius:var(--rs);margin-bottom:8px}
.tf-code{flex:1;font-size:.85rem;font-family:'JetBrains Mono',monospace;color:var(--txt)}
.tf-btns{display:flex;gap:6px;flex-shrink:0}
.tf-btn{padding:6px 14px;border-radius:20px;font-size:.8rem;font-weight:600;border:2px solid #eee;transition:var(--ease)}
.tf-btn:hover{border-color:var(--lav)}
.tf-btn.sel-t{border-color:var(--mint);background:#f0faf5;color:#2d8a5e}
.tf-btn.sel-f{border-color:var(--pink);background:#fff5f8;color:#c44}

/* Code editor */
.code-editor{width:100%;min-height:200px;background:#1e1e2e;color:#cdd6f4;border:2px solid #313244;border-radius:var(--rs);
  padding:20px;font-family:'JetBrains Mono',monospace;font-size:.85rem;line-height:1.6;resize:vertical;tab-size:4}
.code-editor:focus{outline:none;border-color:var(--lav)}

/* Briefing card */
.brief-card{background:linear-gradient(135deg,#faf8ff,#f8f5ff);border:1px solid #e8e0f8;border-radius:var(--r);padding:28px 32px;margin:24px 0}
.brief-card h3{font-size:1rem;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.brief-point{padding:8px 0;font-size:.9rem;display:flex;gap:8px}
.brief-point .pin{flex-shrink:0}
.brief-qa{margin-top:16px;padding:16px;background:rgba(184,169,232,.08);border-radius:var(--rs);font-size:.9rem}
.brief-qa .q{font-weight:600;margin-bottom:8px}

/* Insight */
.insight-block{border:1px dashed var(--lav);border-radius:var(--rs);margin:16px 0;overflow:hidden}
.insight-head{width:100%;text-align:left;padding:14px 20px;font-size:.9rem;font-weight:500;color:var(--lav);display:flex;justify-content:space-between;align-items:center;transition:var(--ease)}
.insight-head:hover{background:rgba(184,169,232,.05)}
.insight-body{max-height:0;overflow:hidden;transition:max-height .4s ease}
.insight-body.open{max-height:500px}
.insight-inner{padding:0 20px 16px;font-size:.9rem;color:var(--txt2);line-height:1.8}
.insight-xp{display:inline-block;font-size:.75rem;padding:2px 8px;border-radius:10px;background:var(--mint);color:#fff;font-weight:600}

/* Dependency animation */
.dep-diagram{display:flex;justify-content:center;align-items:center;gap:0;margin:24px 0;flex-wrap:wrap}
.dep-layer{padding:16px 24px;border-radius:var(--rs);font-weight:600;font-size:.85rem;text-align:center;min-width:140px;position:relative}
.dep-arrow{font-size:1.4rem;color:var(--lav);animation:pulse 2s infinite;margin:0 4px}
@keyframes arrowFlow{0%,100%{opacity:.3}50%{opacity:1}}
.dep-outer{background:#fce4ec;color:#c62828;border:2px solid #ef9a9a}
.dep-mid{background:#e3f2fd;color:#1565c0;border:2px solid #90caf9}
.dep-inner{background:#e8f5e9;color:#2e7d32;border:2px solid #a5d6a7}

/* Layer toggle */
.toggle-wrap{display:flex;justify-content:center;margin:20px 0}
.toggle-sw{display:flex;background:#f0edf8;border-radius:50px;padding:4px}
.toggle-opt{padding:8px 24px;border-radius:50px;font-size:.85rem;font-weight:500;cursor:pointer;transition:var(--ease)}
.toggle-opt.active{background:var(--lav);color:#fff}

/* Comparison table */
.cmp-table{width:100%;border-collapse:separate;border-spacing:0;border-radius:var(--rs);overflow:hidden;margin:16px 0;font-size:.85rem}
.cmp-table th{background:#f5f3fa;padding:12px 16px;text-align:left;font-weight:600;border-bottom:2px solid #e8e0f8}
.cmp-table td{padding:10px 16px;border-bottom:1px solid #f0edf8}
.cmp-table tr:hover td{background:#faf8ff}
.cmp-hl{background:rgba(184,169,232,.1)!important}

/* Toast notification */
.toast-wrap{position:fixed;top:80px;right:24px;z-index:200;display:flex;flex-direction:column;gap:8px}
.toast{padding:14px 24px;border-radius:var(--rs);background:var(--bg-card);box-shadow:var(--sh2);display:flex;align-items:center;gap:10px;
  font-size:.9rem;font-weight:500;animation:slideIn .4s ease;min-width:240px}
.toast.xp{border-left:4px solid var(--lav)}
.toast.badge-t{border-left:4px solid var(--mint)}
@keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:none;opacity:1}}
@keyframes fadeUp{from{transform:translateY(30px);opacity:0}to{transform:none;opacity:1}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}

/* Feynman */
.feynman-q{margin-bottom:20px}
.feynman-q label{display:block;font-weight:600;font-size:.95rem;margin-bottom:8px}
.feynman-ta{width:100%;min-height:80px;border:2px solid #e0dce8;border-radius:var(--rs);padding:14px;font-family:inherit;font-size:.9rem;resize:vertical;line-height:1.6}
.feynman-ta:focus{outline:none;border-color:var(--lav)}
.feynman-ref{margin-top:8px;padding:12px;background:#f5f3fa;border-radius:var(--rxs);font-size:.85rem;display:none}
.feynman-ref.show{display:block}
.rating{display:flex;gap:4px;margin-top:8px}
.rating-star{font-size:1.2rem;cursor:pointer;color:#ddd;transition:var(--ease)}
.rating-star.lit{color:#f9c74f}

/* Read button */
.read-done{text-align:center;margin:24px 0;padding:20px;border:2px dashed #e0dce8;border-radius:var(--rs)}
.read-done.done{border-color:var(--mint);background:#f0faf5}

/* Radar chart */
.radar-section{background:var(--bg-card);border-radius:var(--r);box-shadow:var(--sh);padding:40px;margin-top:40px;text-align:center}
.radar-section h2{margin-bottom:24px;font-size:1.2rem}

/* Footer summary */
.footer-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:24px}
.foot-stat{padding:20px;background:#f5f3fa;border-radius:var(--rs);text-align:center}
.foot-stat .val{font-size:2rem;font-weight:700;background:linear-gradient(135deg,var(--lav),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.foot-stat .label{font-size:.8rem;color:var(--txt2);margin-top:4px}

/* Step cards */
.step-card{padding:20px;background:var(--bg-card);border:1px solid #eee;border-radius:var(--rs);margin-bottom:12px;transition:var(--ease)}
.step-card.active{border-color:var(--lav);box-shadow:0 0 0 3px rgba(184,169,232,.15)}
.step-num{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:var(--lav);color:#fff;font-size:.8rem;font-weight:700;margin-right:8px}
.step-file{font-family:'JetBrains Mono',monospace;font-size:.8rem;color:var(--lav);margin:6px 0}
.step-nav{display:flex;gap:8px;justify-content:center;margin:16px 0}

/* Responsive */
@media(max-width:768px){
  .hamburger{display:block}
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:none}
  .main{margin-left:0;padding:24px 16px 60px}
  .topbar{padding:0 12px}
  .quiz-row{flex-direction:column}
  .dep-diagram{flex-direction:column;gap:8px}
  .dep-arrow{transform:rotate(90deg)}
  .opening-box{padding:40px 24px}
  .opening-box h1{font-size:1.8rem}
  .cmp-table{font-size:.75rem}
  .cmp-table th,.cmp-table td{padding:8px 10px}
}
</style>
</head>
<body>

<div class="opening" id="opening">
  <div class="opening-box">
    <div style="font-size:3rem;margin-bottom:16px">ğŸ›ï¸</div>
    <h1>æ¶æ§‹å®ˆè­·è€…</h1>
    <p class="sub">ä½ å³å°‡æˆç‚ºåœ˜éšŠçš„æ¶æ§‹å®ˆè­·è€…ã€‚<br>æ¯ä¸€å±¤çš„è¨­è¨ˆæ±ºç­–ï¼Œéƒ½å°‡ç”±ä½ å‘ä¸»ç®¡èªªæ˜ã€‚<br><br>é€é 7 å€‹ç« ç¯€çš„äº’å‹•å­¸ç¿’ï¼Œ<br>å¾ SOLID åŸå‰‡åˆ°è²»æ›¼é©—è­‰ï¼Œæˆç‚ºçœŸæ­£çš„æ¶æ§‹å¸«ã€‚</p>
    <button class="btn-start" onclick="startJourney()">é–‹å§‹æ—…ç¨‹</button>
  </div>
</div>

<header class="topbar" id="topbar">
  <button class="hamburger" onclick="toggleSidebar()">â˜°</button>
  <div class="logo">ğŸ› Clean Architecture</div>
  <div class="progress-wrap"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
  <div class="xp-badge">âš¡ <span class="num" id="xp-num">0</span> XP</div>
  <div class="streak-tag" id="streak-tag" style="display:none"></div>
  <div class="badge-row" id="badge-row"></div>
</header>

<nav class="sidebar" id="sidebar"></nav>
<main class="main" id="main-content"></main>
<div class="toast-wrap" id="toast-wrap"></div>

<script>
// ============================================================
// STATE
// ============================================================
const DEFAULT_STATE = {
  currentPart:1, xp:0, completedParts:[], unlockedParts:[1], badges:[],
  expandedInsights:[], readParts:[], streak:0, lastDate:null,
  part1Matches:{}, part2Answers:[null,null,null,null], part3Answer:null,
  part4Order:null, part5Answer:null, part6Code:'', part7Answers:['','','',''],
  part7Ratings:[0,0,0,0], openingDone:false, briefingsRead:[]
};
let S = JSON.parse(JSON.stringify(DEFAULT_STATE));

function load(){
  try{ const d=localStorage.getItem('ca-learn'); if(d){const p=JSON.parse(d);Object.assign(S,p)} }catch(e){}
}
function save(){ localStorage.setItem('ca-learn',JSON.stringify(S)) }

// ============================================================
// CONSTANTS
// ============================================================
const PARTS = [
  {id:1,title:'SOLID åŸå‰‡',sub:'Clean Architecture çš„åœ°åŸº',icon:'ğŸ§±',xpRead:50,xpQuiz:50},
  {id:2,title:'Dependency Rule',sub:'Clean Architecture çš„éˆé­‚',icon:'â¡ï¸',xpRead:50,xpQuiz:50},
  {id:3,title:'åŒå¿ƒåœ“æ˜ å°„',sub:'å››å±¤â†’ä¸‰å±¤çš„å°æ‡‰é—œä¿‚',icon:'ğŸ—ºï¸',xpRead:50,xpQuiz:50},
  {id:4,title:'é€å±¤å¯¦æˆ°èµ°è®€',sub:'10 æ­¥è³‡æ–™æµå®Œæ•´è¿½è¹¤',icon:'ğŸ“–',xpRead:50,xpQuiz:50},
  {id:5,title:'YT Dev vs Google NIA',sub:'å…©å¤§æµæ´¾æ·±åº¦æ¯”è¼ƒ',icon:'âš–ï¸',xpRead:50,xpQuiz:50},
  {id:6,title:'å‹•æ‰‹ç·´ç¿’',sub:'åŠ å…¥ Use Case å±¤',icon:'ğŸ› ï¸',xpRead:0,xpQuiz:200},
  {id:7,title:'è²»æ›¼é©—è­‰',sub:'ç”¨è‡ªå·±çš„è©±è§£é‡‹æ¶æ§‹',icon:'ğŸ“',xpRead:0,xpQuiz:150}
];
const BADGES = [
  {id:'solid',name:'SOLID åŸºçŸ³',icon:'ğŸ§±',req:[1]},
  {id:'dep',name:'ä¾è³´è¿½è¹¤è€…',icon:'â¡ï¸',req:[2]},
  {id:'map',name:'æ¶æ§‹è£½åœ–å¸«',icon:'ğŸ—ºï¸',req:[3,4]},
  {id:'judge',name:'æµæ´¾é‘‘å®šå¸«',icon:'âš–ï¸',req:[5]},
  {id:'craft',name:'Use Case å·¥åŒ ',icon:'ğŸ› ï¸',req:[6]},
  {id:'master',name:'æ¶æ§‹å¸«',icon:'ğŸ“',req:[1,2,3,4,5,6,7]}
];
const TOTAL_XP = 950;

// ============================================================
// UTILITIES
// ============================================================
function hl(code){
  let c = code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return c.replace(/(\/\/.*$)|("(?:[^"\\]|\\.)*")|(@\w+)|(\b(?:class|data|fun|val|var|suspend|operator|sealed|interface|import|package|override|private|return|if|else|when|object|open|abstract|is|in|internal|enum|null|true|false|by|inline|typealias|out)\b)|(\b(?:String|Int|Double|Boolean|List|Flow|Result|Unit|Long|CoinDataSource|Coin|CoinPrice|CoinDto|CoinPriceDto|NetworkError|CoinUi|CoinListState|DisplayableNumber|HttpClient|ZonedDateTime|Error|DomainError)\b)/gm,
    (m,cm,st,an,kw,ty)=>{
      if(cm)return'<span class="hl-cm">'+cm+'</span>';if(st)return'<span class="hl-st">'+st+'</span>';
      if(an)return'<span class="hl-an">'+an+'</span>';if(kw)return'<span class="hl-kw">'+kw+'</span>';
      if(ty)return'<span class="hl-ty">'+ty+'</span>';return m;
    });
}
function codeBlock(code){ return '<div class="code-wrap"><code>'+hl(code)+'</code></div>' }
function updateStreak(){
  const today=new Date().toISOString().split('T')[0];
  if(S.lastDate===today)return;
  const y=new Date(Date.now()-864e5).toISOString().split('T')[0];
  S.streak = S.lastDate===y ? S.streak+1 : 1;
  S.lastDate=today; save();
}
function showToast(text,type='xp'){
  const w=document.getElementById('toast-wrap');
  const t=document.createElement('div');t.className='toast '+type;t.textContent=text;
  w.appendChild(t);setTimeout(()=>t.remove(),3000);
}

// ============================================================
// GAMIFICATION
// ============================================================
function addXP(amount,msg){
  S.xp=Math.min(S.xp+amount,TOTAL_XP);save();
  showToast('+'+ amount+' XP â€” '+msg,'xp');
  renderTopbar();
}
function checkBadges(){
  BADGES.forEach(b=>{
    if(S.badges.includes(b.id))return;
    if(b.req.every(r=>S.completedParts.includes(r))){
      S.badges.push(b.id);save();
      showToast(b.icon+' ç²å¾—å¾½ç« ï¼š'+b.name,'badge-t');
    }
  });
  renderTopbar();renderSidebar();
}
function markRead(partId){
  if(S.readParts.includes(partId))return;
  const p=PARTS.find(x=>x.id===partId);
  S.readParts.push(partId);save();
  if(p.xpRead>0)addXP(p.xpRead,'å®Œæˆ Part '+partId+' é–±è®€');
  render();
}
function completePart(partId){
  if(S.completedParts.includes(partId))return;
  const p=PARTS.find(x=>x.id===partId);
  S.completedParts.push(partId);
  const next=partId+1;
  if(next<=7&&!S.unlockedParts.includes(next))S.unlockedParts.push(next);
  save();
  if(p.xpQuiz>0)addXP(p.xpQuiz,'é€šé Part '+partId+' æ¸¬é©—');
  checkBadges();render();
}
function expandInsight(id){
  const body=document.getElementById('insight-body-'+id);
  if(!body)return;
  body.classList.toggle('open');
  if(body.classList.contains('open')&&!S.expandedInsights.includes(id)){
    S.expandedInsights.push(id);save();addXP(25,'å±•é–‹æ·±å…¥äº†è§£');
  }
}
function markBriefingRead(partId){
  if(!S.briefingsRead.includes(partId)){S.briefingsRead.push(partId);save();}
}

// ============================================================
// RENDERING
// ============================================================
function render(){renderTopbar();renderSidebar();renderMain();}

function renderTopbar(){
  const pct=Math.round(S.completedParts.length/7*100);
  document.getElementById('progress-fill').style.width=pct+'%';
  document.getElementById('xp-num').textContent=S.xp;
  const br=document.getElementById('badge-row');
  br.innerHTML=BADGES.map(b=>'<div class="badge-icon'+(S.badges.includes(b.id)?' earned':'')+'" title="'+b.name+'">'+b.icon+'</div>').join('');
  const st=document.getElementById('streak-tag');
  if(S.streak>0){st.style.display='';st.textContent='ğŸ”¥ é€£çºŒ '+S.streak+' å¤©';}
}

function renderSidebar(){
  const sb=document.getElementById('sidebar');
  sb.innerHTML='<h3>ç« ç¯€</h3>'+PARTS.map(p=>{
    const locked=!S.unlockedParts.includes(p.id);
    const done=S.completedParts.includes(p.id);
    const active=S.currentPart===p.id;
    let cls='side-item';if(active)cls+=' active';if(done)cls+=' completed';if(locked)cls+=' locked';
    return '<div class="'+cls+'" onclick="'+(locked?'':'navigateTo('+p.id+')')+'">'+
      '<span>'+p.icon+'</span><span>Part '+p.id+'</span><span style="flex:1;font-size:.8rem;color:var(--txt2)">'+p.title+'</span>'+
      (locked?'<span class="lock">ğŸ”’</span>':'')+'</div>';
  }).join('')+'<div class="side-sep"></div><h3>æˆå°±</h3><div class="side-badges">'+
  BADGES.map(b=>'<span class="side-badge'+(S.badges.includes(b.id)?' earned':'')+'" title="'+b.name+'">'+b.icon+'</span>').join('')+
  '</div><div class="side-sep"></div><div class="side-stats">'+
  'ğŸ“Š é€²åº¦ï¼š'+S.completedParts.length+' / 7<br>âš¡ XPï¼š'+S.xp+' / '+TOTAL_XP+
  '<br>ğŸ… å¾½ç« ï¼š'+S.badges.length+' / '+BADGES.length+'</div>';
}

function renderMain(){
  const c=document.getElementById('main-content');
  const fns=[null,getPart1,getPart2,getPart3,getPart4,getPart5,getPart6,getPart7];
  const fn=fns[S.currentPart];
  c.innerHTML=fn?fn():'';
  c.innerHTML+=getRadarHTML();
  window.scrollTo({top:0,behavior:'smooth'});
}

// ============================================================
// NAVIGATION
// ============================================================
function navigateTo(id){
  if(!S.unlockedParts.includes(id))return;
  S.currentPart=id;save();render();
}
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
}
function startJourney(){
  S.openingDone=true;save();
  document.getElementById('opening').classList.add('hide');
  setTimeout(()=>document.getElementById('opening').style.display='none',800);
}

// ============================================================
// PART 1: SOLID åŸå‰‡
// ============================================================
function getPart1(){
  const done=S.completedParts.includes(1);
  const read=S.readParts.includes(1);
  const solidData=[
    {letter:'S',name:'Single Responsibility Principle',zh:'å–®ä¸€è·è²¬åŸå‰‡',
     desc:'æ¯å€‹é¡åˆ¥åªæœ‰ä¸€å€‹æ”¹è®Šçš„ç†ç”±ã€‚<code>Coin.kt</code> åªå› æ¥­å‹™æ¬„ä½è®Šæ›´è€Œæ”¹ï¼Œ<code>CoinDto.kt</code> åªå›  API æ ¼å¼è®Šæ›´è€Œæ”¹ï¼Œ<code>CoinMapper.kt</code> åªå› è½‰æ›é‚è¼¯è®Šæ›´è€Œæ”¹ã€‚',
     code:'// Domain å±¤ - ç´”ç²¹çš„æ¥­å‹™æ¨¡å‹\ndata class Coin(\n    val id: String,\n    val rank: Int,\n    val name: String,\n    val symbol: String,\n    val marketCapUsd: Double,\n    val priceUsd: Double,\n    val changePercent24Hr: Double,\n)\n\n// Data å±¤ - å°æ‡‰ API JSON\nimport kotlinx.serialization.Serializable\n\n@Serializable\ndata class CoinDto(\n    val id: String,\n    val rank: Int,\n    val name: String,\n    // ... å¸¶æœ‰åºåˆ—åŒ–æ¨™è¨˜\n)'},
    {letter:'O',name:'Open/Closed Principle',zh:'é–‹æ”¾å°é–‰åŸå‰‡',
     desc:'å°æ“´å±•é–‹æ”¾ï¼Œå°ä¿®æ”¹å°é–‰ã€‚<code>Result&lt;D, E&gt;</code> æ˜¯ sealed interface â€” ç›®å‰æœ‰ <code>Success</code> å’Œ <code>Error</code>ï¼Œæœªä¾†è¦åŠ  <code>Loading</code> åªéœ€æ–°å¢å­é¡åˆ¥ï¼Œä¸ç”¨æ”¹ç¾æœ‰ç¨‹å¼ç¢¼ã€‚',
     code:'typealias DomainError = Error\n\nsealed interface Result<out D, out E: Error> {\n    data class Success<out D>(val data: D): Result<D, Nothing>\n    data class Error<out E: DomainError>(val error: E): Result<Nothing, E>\n}'},
    {letter:'L',name:'Liskov Substitution Principle',zh:'é‡Œæ°æ›¿æ›åŸå‰‡',
     desc:'å­å‹åˆ¥å¿…é ˆå¯ä»¥æ›¿æ›çˆ¶å‹åˆ¥ã€‚<code>RemoteCoinDataSource</code> å¯¦ä½œ <code>CoinDataSource</code> ä»‹é¢ï¼ŒViewModel é€éä»‹é¢å‘¼å« â€” å¯ä»¥ç„¡ç¸«æ›¿æ›ç‚º <code>LocalCoinDataSource</code> æˆ– <code>FakeCoinDataSource</code>ã€‚',
     code:'// ViewModel åªèªä»‹é¢\nclass CoinListViewModel(\n    private val coinDataSource: CoinDataSource  // ä»‹é¢\n) : ViewModel()\n\n// DI åœ¨åŸ·è¡Œæ™‚ç¶å®šå…·é«”å¯¦ä½œ\nsingleOf(::RemoteCoinDataSource).bind<CoinDataSource>()'},
    {letter:'I',name:'Interface Segregation Principle',zh:'ä»‹é¢éš”é›¢åŸå‰‡',
     desc:'ä¸è¦å¼·è¿«å®¢æˆ¶ç«¯ä¾è³´å®ƒä¸éœ€è¦çš„æ–¹æ³•ã€‚<code>Error</code> æ˜¯ç©ºçš„æ¨™è¨˜ä»‹é¢ï¼Œ<code>NetworkError</code> ç¹¼æ‰¿å®ƒä½†åªå®šç¾©ç¶²è·¯ç›¸é—œçš„éŒ¯èª¤ï¼Œä¸è¢«è¿«å¯¦ä½œä¸ç›¸é—œçš„æ–¹æ³•ã€‚',
     code:'interface Error  // ç©ºæ¨™è¨˜ä»‹é¢\n\nenum class NetworkError: Error {\n    REQUEST_TIMEOUT,\n    TOO_MANY_REQUESTS,\n    NO_INTERNET,\n    SERVER_ERROR,\n    SERIALIZATION,\n    UNKNOWN,\n}'},
    {letter:'D',name:'Dependency Inversion Principle',zh:'ä¾è³´åè½‰åŸå‰‡',
     desc:'é«˜å±¤æ¨¡çµ„å®šç¾©ä»‹é¢ï¼ˆå¥‘ç´„ï¼‰ï¼Œä½å±¤æ¨¡çµ„è² è²¬å¯¦ä½œã€‚<code>CoinDataSource</code> ä»‹é¢å®šç¾©åœ¨ Domain å±¤ï¼ˆé«˜å±¤ï¼‰ï¼Œ<code>RemoteCoinDataSource</code> åœ¨ Data å±¤ï¼ˆä½å±¤ï¼‰å¯¦ä½œã€‚',
     code:'// Domain å±¤å®šç¾©ã€Œæˆ‘éœ€è¦ä»€éº¼ã€\ninterface CoinDataSource {\n    suspend fun getCoins(): Result<List<Coin>, NetworkError>\n    suspend fun getCoinHistory(\n        coinId: String,\n        start: ZonedDateTime,\n        end: ZonedDateTime\n    ): Result<List<CoinPrice>, NetworkError>\n}\n\n// Data å±¤å¯¦ä½œã€Œæ€éº¼åšåˆ°ã€\nclass RemoteCoinDataSource(\n    private val httpClient: HttpClient\n): CoinDataSource { ... }'}
  ];

  let html='<div class="part-hdr"><span class="tag">Part 1</span><h1>ğŸ§± SOLID åŸå‰‡ â€” Clean Architecture çš„åœ°åŸº</h1>'+
    '<p class="desc">Clean Architecture å»ºç«‹åœ¨ SOLID åŸå‰‡ä¹‹ä¸Šã€‚ä»¥ CryptoTracker çš„å¯¦éš›ç¨‹å¼ç¢¼ï¼Œé€ä¸€ç†è§£æ¯å€‹åŸå‰‡å¦‚ä½•è¢«å¯¦è¸ã€‚</p></div>';

  // Accordion
  solidData.forEach((s,i)=>{
    html+='<div class="accordion"><button class="acc-head" onclick="toggleAcc(this)">'+
      '<span><strong style="color:var(--lav)">'+s.letter+'</strong> â€” '+s.zh+'ï¼ˆ'+s.name+'ï¼‰</span>'+
      '<span class="arrow">â–¼</span></button>'+
      '<div class="acc-body"><div class="acc-inner"><p>'+s.desc+'</p>'+codeBlock(s.code)+'</div></div></div>';
  });

  // Insight
  html+=insightBlock(1,'SOLID ä¸æ˜¯ Clean Architecture çš„å…¨éƒ¨ï¼Œä½†é•å SOLID çš„æ¶æ§‹ä¸€å®šä¸ Cleanã€‚Robert C. Martin æ­£æ˜¯ SOLID çš„æå‡ºè€…ï¼Œæ‰€ä»¥ Clean Architecture æ˜¯ SOLID åŸå‰‡çš„ç³»çµ±æ€§æ‡‰ç”¨â€”â€”å¾é¡åˆ¥å±¤ç´šæ¨å»£åˆ°ç³»çµ±å±¤ç´šã€‚');

  // Read button
  if(!read) html+='<div class="read-done"><button class="btn btn-sec" onclick="markRead(1)">âœ“ æˆ‘è®€å®Œäº†ï¼ˆ+50 XPï¼‰</button></div>';
  else html+='<div class="read-done done">âœ“ å·²å®Œæˆé–±è®€</div>';

  // Quiz
  html+=getQuiz1HTML(done);

  // Briefing
  html+=briefCard(1,'SOLID åŸå‰‡',[
    'æˆ‘å€‘çš„å°ˆæ¡ˆéµå¾ª SOLID åŸå‰‡ï¼Œæ¯å€‹æª”æ¡ˆæœ‰æ¸…æ¥šçš„å–®ä¸€è·è²¬ï¼ˆCoin vs CoinDto vs CoinMapperï¼‰ï¼Œé™ä½ä¿®æ”¹é¢¨éšª',
    'é€é sealed interfaceï¼ˆResultï¼‰å’Œä»‹é¢æŠ½è±¡ï¼ˆCoinDataSourceï¼‰ï¼Œç³»çµ±å°æ“´å±•é–‹æ”¾ã€å°ä¿®æ”¹å°é–‰',
    'æœ€é—œéµçš„æ˜¯ä¾è³´åè½‰â€”â€”Domain å±¤å®šç¾©ä»‹é¢ï¼ŒData å±¤å¯¦ä½œï¼Œæ ¸å¿ƒæ¥­å‹™é‚è¼¯ä¸å—æŠ€è¡“ç´°ç¯€ç¶æ¶'
  ],'ç‚ºä»€éº¼ Coin å’Œ CoinDto é•·å¾—å¹¾ä¹ä¸€æ¨£é‚„è¦åˆ†é–‹ï¼Ÿ','å› ç‚ºå®ƒå€‘çš„è®Šæ›´åŸå› ä¸åŒã€‚API æ ¼å¼è®Šäº†åªæ”¹ CoinDtoï¼Œæ¥­å‹™éœ€æ±‚è®Šäº†åªæ”¹ Coinï¼Œé€™å°±æ˜¯å–®ä¸€è·è²¬åŸå‰‡çš„åƒ¹å€¼ã€‚');

  return html;
}

function getQuiz1HTML(done){
  const descs=['Coin.kt å’Œ CoinDto.kt åˆ†é–‹ï¼Œå„æœ‰å–®ä¸€è·è²¬','Result sealed interface å¯æ“´å±•è€Œä¸æ”¹ç¾æœ‰ç¨‹å¼ç¢¼',
    'RemoteCoinDataSource å¯æ›¿æ›ä»»ä½• CoinDataSource','Error æ¨™è¨˜ä»‹é¢ä¸å¼·è¿«å¯¦ä½œä¸ç›¸é—œæ–¹æ³•','CoinDataSource ä»‹é¢å®šç¾©åœ¨ Domain å±¤ï¼ˆé«˜å±¤ï¼‰'];
  const correct={S:0,O:1,L:2,I:3,D:4};
  const letters=['S','O','L','I','D'];

  let h='<div class="quiz-box"><h3>âœ… å°æ¸¬é©—ï¼šSOLID é…å°</h3><p style="color:var(--txt2);font-size:.85rem;margin-bottom:16px">å°‡æ¯å€‹ SOLID å­—æ¯é…å°åˆ°æ­£ç¢ºçš„ CryptoTracker æ¦‚å¿µ</p>';
  letters.forEach(l=>{
    const sel=S.part1Matches[l];
    h+='<div class="quiz-row"><span class="quiz-tag" style="font-weight:700;background:var(--lav);color:#fff;cursor:default">'+l+'</span>'+
      '<select class="quiz-select" onchange="setPart1Match(\''+l+'\',this.value)"'+(done?' disabled':'')+'><option value="">â€” é¸æ“‡é…å° â€”</option>';
    descs.forEach((d,i)=>{ h+='<option value="'+i+'"'+(sel==i?' selected':'')+'>'+d+'</option>' });
    h+='</select></div>';
  });
  if(!done) h+='<button class="btn btn-pri" onclick="checkQuiz1()" style="margin-top:16px">ç¢ºèªç­”æ¡ˆ</button>';
  h+='<div id="quiz1-result"></div>';
  if(done) h+='<div class="quiz-result pass">âœ… å·²é€šéï¼æ‰€æœ‰é…å°æ­£ç¢ºã€‚</div>';
  h+='</div>';
  return h;
}
function setPart1Match(l,v){S.part1Matches[l]=v===''?null:parseInt(v);save();}
function checkQuiz1(){
  const correct={S:0,O:1,L:2,I:3,D:4};
  const ok=Object.keys(correct).every(l=>S.part1Matches[l]===correct[l]);
  const el=document.getElementById('quiz1-result');
  if(ok){el.innerHTML='<div class="quiz-result pass">ğŸ‰ å…¨éƒ¨æ­£ç¢ºï¼</div>';completePart(1);}
  else el.innerHTML='<div class="quiz-result fail">âŒ æœ‰äº›é…å°ä¸æ­£ç¢ºï¼Œå†æƒ³æƒ³çœ‹ï¼</div>';
}

// ============================================================
// PART 2: Dependency Rule
// ============================================================
function getPart2(){
  const done=S.completedParts.includes(2),read=S.readParts.includes(2);
  let h='<div class="part-hdr"><span class="tag">Part 2</span><h1>â¡ï¸ Dependency Rule â€” Clean Architecture çš„éˆé­‚</h1>'+
    '<p class="desc">ã€ŒClean Architecture å¯ä»¥åªç”¨ä¸€æ¢è¦å‰‡ä¾†ç¸½çµâ€”â€”The Dependency Ruleã€‚ã€æ‰€æœ‰åŸå§‹ç¢¼ä¾è³´æ–¹å‘å¿…é ˆåªèƒ½æŒ‡å‘å…§éƒ¨ã€‚</p></div>';

  // Dependency diagram
  h+='<div class="glass-card"><h3 style="margin-bottom:16px">ä¾è³´æ–¹å‘åœ–</h3>'+
    '<div class="dep-diagram">'+
    '<div class="dep-layer dep-outer">Presentation å±¤<div style="font-size:.75rem;margin-top:4px">CoinListViewModel</div></div>'+
    '<div class="dep-arrow">â†’</div>'+
    '<div class="dep-layer dep-inner" style="border-width:3px">Domain å±¤ï¼ˆæ ¸å¿ƒï¼‰<div style="font-size:.75rem;margin-top:4px">Coin, CoinDataSource</div></div>'+
    '<div class="dep-arrow">â†</div>'+
    '<div class="dep-layer dep-mid">Data å±¤<div style="font-size:.75rem;margin-top:4px">RemoteCoinDataSource</div></div>'+
    '</div>'+
    '<p style="text-align:center;color:var(--txt2);font-size:.85rem;margin-top:12px">ç®­é ­æ–¹å‘ = import ä¾è³´æ–¹å‘ï¼Œæ°¸é æŒ‡å‘ Domain æ ¸å¿ƒ</p></div>';

  // Evidence
  h+='<div class="glass-card"><h3 style="margin-bottom:12px">è­‰æ“šï¼šè¿½è¹¤æ¯å€‹æª”æ¡ˆçš„ import</h3>';
  h+='<div style="margin-bottom:16px"><strong style="color:#2e7d32">Domain å±¤ï¼ˆé›¶å¤–éƒ¨ä¾è³´ï¼‰</strong>'+
    codeBlock('// Coin.kt â€” å®Œå…¨æ²’æœ‰ importï¼\ndata class Coin(\n    val id: String,\n    val rank: Int,\n    ...  // å…¨éƒ¨å±¬æ€§éƒ½åœ¨ domain å±¤ï¼Œé›¶ä¾è³´\n)\n\n// CoinDataSource.kt â€” åª import Domain è‡ªå·±çš„å‹åˆ¥\nimport com.plcoding.cryptotracker.core.domain.util.NetworkError\nimport com.plcoding.cryptotracker.core.domain.util.Result\nimport java.time.ZonedDateTime')+'</div>';
  h+='<div style="margin-bottom:16px"><strong style="color:#1565c0">Data å±¤ï¼ˆä¾è³´ Domain âœ… ä¸ä¾è³´ Presentation âœ…ï¼‰</strong>'+
    codeBlock('// RemoteCoinDataSource.kt çš„ import\nimport com.plcoding.cryptotracker.core.domain.util.Result      // â†’ Domain âœ…\nimport com.plcoding.cryptotracker.core.domain.util.map         // â†’ Domain âœ…\nimport com.plcoding.cryptotracker.crypto.domain.Coin           // â†’ Domain âœ…\nimport com.plcoding.cryptotracker.crypto.domain.CoinDataSource // â†’ Domain âœ…\nimport com.plcoding.cryptotracker.crypto.data.mappers.toCoin   // â†’ åŒå±¤ Data âœ…\n// æ²’æœ‰ä»»ä½• crypto.presentation.* çš„ import âœ…')+'</div>';
  h+='<div><strong style="color:#c62828">Presentation å±¤ï¼ˆä¾è³´ Domain âœ… ä¸ä¾è³´ Data âœ…ï¼‰</strong>'+
    codeBlock('// CoinListViewModel.kt\nimport com.plcoding.cryptotracker.crypto.domain.CoinDataSource // â†’ Domain ä»‹é¢ âœ…\n// ä¸æ˜¯ import RemoteCoinDataSourceï¼ˆData å±¤ï¼‰')+'</div></div>';

  h+=insightBlock(2,'Dependency Rule çš„å¨åŠ›ï¼šç•¶ä½ éœ€è¦æ›¿æ›è³‡æ–™åº«ï¼ˆå¦‚å¾ Room æ›æˆ DataStoreï¼‰ï¼Œåªè¦æ–°çš„å¯¦ä½œéµå®ˆ CoinDataSource ä»‹é¢ï¼ŒDomain å±¤å’Œ Presentation å±¤å®Œå…¨ä¸ç”¨å‹•ã€‚é€™å°±æ˜¯ã€Œç©©å®šæ€§åŸå‰‡ã€â€”â€”è¶Šå…§å±¤è¶Šç©©å®šï¼Œè¶Šä¸å¸¸æ”¹è®Šã€‚');

  if(!read) h+='<div class="read-done"><button class="btn btn-sec" onclick="markRead(2)">âœ“ æˆ‘è®€å®Œäº†ï¼ˆ+50 XPï¼‰</button></div>';
  else h+='<div class="read-done done">âœ“ å·²å®Œæˆé–±è®€</div>';

  // Quiz: True/False
  const tfQ=[
    {code:'CoinListViewModel import CoinDataSource',ans:true,explain:'Presentation â†’ Domainï¼Œåˆæ³•'},
    {code:'Coin.kt import @Serializable',ans:false,explain:'Domain ä¸è©²ä¾è³´åºåˆ—åŒ–æ¡†æ¶'},
    {code:'CoinMapper import CoinDto å’Œ Coin',ans:true,explain:'Data å±¤å¯ä»¥ä¾è³´ Domain å±¤'},
    {code:'CoinDataSource import RemoteCoinDataSource',ans:false,explain:'Domain ä¸å¯ä¾è³´ Data å±¤'}
  ];
  h+='<div class="quiz-box"><h3>âœ… å°æ¸¬é©—ï¼šåˆ¤æ–· import æ˜¯å¦åˆæ³•</h3>';
  tfQ.forEach((q,i)=>{
    const a=S.part2Answers[i];
    h+='<div class="tf-row"><code class="tf-code">'+q.code+'</code><div class="tf-btns">'+
      '<button class="tf-btn'+(a===true?' sel-t':'')+'" onclick="setPart2('+i+',true)"'+(done?' disabled':'')+'>âœ… åˆæ³•</button>'+
      '<button class="tf-btn'+(a===false?' sel-f':'')+'" onclick="setPart2('+i+',false)"'+(done?' disabled':'')+'>âŒ é•å</button></div></div>';
  });
  if(!done) h+='<button class="btn btn-pri" onclick="checkQuiz2()" style="margin-top:16px">ç¢ºèªç­”æ¡ˆ</button>';
  h+='<div id="quiz2-result"></div>';
  if(done) h+='<div class="quiz-result pass">âœ… å·²é€šéï¼ä½ å·²æŒæ¡ Dependency Ruleã€‚</div>';
  h+='</div>';

  h+=briefCard(2,'Dependency Rule',[
    'æ‰€æœ‰ç¨‹å¼ç¢¼ä¾è³´æ–¹å‘åªèƒ½æŒ‡å‘å…§éƒ¨â€”â€”Presentation â†’ Domain â† Data',
    'Domain å±¤é›¶å¤–éƒ¨ä¾è³´ï¼Œæ ¸å¿ƒæ¥­å‹™é‚è¼¯å¯ç¨ç«‹æ¸¬è©¦ã€ç¨ç«‹éƒ¨ç½²',
    'ä»‹é¢å®šç¾©åœ¨ Domain å±¤ï¼Œç¢ºä¿é«˜å±¤æ¨¡çµ„ä¸ä¾è³´ä½å±¤å¯¦ä½œ'
  ],'é€™æ¨£åˆ†å±¤ä¸æœƒå¢åŠ é–‹ç™¼æˆæœ¬å—ï¼Ÿ','çŸ­æœŸå¤šå¯«å¹¾å€‹æª”æ¡ˆï¼Œä½†é•·æœŸ Data å±¤æ›¿æ›ï¼ˆå¦‚æ”¹ç”¨ Room å¿«å–ï¼‰å®Œå…¨ä¸å½±éŸ¿ ViewModel å’Œ Domain å±¤ã€‚é€™æ˜¯æ¶æ§‹çš„æŠ•è³‡å ±é…¬ç‡ã€‚');
  return h;
}
function setPart2(i,v){S.part2Answers[i]=v;save();render();}
function checkQuiz2(){
  const ans=[true,false,true,false];
  const ok=ans.every((a,i)=>S.part2Answers[i]===a);
  const el=document.getElementById('quiz2-result');
  if(ok){el.innerHTML='<div class="quiz-result pass">ğŸ‰ å…¨éƒ¨æ­£ç¢ºï¼</div>';completePart(2);}
  else el.innerHTML='<div class="quiz-result fail">âŒ æœ‰äº›åˆ¤æ–·ä¸æ­£ç¢ºã€‚æç¤ºï¼šDomain å±¤ä¸å¯ä¾è³´å¤–å±¤çš„ä»»ä½•æ±è¥¿ã€‚</div>';
}

// ============================================================
// PART 3: åŒå¿ƒåœ“æ˜ å°„
// ============================================================
function getPart3(){
  const done=S.completedParts.includes(3),read=S.readParts.includes(3);
  const view=S.part3View||'uncle';
  let h='<div class="part-hdr"><span class="tag">Part 3</span><h1>ğŸ—ºï¸ åŒå¿ƒåœ“æ˜ å°„ â€” å››å±¤â†’ä¸‰å±¤</h1>'+
    '<p class="desc">Uncle Bob çš„ç¶“å…¸å››å±¤å¦‚ä½•å°æ‡‰åˆ° Android ç¤¾ç¾¤å¸¸ç”¨çš„ä¸‰å±¤æ¶æ§‹ï¼Ÿé—œéµä¸åœ¨å¹¾å±¤ï¼Œè€Œåœ¨ Dependency Ruleã€‚</p></div>';

  h+='<div class="glass-card"><div class="toggle-wrap"><div class="toggle-sw">'+
    '<div class="toggle-opt'+(view==='uncle'?' active':'')+'" onclick="setView(\'uncle\')">Uncle Bob å››å±¤</div>'+
    '<div class="toggle-opt'+(view!=='uncle'?' active':'')+'" onclick="setView(\'android\')">Android ä¸‰å±¤</div></div></div>';

  if(view==='uncle'){
    h+='<div style="display:flex;flex-direction:column;gap:8px;margin:16px 0">'+
      '<div style="padding:16px;background:#e8f5e9;border-radius:var(--rs);border:2px solid #a5d6a7;text-align:center">'+
      '<strong>1. Entitiesï¼ˆå¯¦é«”ï¼‰</strong><br><span style="font-size:.85rem">Coin.kt, CoinPrice.kt</span></div>'+
      '<div style="padding:16px;background:#fff3e0;border-radius:var(--rs);border:2px solid #ffcc80;text-align:center">'+
      '<strong>2. Use Casesï¼ˆæ‡‰ç”¨å±¤ï¼‰</strong><br><span style="font-size:.85rem">GetCoinsUseCaseï¼ˆCryptoTracker åŸç‰ˆçœç•¥ï¼‰</span></div>'+
      '<div style="padding:16px;background:#e3f2fd;border-radius:var(--rs);border:2px solid #90caf9;text-align:center">'+
      '<strong>3. Interface Adaptersï¼ˆè½‰æ¥å±¤ï¼‰</strong><br><span style="font-size:.85rem">CoinMapper, CoinListViewModel, CoinUi</span></div>'+
      '<div style="padding:16px;background:#fce4ec;border-radius:var(--rs);border:2px solid #ef9a9a;text-align:center">'+
      '<strong>4. Frameworks & Driversï¼ˆæœ€å¤–å±¤ï¼‰</strong><br><span style="font-size:.85rem">Ktor HttpClient, Jetpack Compose Screen</span></div></div>';
  } else {
    h+='<div style="display:flex;flex-direction:column;gap:8px;margin:16px 0">'+
      '<div style="padding:16px;background:#e8f5e9;border-radius:var(--rs);border:2px solid #a5d6a7;text-align:center">'+
      '<strong>Domain å±¤ï¼ˆæœ€å…§ï¼‰</strong><br><span style="font-size:.85rem">Coin, CoinPrice, CoinDataSource<br>= Entities + Use Cases</span></div>'+
      '<div style="padding:16px;background:#e3f2fd;border-radius:var(--rs);border:2px solid #90caf9;text-align:center">'+
      '<strong>Data å±¤</strong><br><span style="font-size:.85rem">RemoteCoinDataSource, CoinMapper, CoinDto<br>= å‘å…§çš„ Interface Adapters + Frameworks</span></div>'+
      '<div style="padding:16px;background:#fce4ec;border-radius:var(--rs);border:2px solid #ef9a9a;text-align:center">'+
      '<strong>Presentation å±¤ï¼ˆæœ€å¤–ï¼‰</strong><br><span style="font-size:.85rem">CoinListViewModel, CoinUi, Compose Screen<br>= å‘å¤–çš„ Interface Adapters + Frameworks</span></div></div>';
  }
  h+='</div>';

  // Mapping table
  h+='<div class="glass-card"><h3 style="margin-bottom:12px">å°ç…§è¡¨</h3>'+
    '<table class="cmp-table"><tr><th>Uncle Bob å››å±¤</th><th>Android ä¸‰å±¤</th><th>CryptoTracker</th></tr>'+
    '<tr><td>Entities</td><td>Domain å±¤</td><td>Coin.kt, CoinPrice.kt</td></tr>'+
    '<tr><td>Use Cases</td><td>Domain å±¤ï¼ˆå¸¸çœç•¥ï¼‰</td><td>åŸç‰ˆç„¡ Use Case</td></tr>'+
    '<tr><td>Interface Adapters</td><td>Data + Presentation</td><td>CoinMapper, ViewModel, CoinUi</td></tr>'+
    '<tr><td>Frameworks & Drivers</td><td>è¢«å¸æ”¶é€² Data/Presentation</td><td>Ktor, Compose</td></tr>'+
    '</table></div>';

  h+=insightBlock(3,'core/ ç›®éŒ„æ©«è·¨å¤šå±¤ï¼ˆcore.domainã€core.dataã€core.presentationï¼‰ï¼Œå®ƒä¸æ˜¯ç¨ç«‹çš„ç¬¬å››å±¤ï¼Œè€Œæ˜¯ã€Œæ¯ä¸€å±¤çš„å…±ç”¨éƒ¨åˆ†ã€ã€‚åˆ†å±¤åŸå‰‡ä»ç„¶é©ç”¨æ–¼ core/ å…§éƒ¨çš„å­ packageã€‚');

  if(!read) h+='<div class="read-done"><button class="btn btn-sec" onclick="markRead(3)">âœ“ æˆ‘è®€å®Œäº†ï¼ˆ+50 XPï¼‰</button></div>';
  else h+='<div class="read-done done">âœ“ å·²å®Œæˆé–±è®€</div>';

  // Quiz: MC
  const opts=['Entitiesï¼ˆå¯¦é«”å±¤ï¼‰','Use Casesï¼ˆæ‡‰ç”¨å±¤ï¼‰','Interface Adaptersï¼ˆè½‰æ¥å±¤ï¼‰','Frameworks & Driversï¼ˆæœ€å¤–å±¤ï¼‰'];
  h+='<div class="quiz-box"><h3>âœ… å°æ¸¬é©—ï¼šé¸æ“‡é¡Œ</h3>'+
    '<p style="margin-bottom:16px;font-weight:600">CoinMapper å±¬æ–¼ Uncle Bob çš„å“ªä¸€å±¤ï¼Ÿ</p>';
  opts.forEach((o,i)=>{
    const sel=S.part3Answer===i;
    h+='<div class="quiz-opt'+(sel?' selected':'')+'" onclick="setPart3('+i+')"'+(done?' style="pointer-events:none"':'')+'>'+
      String.fromCharCode(65+i)+'. '+o+'</div>';
  });
  if(!done) h+='<button class="btn btn-pri" onclick="checkQuiz3()" style="margin-top:16px">ç¢ºèªç­”æ¡ˆ</button>';
  h+='<div id="quiz3-result"></div>';
  if(done) h+='<div class="quiz-result pass">âœ… å·²é€šéï¼CoinMapper æ˜¯è½‰æ¥å±¤â€”â€”è² è²¬ DTO â†” Domain ä¹‹é–“çš„ã€Œç¿»è­¯ã€ã€‚</div>';
  h+='</div>';

  h+=briefCard(3,'åŒå¿ƒåœ“æ˜ å°„',[
    'Uncle Bob å››å±¤æ¶æ§‹åœ¨ Android ç°¡åŒ–ç‚ºä¸‰å±¤ï¼Œæ ¸å¿ƒåŸå‰‡ä¸è®Š',
    'Interface Adapters è¢«æ‹†åˆ†â€”â€”è³‡æ–™è½‰æ¥æ­¸ Data å±¤ï¼ŒUI è½‰æ¥æ­¸ Presentation å±¤',
    'å±¤æ•¸ä¸æ˜¯é‡é»ï¼ŒDependency Rule æ‰æ˜¯â€”â€”ç„¡è«–å¹¾å±¤ï¼Œä¾è³´æ–¹å‘æ°¸é æŒ‡å‘å…§éƒ¨'
  ],'æˆ‘å€‘ç”¨ä¸‰å±¤å¤ å—ï¼Ÿé‚„æ˜¯è¦ç”¨å››å±¤ï¼Ÿ','ä¸‰å±¤è¶³å¤ ã€‚ç•¶æ¥­å‹™é‚è¼¯è¤‡é›œåˆ°éœ€è¦ç¨ç«‹çš„ Use Case å±¤æ™‚ï¼Œå†å¾ Domain å±¤åˆ†å‡ºå³å¯ã€‚æ¶æ§‹æ˜¯æ¼¸é€²æ¼”åŒ–çš„ã€‚');
  return h;
}
function setView(v){S.part3View=v;save();render();}
function setPart3(i){S.part3Answer=i;save();render();}
function checkQuiz3(){
  const el=document.getElementById('quiz3-result');
  if(S.part3Answer===2){el.innerHTML='<div class="quiz-result pass">ğŸ‰ æ­£ç¢ºï¼CoinMapper è² è²¬åœ¨ DTO å’Œ Domain ä¹‹é–“åšç¿»è­¯ã€‚</div>';completePart(3);}
  else el.innerHTML='<div class="quiz-result fail">âŒ å†æƒ³æƒ³çœ‹ã€‚CoinMapper çš„åŠŸèƒ½æ˜¯ä»€éº¼ï¼Ÿå®ƒåœ¨å“ªå…©å±¤ä¹‹é–“åšç¿»è­¯ï¼Ÿ</div>';
}

// ============================================================
// PART 4: é€å±¤èµ°è®€ (placeholder - filled next)
// ============================================================
function getPart4(){ return PART4_CONTENT(); }

// ============================================================
// PART 5: YT Dev vs Google NIA (placeholder - filled next)
// ============================================================
function getPart5(){ return PART5_CONTENT(); }

// ============================================================
// PART 6: å‹•æ‰‹ç·´ç¿’ (placeholder - filled next)
// ============================================================
function getPart6(){ return PART6_CONTENT(); }

// ============================================================
// PART 7: è²»æ›¼é©—è­‰ (placeholder - filled next)
// ============================================================
function getPart7(){ return PART7_CONTENT(); }

// ============================================================
// SHARED UI HELPERS
// ============================================================
function insightBlock(id,text){
  const opened=S.expandedInsights.includes(id);
  return '<div class="insight-block"><button class="insight-head" onclick="expandInsight('+id+')">'+
    '<span>â˜… æ·±å…¥äº†è§£ '+(opened?'':'<span class="insight-xp">+25 XP</span>')+'</span><span>'+(opened?'â–²':'â–¼')+'</span></button>'+
    '<div class="insight-body'+(opened?' open':'')+'" id="insight-body-'+id+'"><div class="insight-inner">'+text+'</div></div></div>';
}

function briefCard(part,title,points,q,a){
  return '<div class="brief-card" onclick="markBriefingRead('+part+')"><h3>ğŸ’¼ å‘ä¸»ç®¡ç°¡å ± â€” Part '+part+': '+title+'</h3>'+
    points.map(p=>'<div class="brief-point"><span class="pin">ğŸ“Œ</span><span>'+p+'</span></div>').join('')+
    '<div class="brief-qa"><div class="q">ğŸ’¡ å¦‚æœä¸»ç®¡å•ï¼šã€Œ'+q+'ã€</div><div>ä½ å¯ä»¥å›ç­”ï¼šã€Œ'+a+'ã€</div></div></div>';
}

function toggleAcc(btn){
  btn.classList.toggle('open');
  btn.nextElementSibling.classList.toggle('open');
}

// ============================================================
// RADAR CHART (Octalysis)
// ============================================================
function getRadarHTML(){
  const drives=[
    {name:'ä½¿å‘½æ„Ÿ',val:S.openingDone?1:0},
    {name:'æˆå°±æ„Ÿ',val:Math.min(S.xp/TOTAL_XP,1)},
    {name:'å‰µé€ åŠ›',val:S.completedParts.includes(6)?1:0},
    {name:'æ“æœ‰æ„Ÿ',val:S.badges.length/BADGES.length},
    {name:'ç¤¾äº¤å½±éŸ¿',val:S.briefingsRead.length/7},
    {name:'ç¨€ç¼ºæ€§',val:S.unlockedParts.length/7},
    {name:'å¥½å¥‡å¿ƒ',val:S.expandedInsights.length/4},
    {name:'é¿æå¿ƒç†',val:S.streak>0?Math.min(S.streak/7,1):0}
  ];
  const cx=150,cy=150,r=110;
  let pts=[],labelHtml='';
  drives.forEach((d,i)=>{
    const angle=-Math.PI/2+i*Math.PI/4;
    const x=cx+r*Math.cos(angle),y=cy+r*Math.sin(angle);
    const vx=cx+r*d.val*Math.cos(angle),vy=cy+r*d.val*Math.sin(angle);
    pts.push(vx+','+vy);
    const lx=cx+(r+25)*Math.cos(angle),ly=cy+(r+25)*Math.sin(angle);
    labelHtml+='<text x="'+lx+'" y="'+ly+'" text-anchor="middle" dominant-baseline="middle" font-size="10" fill="#8E8A9E">'+d.name+'</text>';
    labelHtml+='<line x1="'+cx+'" y1="'+cy+'" x2="'+x+'" y2="'+y+'" stroke="#e0dce8" stroke-width="1"/>';
  });
  // Grid
  let gridHtml='';
  [0.25,0.5,0.75,1].forEach(s=>{
    let gp=[];
    for(let i=0;i<8;i++){const a=-Math.PI/2+i*Math.PI/4;gp.push((cx+r*s*Math.cos(a))+','+(cy+r*s*Math.sin(a)))}
    gridHtml+='<polygon points="'+gp.join(' ')+'" fill="none" stroke="#e0dce8" stroke-width="0.5"/>';
  });

  return '<div class="radar-section"><h2>å…«è§’éŠæˆ²åŒ–æ¡†æ¶ï¼ˆOctalysisï¼‰</h2>'+
    '<svg viewBox="0 0 300 300" width="300" height="300" style="max-width:100%">'+gridHtml+labelHtml+
    '<polygon points="'+pts.join(' ')+'" fill="rgba(184,169,232,0.2)" stroke="var(--lav)" stroke-width="2"/></svg>'+
    '<div class="footer-summary">'+
    '<div class="foot-stat"><div class="val">'+S.completedParts.length+'/7</div><div class="label">å®Œæˆç« ç¯€</div></div>'+
    '<div class="foot-stat"><div class="val">'+S.xp+'</div><div class="label">ç¸½ XP</div></div>'+
    '<div class="foot-stat"><div class="val">'+S.badges.length+'</div><div class="label">å¾½ç« </div></div>'+
    '<div class="foot-stat"><div class="val">'+Math.round(S.completedParts.length/7*100)+'%</div><div class="label">å®Œæˆç‡</div></div>'+
    '</div></div>';
}

// ============================================================
// PART 4-7 CONTENT (to be filled)
// ============================================================
function PART4_CONTENT(){
  const done=S.completedParts.includes(4),read=S.readParts.includes(4);
  let h='<div class="part-hdr"><span class="tag">Part 4</span><h1>ğŸ“– é€å±¤å¯¦æˆ°èµ°è®€</h1><p class="desc">è¿½è¹¤ä¸€æ¬¡ã€Œå–å¾—å¹£ç¨®æ¸…å–®ã€å¾ä½¿ç”¨è€…æ“ä½œåˆ° API å›å‚³çš„å®Œæ•´ 10 æ­¥è³‡æ–™æµã€‚</p></div>';
  const steps=[
    {n:1,file:'Coin.kt',title:'Entity â€” ç´”ç²¹æ¥­å‹™æ¨¡å‹',desc:'data classï¼Œé›¶ importã€é›¶æ¡†æ¶ä¾è³´ã€‚ç”¨ Double å„²å­˜é‡‘é¡ï¼Œæ ¼å¼åŒ–æ˜¯ UI çš„äº‹ã€‚'},
    {n:2,file:'CoinDataSource.kt',title:'Repository ä»‹é¢',desc:'å®šç¾©åœ¨ Domain å±¤ã€‚å›å‚³ Domain çš„ Coinï¼Œä¸æ˜¯ CoinDtoã€‚ç”¨è‡ªå®šç¾© Result<D, E> è€Œéæ‹‹ Exceptionã€‚'},
    {n:3,file:'Result.kt',title:'å‹åˆ¥å®‰å…¨éŒ¯èª¤è™•ç†',desc:'sealed interface ä¿è­‰ when ä¸éœ€è¦ elseã€‚é›™æ³›å‹ <D, E> è®“æˆåŠŸå’ŒéŒ¯èª¤éƒ½æœ‰å‹åˆ¥ã€‚'},
    {n:4,file:'CoinDto.kt',title:'DTO æ•¸æ“šå‚³è¼¸ç‰©ä»¶',desc:'@Serializable æ¨™è¨˜æ˜¯ Data å±¤çš„æŠ€è¡“ç´°ç¯€ã€‚DTO ä½åœ¨ data/networking/dto/ã€‚'},
    {n:5,file:'CoinMapper.kt',title:'Mapper è½‰æ›å±¤',desc:'æ“´å±•å‡½å¼ CoinDto.toCoin()â€”â€”Kotlin æ…£ç”¨å¯«æ³•ã€‚æ–¹å‘æ°¸é æ˜¯ Data â†’ Domainã€‚'},
    {n:6,file:'RemoteCoinDataSource.kt',title:'å¯¦ä½œ DataSource',desc:'å¯¦ä½œ CoinDataSource ä»‹é¢ã€‚safeCall åŒ…è£ + map è½‰æ› DTO â†’ Domain Modelã€‚'},
    {n:7,file:'CoinUi.kt',title:'UI Model',desc:'Double è®Š DisplayableNumberï¼ˆå«æ ¼å¼åŒ–å­—ä¸²ï¼‰ã€‚å¤šäº† @DrawableRes iconResã€‚'},
    {n:8,file:'CoinListState.kt',title:'UI State',desc:'@Immutable Compose å„ªåŒ–æ¨™è¨˜ã€‚ä½¿ç”¨ CoinUi ä¸æ˜¯ Coinâ€”â€”æ¯å±¤ç”¨è‡ªå·±çš„èªè¨€ã€‚'},
    {n:9,file:'CoinListViewModel.kt',title:'ViewModel',desc:'å»ºæ§‹åƒæ•¸æ˜¯ä»‹é¢ CoinDataSourceã€‚åœ¨ onSuccess è£¡å‘¼å« toCoinUi() è½‰æ›ã€‚'},
    {n:10,file:'AppModule.kt',title:'DI ä¸²æ¥',desc:'singleOf(::RemoteCoinDataSource).bind<CoinDataSource>() æ˜¯æ•´å€‹æ¶æ§‹çš„é»åˆåŠ‘ã€‚'}
  ];
  steps.forEach(s=>{
    h+='<div class="step-card"><span class="step-num">'+s.n+'</span><strong>'+s.title+'</strong>'+
      '<div class="step-file">'+s.file+'</div><p style="font-size:.9rem;color:var(--txt2)">'+s.desc+'</p></div>';
  });

  h+=insightBlock(4,'è³‡æ–™è½‰æ›ä¸‰æ¬¡ï¼ˆDTO â†’ Domain â†’ UI Modelï¼‰çœ‹ä¼¼æµªè²»ï¼Œä½†å¦‚æœ API æ ¼å¼è®Šäº†ï¼Œä½ åªéœ€è¦æ”¹ CoinDto å’Œ CoinMapperï¼ŒViewModel å’Œ Screen å®Œå…¨ä¸å—å½±éŸ¿ã€‚é€™å°±æ˜¯ Clean Architecture çš„æŠ•è³‡å ±é…¬ç‡ã€‚');

  if(!read) h+='<div class="read-done"><button class="btn btn-sec" onclick="markRead(4)">âœ“ æˆ‘è®€å®Œäº†ï¼ˆ+50 XPï¼‰</button></div>';
  else h+='<div class="read-done done">âœ“ å·²å®Œæˆé–±è®€</div>';

  // Sort quiz
  const correctOrder=[0,1,2,3,4,5,6,7];
  const labels=['ä½¿ç”¨è€…é»æ“Š Screen','ViewModel å‘¼å« CoinDataSource ä»‹é¢','DI æ³¨å…¥ RemoteCoinDataSource','Ktor HttpClient å‘¼å« API',
    'CoinMapper å°‡ CoinDto è½‰ç‚º Coin','ViewModel æ”¶åˆ° Result<List<Coin>>','toCoinUi() è½‰ç‚º CoinUi','Screen æ ¹æ“š State æ¸²æŸ“æ›´æ–°'];
  if(!S.part4Order||S.part4Order.length!==8) {S.part4Order=[3,6,1,4,7,0,2,5];save();}

  h+='<div class="quiz-box"><h3>âœ… å°æ¸¬é©—ï¼šæ’åˆ—è³‡æ–™æµé †åº</h3><p style="color:var(--txt2);font-size:.85rem;margin-bottom:16px">ç”¨ â–² â–¼ æŒ‰éˆ•å°‡æ­¥é©Ÿæ’æˆæ­£ç¢ºé †åº</p>';
  S.part4Order.forEach((idx,pos)=>{
    h+='<div class="sort-item"><span class="num">'+(pos+1)+'</span><span class="text">'+labels[idx]+'</span>'+
      (!done?'<button class="sort-btn" onclick="movePart4('+pos+',-1)">â–²</button><button class="sort-btn" onclick="movePart4('+pos+',1)">â–¼</button>':'')+
      '</div>';
  });
  if(!done) h+='<button class="btn btn-pri" onclick="checkQuiz4()" style="margin-top:16px">ç¢ºèªé †åº</button>';
  h+='<div id="quiz4-result"></div>';
  if(done) h+='<div class="quiz-result pass">âœ… å·²é€šéï¼ä½ æŒæ¡äº†å®Œæ•´çš„è³‡æ–™æµã€‚</div>';
  h+='</div>';

  h+=briefCard(4,'é€å±¤èµ°è®€',[
    'ä¸€æ¬¡ API è«‹æ±‚ç¶“é 10 å€‹æª”æ¡ˆï¼Œè³‡æ–™åœ¨æ¯å±¤è¢«ã€Œç¿»è­¯ã€æˆè©²å±¤çš„èªè¨€ï¼ˆDTO â†’ Domain â†’ UI Modelï¼‰',
    'æ¯å±¤ä¹‹é–“çš„ Mapper ç¢ºä¿å„å±¤å¯ç¨ç«‹è®Šæ›´è€Œä¸äº’ç›¸å½±éŸ¿',
    'DIï¼ˆKoinï¼‰æ˜¯æ•´å€‹æ¶æ§‹çš„é»åˆåŠ‘â€”â€”åœ¨ AppModule å°‡ä»‹é¢èˆ‡å¯¦ä½œç¶å®š'
  ],'è³‡æ–™æµç¶“é€™éº¼å¤šå±¤ä¸æœƒå½±éŸ¿æ•ˆèƒ½å—ï¼Ÿ','ç‰©ä»¶è½‰æ›åœ¨è¨˜æ†¶é«”ä¸­å®Œæˆï¼Œå¹¾ä¹é›¶æˆæœ¬ã€‚çœŸæ­£çš„æ•ˆèƒ½ç“¶é ¸åœ¨ç¶²è·¯è«‹æ±‚å’Œè³‡æ–™åº«æŸ¥è©¢ï¼Œä¸åœ¨æ¶æ§‹å±¤ç´šã€‚');
  return h;
}
function movePart4(pos,dir){
  const np=pos+dir;
  if(np<0||np>=S.part4Order.length)return;
  [S.part4Order[pos],S.part4Order[np]]=[S.part4Order[np],S.part4Order[pos]];
  save();render();
}
function checkQuiz4(){
  const ok=S.part4Order.every((v,i)=>v===i);
  const el=document.getElementById('quiz4-result');
  if(ok){el.innerHTML='<div class="quiz-result pass">ğŸ‰ å®Œç¾æ’åºï¼</div>';completePart(4);}
  else el.innerHTML='<div class="quiz-result fail">âŒ é †åºä¸å°ã€‚æç¤ºï¼šå¾ä½¿ç”¨è€…æ“ä½œé–‹å§‹ï¼Œåˆ° Screen æ¸²æŸ“çµæŸã€‚</div>';
}

function PART5_CONTENT(){
  const done=S.completedParts.includes(5),read=S.readParts.includes(5);
  let h='<div class="part-hdr"><span class="tag">Part 5</span><h1>âš–ï¸ YT Dev vs Google NIA</h1><p class="desc">å…©å¤§ Clean Architecture æµæ´¾çš„ 6 å¤§å·®ç•°æ·±åº¦æ¯”è¼ƒâ€”â€”æ²’æœ‰ã€Œæ­£ç¢ºç­”æ¡ˆã€ï¼Œåªæœ‰ã€Œé©åˆçš„é¸æ“‡ã€ã€‚</p></div>';

  const cmps=[
    {cat:'æ¨¡çµ„ç­–ç•¥',yt:'å–®æ¨¡çµ„ï¼Œç”¨ package åˆ†å±¤ã€‚åˆ†å±¤é é–‹ç™¼è€…è‡ªå¾‹ã€‚',nia:'å¤šæ¨¡çµ„ï¼Œæ¯å±¤/æ¯ feature ä¸€å€‹ Gradle moduleã€‚Gradle ç·¨è­¯æœŸå¼·åˆ¶ä¾è³´æ–¹å‘ã€‚'},
    {cat:'Repository ä½ç½®',yt:'ä»‹é¢å®šç¾©åœ¨ Domain å±¤ï¼ˆéµå¾ª DIPï¼‰',nia:'ä»‹é¢å®šç¾©åœ¨ Data å±¤ï¼ˆèªç‚º Repository æ˜¯ Data çš„æŠ½è±¡ï¼‰'},
    {cat:'Use Case å±¤',yt:'çœç•¥ã€‚ViewModel ç›´æ¥å‘¼å« DataSourceã€‚',nia:'å¤§é‡ä½¿ç”¨ã€‚ViewModel â†’ UseCase â†’ Repositoryã€‚'},
    {cat:'éŒ¯èª¤è™•ç†',yt:'è‡ªå®šç¾© Result&lt;D, E&gt; sealed interfaceâ€”â€”å‹åˆ¥å®‰å…¨',nia:'Kotlin å…§å»º Exception + try/catchâ€”â€”ç°¡æ½”'},
    {cat:'UI æ¨¡å‹',yt:'å°ˆç”¨ CoinUi UI Modelï¼Œèˆ‡ Domain å®Œå…¨åˆ†é›¢',nia:'é€šå¸¸ç›´æ¥ç”¨ Domain Model'},
    {cat:'DI æ¡†æ¶',yt:'Koinï¼ˆç´” Kotlin DSLï¼Œruntime è§£æï¼‰',nia:'Hiltï¼ˆåŸºæ–¼ Daggerï¼Œcompile-time é©—è­‰ï¼‰'}
  ];

  h+='<div class="glass-card"><table class="cmp-table"><tr><th>é¢å‘</th><th style="color:var(--lav)">YT Devï¼ˆCryptoTrackerï¼‰</th><th style="color:var(--pink)">Google NIA</th></tr>';
  cmps.forEach(c=>{h+='<tr><td><strong>'+c.cat+'</strong></td><td>'+c.yt+'</td><td>'+c.nia+'</td></tr>'});
  h+='<tr style="background:#f5f3fa"><td><strong>é©åˆ</strong></td><td>å¿«é€Ÿé–‹ç™¼ã€å°åœ˜éšŠã€å­¸ç¿’</td><td>å¤§å‹å°ˆæ¡ˆã€å¤šåœ˜éšŠã€é•·æœŸç¶­è­·</td></tr></table></div>';

  h+=insightBlock(5,'Google NIA å°ˆæ¡ˆæœ‰è¶…é 60 å€‹ Gradle moduleã€‚æ¯å€‹ module çš„ build.gradle éƒ½æœ‰æ˜ç¢ºçš„ä¾è³´å®£å‘Šï¼Œç·¨è­¯å™¨åœ¨ build time å°±æœƒå‘Šè¨´ä½ æ˜¯å¦é•åäº† Dependency Ruleâ€”â€”æ¯”é  code review å¯é å¾—å¤šã€‚');

  if(!read) h+='<div class="read-done"><button class="btn btn-sec" onclick="markRead(5)">âœ“ æˆ‘è®€å®Œäº†ï¼ˆ+50 XPï¼‰</button></div>';
  else h+='<div class="read-done done">âœ“ å·²å®Œæˆé–±è®€</div>';

  // Scenario quiz
  const opts=['YT Dev å–®æ¨¡çµ„é¢¨æ ¼ â€” ç°¡å–®ä½†å®¹æ˜“å¤±æ§','Google NIA å¤šæ¨¡çµ„é¢¨æ ¼ â€” ç·¨è­¯æœŸå¼·åˆ¶ä¾è³´æ–¹å‘','ä¸éœ€è¦ Clean Architectureï¼Œç›´æ¥å¯«å°±å¥½'];
  h+='<div class="quiz-box"><h3>âœ… å°æ¸¬é©—ï¼šæƒ…å¢ƒé¡Œ</h3>'+
    '<p style="margin-bottom:16px;font-weight:600">ä½ çš„åœ˜éšŠæœ‰ 15 äººï¼Œéœ€è¦ç¶­è­· 50+ featureï¼Œé©åˆå“ªç¨®é¢¨æ ¼ï¼Ÿ</p>';
  opts.forEach((o,i)=>{
    const sel=S.part5Answer===i;
    h+='<div class="quiz-opt'+(sel?' selected':'')+'" onclick="setPart5('+i+')"'+(done?' style="pointer-events:none"':'')+'>'+String.fromCharCode(65+i)+'. '+o+'</div>';
  });
  if(!done) h+='<button class="btn btn-pri" onclick="checkQuiz5()" style="margin-top:16px">ç¢ºèªç­”æ¡ˆ</button>';
  h+='<div id="quiz5-result"></div>';
  if(done) h+='<div class="quiz-result pass">âœ… å·²é€šéï¼å¤§åœ˜éšŠéœ€è¦ç·¨è­¯æœŸçš„å¼·åˆ¶ä¿éšœã€‚</div>';
  h+='</div>';

  h+=briefCard(5,'å…©å¤§æµæ´¾æ¯”è¼ƒ',[
    'YT Dev é¢¨æ ¼é©åˆå°åœ˜éšŠå¿«é€Ÿé–‹ç™¼ï¼ŒGoogle NIA é©åˆå¤§åœ˜éšŠé•·æœŸç¶­è­·',
    'æ¨¡çµ„åŒ–çš„çœŸæ­£åƒ¹å€¼ï¼šGradle ä¾è³´è¨­å®šèƒ½ã€Œç·¨è­¯æœŸå¼·åˆ¶ã€Dependency Rule',
    'æ²’æœ‰ã€Œæ­£ç¢ºçš„ Clean Architectureã€ï¼Œåªæœ‰ã€Œé©åˆä½ åœ˜éšŠçš„ã€'
  ],'æˆ‘å€‘ç¾åœ¨è©²é¸å“ªç¨®ï¼Ÿ','å»ºè­°å…ˆç”¨ YT Dev é¢¨æ ¼å¿«é€Ÿé©—è­‰ï¼Œç­‰åœ˜éšŠè¶…é 5 äººæˆ–æ¥­å‹™é‚è¼¯è¤‡é›œæ™‚ï¼Œå†æ¼¸é€²å¼•å…¥ Use Case å’Œå¤šæ¨¡çµ„ã€‚');
  return h;
}
function setPart5(i){S.part5Answer=i;save();render();}
function checkQuiz5(){
  const el=document.getElementById('quiz5-result');
  if(S.part5Answer===1){el.innerHTML='<div class="quiz-result pass">ğŸ‰ æ­£ç¢ºï¼15 äººåœ˜éšŠéœ€è¦æ¨¡çµ„åŒ–ä¾†å¼·åˆ¶æ¶æ§‹è¦ç¯„ã€‚</div>';completePart(5);}
  else el.innerHTML='<div class="quiz-result fail">âŒ å†æƒ³æƒ³â€”â€”15 äººåœ˜éšŠå¦‚æœåªé è‡ªå¾‹ï¼ŒDependency Rule å¾ˆå®¹æ˜“è¢«æ‰“ç ´ã€‚</div>';
}

function PART6_CONTENT(){
  const done=S.completedParts.includes(6);
  let h='<div class="part-hdr"><span class="tag">Part 6</span><h1>ğŸ› ï¸ å‹•æ‰‹ç·´ç¿’ â€” åŠ å…¥ Use Case å±¤</h1><p class="desc">åœ¨ CryptoTracker ä¸­å¯¦ä½œ GetCoinsUseCaseï¼Œé«”é©— Google NIA é¢¨æ ¼ã€‚å®Œæˆå¾Œç²å¾— 200 XPï¼</p></div>';

  h+='<div class="glass-card"><h3 style="margin-bottom:12px">ğŸ“‹ ä»»å‹™èªªæ˜</h3>'+
    '<p style="margin-bottom:12px">å¯¦ä½œ <code>GetCoinsUseCase</code>ï¼šå¾ CoinDataSource å–å¾—å¹£ç¨®åˆ—è¡¨ï¼Œä¸¦ç¯©é¸å‡º rank â‰¤ 50 çš„å¹£ç¨®ã€‚</p>'+
    '<p style="margin-bottom:16px;color:var(--txt2);font-size:.85rem">éœ€è¦åŒ…å«ï¼š<code>operator fun invoke()</code>ã€<code>suspend</code>ã€<code>filter</code>ã€çµæœè½‰æ›</p>';

  h+='<h4 style="margin-bottom:8px">éª¨æ¶ç¨‹å¼ç¢¼ï¼š</h4>';
  h+=codeBlock('class GetCoinsUseCase(\n    private val coinDataSource: CoinDataSource\n) {\n    // ä½ çš„ç¨‹å¼ç¢¼å¯«åœ¨ä¸‹æ–¹ç·¨è¼¯å™¨\n}');

  h+='<h4 style="margin:16px 0 8px">æç¤ºï¼š</h4>';
  h+='<div class="accordion"><button class="acc-head" onclick="toggleAcc(this)"><span>ğŸ’¡ Result.map ç”¨æ³•</span><span class="arrow">â–¼</span></button>'+
    '<div class="acc-body"><div class="acc-inner">'+codeBlock('// Result.map æ“´å±•å‡½å¼è®“ä½ åœ¨ä¸æ‹†é–‹ Result çš„æƒ…æ³ä¸‹è½‰æ›è³‡æ–™\ninline fun <T, E: Error, R> Result<T, E>.map(map: (T) -> R): Result<R, E> {\n    return when(this) {\n        is Result.Error -> Result.Error(error)\n        is Result.Success -> Result.Success(map(data))\n    }\n}')+'</div></div></div>';

  h+='<h4 style="margin:16px 0 8px">åœ¨æ­¤æ’°å¯«ä½ çš„ invoke å‡½å¼ï¼š</h4>'+
    '<textarea class="code-editor" id="part6-editor" placeholder="suspend operator fun invoke(): Result<List<Coin>, NetworkError> {\n    // åœ¨é€™è£¡å¯«ä½ çš„å¯¦ä½œ\n}"'+(done?' disabled':'')+'>'+escapeHtmlAttr(S.part6Code)+'</textarea>';

  if(!done){
    h+='<div style="display:flex;gap:8px;margin-top:12px">'+
      '<button class="btn btn-pri" onclick="checkQuiz6()">æäº¤é©—è­‰</button>'+
      '<button class="btn btn-sec" onclick="showPart6Hint()">é¡¯ç¤ºç¯„ä¾‹</button></div>';
  }
  h+='<div id="quiz6-result"></div>';
  if(done) h+='<div class="quiz-result pass" style="margin-top:12px">âœ… å·²é€šéï¼ä½ æˆåŠŸå¯¦ä½œäº† Use Caseã€‚</div>';
  h+='<div id="part6-sample" style="display:none;margin-top:16px"><h4>ç¯„ä¾‹è§£ç­”ï¼š</h4>'+
    codeBlock('suspend operator fun invoke(): Result<List<Coin>, NetworkError> {\n    return coinDataSource\n        .getCoins()\n        .map { coins ->\n            coins.filter { it.rank <= 50 }\n        }\n}')+'</div>';
  h+='</div>';

  h+=insightBlock(6,'operator fun invoke() æ˜¯ Kotlin èªæ³•ç³–ã€‚è®“ GetCoinsUseCase å¯¦ä¾‹å¯ä»¥åƒå‡½å¼ä¸€æ¨£å‘¼å«ï¼šgetCoinsUseCase() ç­‰åŒæ–¼ getCoinsUseCase.invoke()ã€‚é€™ä¸åªæ˜¯èªæ³•ä¾¿åˆ©ï¼Œæ›´ä»£è¡¨ Use Case å°±æ˜¯ä¸€å€‹ã€Œå¯åŸ·è¡Œçš„æ¥­å‹™æ„åœ–ã€ã€‚');

  h+=briefCard(6,'å‹•æ‰‹ç·´ç¿’',[
    'Use Case å°è£æ¥­å‹™é‚è¼¯ï¼ˆç¯©é¸å‰ 50 åï¼‰ï¼Œè®“ ViewModel ä¿æŒè¼•è–„',
    'operator fun invoke() è®“å‘¼å«ç«¯ç”¨ useCase() èªæ³•ï¼Œåƒå‘¼å«å‡½å¼ä¸€æ¨£è‡ªç„¶',
    'Use Case æ˜¯æ¼¸é€²å¼çš„â€”â€”å…ˆå¾ç°¡å–®çš„è½‰ç™¼é–‹å§‹ï¼Œé‚è¼¯å¢é•·æ™‚è‡ªç„¶æ‰¿æ¥'
  ],'åŠ äº† Use Case å€¼å¾—å—ï¼Ÿ','ç•¶ ViewModel æœ‰è¶…é 3 å€‹æ¥­å‹™é‚è¼¯æ“ä½œæ™‚å°±å€¼å¾—ã€‚å®ƒè®“é‚è¼¯å¯è¢«ä¸åŒ ViewModel é‡è¤‡ä½¿ç”¨ï¼Œä¹Ÿæ›´å®¹æ˜“åšå–®å…ƒæ¸¬è©¦ã€‚');
  return h;
}
function escapeHtmlAttr(s){return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function checkQuiz6(){
  const code=document.getElementById('part6-editor').value;
  S.part6Code=code;save();
  const checks=['operator','fun','invoke','suspend','filter'];
  const hasMap=code.includes('.map')||code.includes('.map {');
  const pass=checks.every(k=>code.includes(k))&&hasMap;
  const el=document.getElementById('quiz6-result');
  if(pass){
    el.innerHTML='<div class="quiz-result pass">ğŸ‰ é€šéé©—è­‰ï¼åŒ…å«æ‰€æœ‰é—œéµå…ƒç´ ã€‚</div>';
    document.getElementById('part6-sample').style.display='block';
    completePart(6);
  } else {
    const missing=checks.filter(k=>!code.includes(k));
    if(!hasMap)missing.push('map (Result è½‰æ›)');
    el.innerHTML='<div class="quiz-result fail">âŒ ç¼ºå°‘é—œéµå…ƒç´ ï¼š'+missing.join('ã€')+'</div>';
  }
}
function showPart6Hint(){document.getElementById('part6-sample').style.display='block';}

function PART7_CONTENT(){
  const done=S.completedParts.includes(7);
  const questions=[
    {q:'ç”¨ä¸€å¥è©±è§£é‡‹ Clean Architecture çš„ Dependency Rule',keys:['ä¾è³´','å…§','æŒ‡å‘'],ref:'æ‰€æœ‰åŸå§‹ç¢¼çš„ä¾è³´æ–¹å‘å¿…é ˆåªèƒ½æŒ‡å‘å…§éƒ¨â€”â€”å¤–å±¤å¯ä»¥çŸ¥é“å…§å±¤ï¼Œä½†å…§å±¤çµ•ä¸èƒ½çŸ¥é“å¤–å±¤çš„å­˜åœ¨ã€‚'},
    {q:'ç‚ºä»€éº¼ CoinDataSource ä»‹é¢æ”¾åœ¨ Domain å±¤è€Œä¸æ˜¯ Data å±¤ï¼Ÿ',keys:['é«˜å±¤','ä»‹é¢','Domain','DIP','ä¾è³´åè½‰'],ref:'é€™æ˜¯ä¾è³´åè½‰åŸå‰‡ï¼ˆDIPï¼‰çš„å¯¦è¸â€”â€”é«˜å±¤ï¼ˆDomainï¼‰å®šç¾©å¥‘ç´„ï¼Œä½å±¤ï¼ˆDataï¼‰è² è²¬å¯¦ä½œã€‚å¦‚æœä»‹é¢æ”¾åœ¨ Data å±¤ï¼ŒDomain å°±æœƒåéä¾†ä¾è³´ Dataï¼Œé•å Dependency Ruleã€‚'},
    {q:'ä½•æ™‚æ‡‰è©²åŠ å…¥ Use Case å±¤ï¼Ÿä½•æ™‚å¯ä»¥çœç•¥ï¼Ÿ',keys:['æ¥­å‹™é‚è¼¯','è¤‡é›œ','é‡è¤‡','ViewModel'],ref:'ç•¶æ¥­å‹™é‚è¼¯åªæ˜¯ç°¡å–®çš„ã€Œå–è³‡æ–™â†’é¡¯ç¤ºã€æ™‚å¯ä»¥çœç•¥ã€‚ç•¶é‚è¼¯åŒ…å«ç¯©é¸ã€æ’åºã€åˆä½µå¤šå€‹ä¾†æºã€æˆ–éœ€è¦è¢«å¤šå€‹ ViewModel å…±ç”¨æ™‚ï¼Œå°±è©²åŠ å…¥ Use Case å°è£ã€‚'},
    {q:'å¦‚æœä¸»ç®¡å•ä½ ç‚ºä»€éº¼ä¸ç›´æ¥è®“ ViewModel ç”¨ RemoteCoinDataSourceï¼Œä½ æ€éº¼å›ç­”ï¼Ÿ',keys:['ä»‹é¢','æ›¿æ›','æ¸¬è©¦','è€¦åˆ'],ref:'ç›´æ¥ä¾è³´å…·é«”é¡æœƒé€ æˆå¼·è€¦åˆâ€”â€”æƒ³æ›æˆæœ¬åœ°å¿«å–è¦æ”¹ ViewModelï¼Œæƒ³å¯«æ¸¬è©¦è¦èµ·çœŸçš„ HTTP ä¼ºæœå™¨ã€‚é€éä»‹é¢ï¼Œæˆ‘å€‘å¯ä»¥è¼•é¬†æ›¿æ›å¯¦ä½œï¼Œå–®å…ƒæ¸¬è©¦ç”¨ Fakeã€ä¸Šç·šç”¨ Remoteã€é›¢ç·šç”¨ Localã€‚'}
  ];

  let h='<div class="part-hdr"><span class="tag">Part 7</span><h1>ğŸ“ è²»æ›¼é©—è­‰ â€” ç”¨è‡ªå·±çš„è©±è§£é‡‹</h1><p class="desc">å¦‚æœä½ èƒ½ç”¨ç°¡å–®çš„èªè¨€è§£é‡‹é€™äº›æ¦‚å¿µï¼Œä»£è¡¨ä½ çœŸæ­£ç†è§£äº†ã€‚å®Œæˆå¾Œç²å¾— 150 XP å’Œã€Œæ¶æ§‹å¸«ã€ç¨±è™Ÿï¼</p></div>';

  h+='<div class="glass-card">';
  questions.forEach((q,i)=>{
    h+='<div class="feynman-q"><label>Q'+(i+1)+'ï¼š'+q.q+'</label>'+
      '<textarea class="feynman-ta" id="feynman-'+i+'" placeholder="ç”¨ä½ è‡ªå·±çš„è©±å¯«ä¸‹ç­”æ¡ˆ..."'+(done?' disabled':'')+'>'+escapeHtmlAttr(S.part7Answers[i])+'</textarea>';
    if(done){
      h+='<div class="feynman-ref show"><strong>åƒè€ƒç­”æ¡ˆï¼š</strong>'+q.ref+'</div>';
      h+='<div class="rating">';
      for(let s=1;s<=5;s++) h+='<span class="rating-star'+(s<=S.part7Ratings[i]?' lit':'')+'" onclick="ratePart7('+i+','+s+')">â˜…</span>';
      h+='<span style="font-size:.8rem;color:var(--txt2);margin-left:8px">è‡ªè©•ï¼šç†è§£ç¨‹åº¦</span></div>';
    }
    h+='</div>';
  });

  if(!done) h+='<button class="btn btn-pri" onclick="checkQuiz7()" style="margin-top:12px">æäº¤é©—è­‰</button>';
  h+='<div id="quiz7-result"></div>';
  if(done) h+='<div class="quiz-result pass" style="margin-top:12px">âœ… æ­å–œï¼ä½ å·²å®Œæˆè²»æ›¼é©—è­‰ï¼Œæˆç‚ºçœŸæ­£çš„æ¶æ§‹å¸«ï¼</div>';
  h+='</div>';

  h+=insightBlock(7,'è²»æ›¼å­¸ç¿’æ³•çš„æ ¸å¿ƒæ˜¯ã€Œæ•™æ˜¯æœ€å¥½çš„å­¸ã€ã€‚å¦‚æœä½ èƒ½å‘ä¸€å€‹ä¸æ‡‚ç¨‹å¼çš„äººè§£é‡‹ Clean Architectureï¼Œä½ å°±çœŸæ­£æŒæ¡äº†å®ƒã€‚å‘ä¸»ç®¡ç°¡å ±ä¸æ˜¯è² æ“”ï¼Œè€Œæ˜¯é©—è­‰ç†è§£æ·±åº¦çš„æ©Ÿæœƒã€‚');

  h+=briefCard(7,'è²»æ›¼é©—è­‰',[
    'èƒ½ç”¨ç°¡å–®èªè¨€è§£é‡‹æ¶æ§‹æ±ºç­–ï¼Œä»£è¡¨çœŸæ­£ç†è§£è€ŒéèƒŒèª¦',
    'æ¶æ§‹å¸«çš„åƒ¹å€¼åœ¨æ–¼èƒ½å‘éæŠ€è¡“äººå“¡è§£é‡‹ã€Œç‚ºä»€éº¼é€™æ¨£åšã€',
    'è²»æ›¼å­¸ç¿’æ³•â€”â€”å¦‚æœè§£é‡‹ä¸æ¸…æ¥šï¼Œå°±å›å»é‡æ–°ç†è§£'
  ],'ä½ ç¢ºå®šä½ æ‡‚é€™äº›æ¶æ§‹å—ï¼Ÿ','æˆ‘å¯ä»¥ç”¨ä¸‰å¥è©±è§£é‡‹ï¼šä¾è³´æ–¹å‘æ°¸é æŒ‡å‘å…§éƒ¨ï¼Œæ¯å±¤ç”¨è‡ªå·±çš„èªè¨€èªªè©±ï¼Œä»‹é¢å®šç¾©åœ¨å…§å±¤ã€å¯¦ä½œåœ¨å¤–å±¤ã€‚');
  return h;
}
function ratePart7(i,s){S.part7Ratings[i]=s;save();render();}
function checkQuiz7(){
  const questions=[
    {keys:['ä¾è³´','å…§','æŒ‡å‘']},
    {keys:['é«˜å±¤','ä»‹é¢','Domain','DIP','ä¾è³´åè½‰','å¥‘ç´„']},
    {keys:['æ¥­å‹™é‚è¼¯','è¤‡é›œ','é‡è¤‡','ViewModel','é‚è¼¯']},
    {keys:['ä»‹é¢','æ›¿æ›','æ¸¬è©¦','è€¦åˆ','æŠ½è±¡']}
  ];
  // Save answers
  for(let i=0;i<4;i++){
    const ta=document.getElementById('feynman-'+i);
    if(ta) S.part7Answers[i]=ta.value;
  }
  save();
  // Check keywords
  let allPass=true;
  const missing=[];
  questions.forEach((q,i)=>{
    const ans=S.part7Answers[i]||'';
    if(ans.length<10){allPass=false;missing.push('Q'+(i+1)+': ç­”æ¡ˆå¤ªçŸ­');return;}
    const found=q.keys.some(k=>ans.includes(k));
    if(!found){allPass=false;missing.push('Q'+(i+1)+': ç¼ºå°‘æ ¸å¿ƒæ¦‚å¿µé—œéµå­—');}
  });
  const el=document.getElementById('quiz7-result');
  if(allPass){el.innerHTML='<div class="quiz-result pass">ğŸ‰ å…¨éƒ¨é€šéï¼ä½ å·²å±•ç¾å‡ºå° Clean Architecture çš„æ·±åº¦ç†è§£ã€‚</div>';completePart(7);}
  else el.innerHTML='<div class="quiz-result fail">âŒ '+missing.join('ï¼›')+'<br>æç¤ºï¼šå˜—è©¦ä½¿ç”¨æ ¸å¿ƒæ¦‚å¿µè©å½™ä¾†è¡¨é”ä½ çš„ç†è§£ã€‚</div>';
}

// ============================================================
// INIT
// ============================================================
function init(){
  load();
  updateStreak();
  if(S.openingDone){
    document.getElementById('opening').style.display='none';
  }
  render();
  // Save part6 code on input
  document.addEventListener('input',e=>{
    if(e.target.id==='part6-editor'){S.part6Code=e.target.value;save();}
    if(e.target.classList.contains('feynman-ta')){
      const idx=parseInt(e.target.id.split('-')[1]);
      S.part7Answers[idx]=e.target.value;save();
    }
  });
  // Close sidebar on main click (mobile)
  document.getElementById('main-content').addEventListener('click',()=>{
    document.getElementById('sidebar').classList.remove('open');
  });
}
window.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
