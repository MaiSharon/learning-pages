<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Now in Android æ¶æ§‹è§£å¯† â€” äº’å‹•å­¸ç¿’</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
<style>
:root{
  --bg:#FAFAF8;--bg-card:#FFFFFF;
  --lav:#B8A9E8;--pink:#F2B8C6;--blue:#A8C8E8;--mint:#B8E8D0;
  --txt:#2D2B3A;--txt2:#8E8A9E;--txt3:#C4C0D0;
  --glass:rgba(255,255,255,0.6);--glass-b:rgba(255,255,255,0.3);
  --sh:0 4px 24px rgba(0,0,0,0.04);--sh2:0 8px 32px rgba(0,0,0,0.08);
  --r:20px;--rs:12px;--rxs:8px;
  --ease:all .3s cubic-bezier(.4,0,.2,1);
  --side:280px;--top:64px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans TC','Pretendard',sans-serif;background:var(--bg);color:var(--txt);line-height:1.7;overflow-x:hidden}
h1,h2,h3,h4{font-family:'Pretendard','Noto Sans TC',sans-serif;font-weight:700;line-height:1.3}
code,pre{font-family:'JetBrains Mono',monospace}
a{color:var(--lav);text-decoration:none}
button{cursor:pointer;font-family:inherit;border:none;background:none}

/* Opening */
.opening{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#f5f0ff 0%,#fff5f8 50%,#f0f7ff 100%);transition:opacity .8s ease}
.opening.hide{opacity:0;pointer-events:none}
.opening-box{text-align:center;max-width:520px;padding:60px 40px;animation:fadeUp .8s ease}
.opening-box h1{font-size:2.4rem;background:linear-gradient(135deg,var(--lav),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:12px}
.opening-box .sub{font-size:1.1rem;color:var(--txt2);margin-bottom:32px;line-height:1.8}
.btn-start{display:inline-block;padding:14px 48px;border-radius:50px;font-size:1rem;font-weight:600;color:#fff;
  background:linear-gradient(135deg,var(--lav),var(--pink));box-shadow:0 4px 20px rgba(184,169,232,.4);transition:var(--ease)}
.btn-start:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(184,169,232,.5)}

/* Topbar */
.topbar{position:fixed;top:0;left:0;right:0;height:var(--top);background:var(--glass);backdrop-filter:blur(12px);
  border-bottom:1px solid var(--glass-b);z-index:100;display:flex;align-items:center;padding:0 24px;gap:16px}
.topbar .logo{font-weight:700;font-size:1rem;white-space:nowrap;background:linear-gradient(135deg,var(--lav),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.progress-wrap{flex:1;max-width:300px;height:8px;background:#eee;border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--lav),var(--pink));border-radius:4px;transition:width .5s ease}
.xp-badge{display:flex;align-items:center;gap:6px;font-weight:600;font-size:.9rem;color:var(--lav);white-space:nowrap}
.xp-badge .num{min-width:36px}
.badge-row{display:flex;gap:4px}
.badge-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem;
  background:#f0edf8;transition:var(--ease)}
.badge-icon.earned{background:linear-gradient(135deg,var(--lav),var(--pink));box-shadow:0 2px 8px rgba(184,169,232,.3)}
.hamburger{display:none;font-size:1.4rem;padding:4px}
.streak-tag{font-size:.75rem;padding:3px 10px;border-radius:20px;background:linear-gradient(135deg,var(--mint),var(--blue));color:var(--txt);font-weight:500;white-space:nowrap}

/* Sidebar */
.sidebar{position:fixed;top:var(--top);left:0;bottom:0;width:var(--side);background:var(--glass);backdrop-filter:blur(12px);
  border-right:1px solid var(--glass-b);padding:24px 16px;overflow-y:auto;z-index:90;transition:transform .3s ease}
.sidebar h3{font-size:.75rem;text-transform:uppercase;letter-spacing:2px;color:var(--txt2);margin-bottom:12px}
.side-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:var(--rs);margin-bottom:4px;cursor:pointer;transition:var(--ease);font-size:.9rem}
.side-item:hover{background:rgba(184,169,232,.08)}
.side-item.active{background:rgba(184,169,232,.15);font-weight:600;color:var(--lav)}
.side-item.completed{color:var(--mint)}
.side-item.completed::after{content:'âœ“';margin-left:auto;color:var(--mint);font-weight:700}
.side-item.locked{color:var(--txt3);cursor:not-allowed}
.side-item.locked:hover{background:transparent}
.side-item .lock{margin-left:auto;font-size:.8rem}
.side-sep{height:1px;background:var(--glass-b);margin:16px 0}
.side-stats{font-size:.8rem;color:var(--txt2);line-height:2}
.side-badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.side-badge{font-size:1.2rem;filter:grayscale(1) opacity(.3);transition:var(--ease)}
.side-badge.earned{filter:none}

/* Main */
.main{margin-left:var(--side);margin-top:var(--top);min-height:calc(100vh - var(--top));padding:40px 48px 80px}

/* Cards */
.glass-card{background:var(--bg-card);border:1px solid var(--glass-b);border-radius:var(--r);box-shadow:var(--sh);padding:32px;margin-bottom:24px;transition:var(--ease)}
.glass-card:hover{box-shadow:var(--sh2)}

/* Part header */
.part-hdr{margin-bottom:32px}
.part-hdr .tag{display:inline-block;font-size:.75rem;font-weight:600;padding:4px 14px;border-radius:20px;margin-bottom:12px;
  background:linear-gradient(135deg,var(--lav),var(--pink));color:#fff}
.part-hdr h1{font-size:1.8rem;margin-bottom:8px}
.part-hdr .desc{color:var(--txt2);font-size:1rem}

/* Accordion */
.accordion{border:1px solid #eee;border-radius:var(--rs);overflow:hidden;margin-bottom:12px}
.acc-head{width:100%;text-align:left;padding:16px 20px;font-weight:600;font-size:.95rem;display:flex;justify-content:space-between;align-items:center;
  background:var(--bg-card);transition:var(--ease)}
.acc-head:hover{background:#faf8ff}
.acc-head .arrow{transition:transform .3s ease;font-size:.8rem}
.acc-head.open .arrow{transform:rotate(180deg)}
.acc-body{max-height:0;overflow:hidden;transition:max-height .4s ease;background:#fdfcff}
.acc-body.open{max-height:2000px}
.acc-inner{padding:0 20px 20px}

/* Code â€” CRITICAL: white-space: pre-wrap + overflow-x: auto */
.code-wrap{background:#1e1e2e;border-radius:var(--rs);padding:20px;margin:12px 0;overflow-x:auto;font-size:.85rem;line-height:1.6}
.code-wrap code{color:#cdd6f4;white-space:pre-wrap;word-break:break-all}
.hl-kw{color:#cba6f7}.hl-ty{color:#89b4fa}.hl-st{color:#a6e3a1}.hl-cm{color:#6c7086;font-style:italic}.hl-an{color:#f9e2af}.hl-fn{color:#89dceb}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 24px;border-radius:50px;font-size:.9rem;font-weight:500;transition:var(--ease)}
.btn-pri{background:linear-gradient(135deg,var(--lav),var(--pink));color:#fff;box-shadow:0 4px 16px rgba(184,169,232,.3)}
.btn-pri:hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(184,169,232,.4)}
.btn-pri:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-sec{background:#f5f3fa;color:var(--lav)}
.btn-sec:hover{background:#ece8f6}
.btn-ghost{color:var(--txt2);padding:8px 16px}
.btn-ghost:hover{color:var(--txt);background:#f5f3fa}

/* Quiz section */
.quiz-box{background:linear-gradient(135deg,#faf8ff,#fff8fa);border:2px solid #ede8f8;border-radius:var(--r);padding:32px;margin:32px 0}
.quiz-box h3{font-size:1.1rem;margin-bottom:20px;display:flex;align-items:center;gap:8px}
.quiz-row{display:flex;gap:12px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.quiz-tag{display:inline-block;padding:8px 16px;border-radius:var(--rxs);font-weight:600;font-size:.9rem;min-width:40px;text-align:center;
  background:var(--bg-card);border:2px solid #e0dce8;cursor:pointer;transition:var(--ease);user-select:none}
.quiz-tag.selected{border-color:var(--lav);background:#f5f0ff;color:var(--lav)}
.quiz-tag.correct{border-color:var(--mint);background:#f0faf5;color:#2d8a5e}
.quiz-tag.wrong{border-color:var(--pink);background:#fff5f8;color:#c44}
.quiz-tag.matched{opacity:.6;cursor:default}
.quiz-select{padding:8px 12px;border-radius:var(--rxs);border:2px solid #e0dce8;font-size:.85rem;font-family:inherit;background:var(--bg-card);min-width:200px}
.quiz-opt{display:block;padding:12px 16px;border-radius:var(--rs);border:2px solid #e0dce8;margin-bottom:8px;cursor:pointer;transition:var(--ease)}
.quiz-opt:hover{border-color:var(--lav);background:#faf8ff}
.quiz-opt.selected{border-color:var(--lav);background:#f5f0ff}
.quiz-opt.correct{border-color:var(--mint);background:#f0faf5}
.quiz-opt.wrong{border-color:var(--pink);background:#fff5f8}
.quiz-result{margin-top:16px;padding:16px;border-radius:var(--rs);font-weight:500}
.quiz-result.pass{background:#f0faf5;color:#2d8a5e}
.quiz-result.fail{background:#fff5f8;color:#c44}

/* Sorting quiz */
.sort-item{display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg-card);border:1px solid #eee;border-radius:var(--rxs);margin-bottom:6px}
.sort-item .num{width:24px;height:24px;border-radius:50%;background:var(--lav);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;flex-shrink:0}
.sort-item .text{flex:1;font-size:.85rem}
.sort-btn{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.7rem;background:#f5f3fa;color:var(--txt2);transition:var(--ease)}
.sort-btn:hover{background:var(--lav);color:#fff}

/* TF quiz */
.tf-row{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;background:var(--bg-card);border:1px solid #eee;border-radius:var(--rs);margin-bottom:8px}
.tf-code{flex:1;font-size:.85rem;font-family:'JetBrains Mono',monospace;color:var(--txt)}
.tf-btns{display:flex;gap:6px;flex-shrink:0}
.tf-btn{padding:6px 14px;border-radius:20px;font-size:.8rem;font-weight:600;border:2px solid #eee;transition:var(--ease)}
.tf-btn:hover{border-color:var(--lav)}
.tf-btn.sel-t{border-color:var(--mint);background:#f0faf5;color:#2d8a5e}
.tf-btn.sel-f{border-color:var(--pink);background:#fff5f8;color:#c44}

/* Code editor */
.code-editor{width:100%;min-height:200px;background:#1e1e2e;color:#cdd6f4;border:2px solid #313244;border-radius:var(--rs);
  padding:20px;font-family:'JetBrains Mono',monospace;font-size:.85rem;line-height:1.6;resize:vertical;tab-size:4}
.code-editor:focus{outline:none;border-color:var(--lav)}

/* Briefing card */
.brief-card{background:linear-gradient(135deg,#faf8ff,#f8f5ff);border:1px solid #e8e0f8;border-radius:var(--r);padding:28px 32px;margin:24px 0}
.brief-card h3{font-size:1rem;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.brief-point{padding:8px 0;font-size:.9rem;display:flex;gap:8px}
.brief-point .pin{flex-shrink:0}
.brief-qa{margin-top:16px;padding:16px;background:rgba(184,169,232,.08);border-radius:var(--rs);font-size:.9rem}
.brief-qa .q{font-weight:600;margin-bottom:8px}

/* Insight */
.insight-block{border:1px dashed var(--lav);border-radius:var(--rs);margin:16px 0;overflow:hidden}
.insight-head{width:100%;text-align:left;padding:14px 20px;font-size:.9rem;font-weight:500;color:var(--lav);display:flex;justify-content:space-between;align-items:center;transition:var(--ease)}
.insight-head:hover{background:rgba(184,169,232,.05)}
.insight-body{max-height:0;overflow:hidden;transition:max-height .4s ease}
.insight-body.open{max-height:500px}
.insight-inner{padding:0 20px 16px;font-size:.9rem;color:var(--txt2);line-height:1.8}
.insight-xp{display:inline-block;font-size:.75rem;padding:2px 8px;border-radius:10px;background:var(--mint);color:#fff;font-weight:600}

/* Dependency animation */
.dep-diagram{display:flex;justify-content:center;align-items:center;gap:0;margin:24px 0;flex-wrap:wrap}
.dep-layer{padding:16px 24px;border-radius:var(--rs);font-weight:600;font-size:.85rem;text-align:center;min-width:140px;position:relative}
.dep-arrow{font-size:1.4rem;color:var(--lav);animation:pulse 2s infinite;margin:0 4px}
@keyframes arrowFlow{0%,100%{opacity:.3}50%{opacity:1}}
.dep-outer{background:#fce4ec;color:#c62828;border:2px solid #ef9a9a}
.dep-mid{background:#e3f2fd;color:#1565c0;border:2px solid #90caf9}
.dep-inner{background:#e8f5e9;color:#2e7d32;border:2px solid #a5d6a7}

/* Layer toggle */
.toggle-wrap{display:flex;justify-content:center;margin:20px 0}
.toggle-sw{display:flex;background:#f0edf8;border-radius:50px;padding:4px}
.toggle-opt{padding:8px 24px;border-radius:50px;font-size:.85rem;font-weight:500;cursor:pointer;transition:var(--ease)}
.toggle-opt.active{background:var(--lav);color:#fff}

/* Comparison table */
.cmp-table{width:100%;border-collapse:separate;border-spacing:0;border-radius:var(--rs);overflow:hidden;margin:16px 0;font-size:.85rem}
.cmp-table th{background:#f5f3fa;padding:12px 16px;text-align:left;font-weight:600;border-bottom:2px solid #e8e0f8}
.cmp-table td{padding:10px 16px;border-bottom:1px solid #f0edf8}
.cmp-table tr:hover td{background:#faf8ff}
.cmp-hl{background:rgba(184,169,232,.1)!important}

/* Toast notification */
.toast-wrap{position:fixed;top:80px;right:24px;z-index:200;display:flex;flex-direction:column;gap:8px}
.toast{padding:14px 24px;border-radius:var(--rs);background:var(--bg-card);box-shadow:var(--sh2);display:flex;align-items:center;gap:10px;
  font-size:.9rem;font-weight:500;animation:slideIn .4s ease;min-width:240px}
.toast.xp{border-left:4px solid var(--lav)}
.toast.badge-t{border-left:4px solid var(--mint)}
@keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:none;opacity:1}}
@keyframes fadeUp{from{transform:translateY(30px);opacity:0}to{transform:none;opacity:1}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}

/* Feynman */
.feynman-q{margin-bottom:20px}
.feynman-q label{display:block;font-weight:600;font-size:.95rem;margin-bottom:8px}
.feynman-ta{width:100%;min-height:80px;border:2px solid #e0dce8;border-radius:var(--rs);padding:14px;font-family:inherit;font-size:.9rem;resize:vertical;line-height:1.6}
.feynman-ta:focus{outline:none;border-color:var(--lav)}
.feynman-ref{margin-top:8px;padding:12px;background:#f5f3fa;border-radius:var(--rxs);font-size:.85rem;display:none}
.feynman-ref.show{display:block}
.rating{display:flex;gap:4px;margin-top:8px}
.rating-star{font-size:1.2rem;cursor:pointer;color:#ddd;transition:var(--ease)}
.rating-star.lit{color:#f9c74f}

/* Read button */
.read-done{text-align:center;margin:24px 0;padding:20px;border:2px dashed #e0dce8;border-radius:var(--rs)}
.read-done.done{border-color:var(--mint);background:#f0faf5}

/* Radar chart */
.radar-section{background:var(--bg-card);border-radius:var(--r);box-shadow:var(--sh);padding:40px;margin-top:40px;text-align:center}
.radar-section h2{margin-bottom:24px;font-size:1.2rem}

/* Footer summary */
.footer-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:24px}
.foot-stat{padding:20px;background:#f5f3fa;border-radius:var(--rs);text-align:center}
.foot-stat .val{font-size:2rem;font-weight:700;background:linear-gradient(135deg,var(--lav),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.foot-stat .label{font-size:.8rem;color:var(--txt2);margin-top:4px}

/* Step cards */
.step-card{padding:20px;background:var(--bg-card);border:1px solid #eee;border-radius:var(--rs);margin-bottom:12px;transition:var(--ease)}
.step-card.active{border-color:var(--lav);box-shadow:0 0 0 3px rgba(184,169,232,.15)}
.step-num{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:var(--lav);color:#fff;font-size:.8rem;font-weight:700;margin-right:8px}
.step-file{font-family:'JetBrains Mono',monospace;font-size:.8rem;color:var(--lav);margin:6px 0}
.step-nav{display:flex;gap:8px;justify-content:center;margin:16px 0}

/* Responsive */
@media(max-width:768px){
  .hamburger{display:block}
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:none}
  .main{margin-left:0;padding:24px 16px 60px}
  .topbar{padding:0 12px}
  .quiz-row{flex-direction:column}
  .dep-diagram{flex-direction:column;gap:8px}
  .dep-arrow{transform:rotate(90deg)}
  .opening-box{padding:40px 24px}
  .opening-box h1{font-size:1.8rem}
  .cmp-table{font-size:.75rem}
  .cmp-table th,.cmp-table td{padding:8px 10px}
}
.rating-star.lit{color:#f9c74f}
</style>
</head>
<body>

<!-- ============================================================
     OPENING SCREEN
     ============================================================ -->
<div class="opening" id="opening">
  <div class="opening-box">
    <div style="font-size:3rem;margin-bottom:16px">ğŸ—ï¸</div>
    <h1>NIA æ¶æ§‹è§£å¯†</h1>
    <p class="sub">Google å®˜æ–¹ Android åƒè€ƒæ‡‰ç”¨çš„æ¶æ§‹è¨­è¨ˆæŒ‡å—<br>å¾ç¬¬ä¸€æ€§åŸç†å‡ºç™¼ï¼Œç†è§£æ¯ä¸€å€‹è¨­è¨ˆæ±ºç­–èƒŒå¾Œçš„ã€Œç‚ºä»€éº¼ã€<br>7 å€‹ç« ç¯€ Â· å¤šç¨®äº’å‹•æ¸¬é©— Â· æ¨¡æ“¬å¯¦ä½œ</p>
    <button class="btn-start" onclick="startJourney()">é–‹å§‹æ—…ç¨‹</button>
  </div>
</div>

<!-- ============================================================
     TOPBAR / SIDEBAR / MAIN
     ============================================================ -->
<header class="topbar" id="topbar">
  <button class="hamburger" onclick="toggleSidebar()">â˜°</button>
  <div class="logo">ğŸ— NIA æ¶æ§‹è§£å¯†</div>
  <div class="progress-wrap"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
  <div class="xp-badge">âš¡ <span class="num" id="xp-num">0</span> XP</div>
  <div class="streak-tag" id="streak-tag" style="display:none"></div>
  <div class="badge-row" id="badge-row"></div>
</header>

<nav class="sidebar" id="sidebar"></nav>
<main class="main" id="main-content"></main>
<div class="toast-wrap" id="toast-wrap"></div>

<script>
// ============================================================
// STATE
// ============================================================
const DEFAULT_STATE = {
  currentPart:1, xp:0, completedParts:[], unlockedParts:[1], badges:[],
  expandedInsights:[], readParts:[], streak:0, lastDate:null,
  openingDone:false, briefingsRead:[],
  part1Matches: {},
  part2Order: [6,3,0,5,1,4,2],
  part3Answers: [null,null,null,null,null],
  part4Answers: [null,null,null,null,null],
  part5Answers: ['','',''], part5Ratings: [0,0,0],
  part6Code1: '', part6Code2: '', part6Code3: '', part6Step: 0,
  part7Answers: [null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null], part7Submitted: false
};
let S = JSON.parse(JSON.stringify(DEFAULT_STATE));

function load(){
  try{ const d=localStorage.getItem('nia-arch-learn'); if(d){const p=JSON.parse(d);Object.assign(S,p)} }catch(e){}
}
function save(){ localStorage.setItem('nia-arch-learn',JSON.stringify(S)) }

// ============================================================
// CONSTANTS
// ============================================================
const PARTS = [
  {id:1,title:'NIA å…¨è²Œèˆ‡å­¸ç¿’åœ°åœ–',icon:'ğŸ—ºï¸',xpRead:50,xpQuiz:50},
  {id:2,title:'ä¸‰å±¤æ¶æ§‹',icon:'ğŸ§±',xpRead:75,xpQuiz:75},
  {id:3,title:'æ¨¡çµ„åŒ–è¨­è¨ˆ',icon:'ğŸ“¦',xpRead:75,xpQuiz:75},
  {id:4,title:'æ•¸æ“šæµèˆ‡é›¢ç·šå„ªå…ˆ',icon:'ğŸŒŠ',xpRead:75,xpQuiz:75},
  {id:5,title:'ä¾è³´æ³¨å…¥èˆ‡æ¸¬è©¦ç­–ç•¥',icon:'ğŸ’‰',xpRead:75,xpQuiz:75},
  {id:6,title:'æ¨¡æ“¬åŠŸèƒ½å¯¦ä½œ',icon:'ğŸ”¨',xpRead:50,xpQuiz:150},
  {id:7,title:'ç¶œåˆé©—è­‰',icon:'ğŸ¯',xpRead:0,xpQuiz:200}
];
const BADGES = [
  {id:'explorer',name:'æ¶æ§‹æ¢éšªå®¶',icon:'ğŸ—ºï¸',req:[1]},
  {id:'layered',name:'åˆ†å±¤å¤§å¸«',icon:'ğŸ§±',req:[2]},
  {id:'modular',name:'æ¨¡çµ„é”äºº',icon:'ğŸ“¦',req:[3]},
  {id:'offline',name:'é›¢ç·šå…ˆé‹’',icon:'ğŸŒŠ',req:[4]},
  {id:'testable',name:'æ¸¬è©¦å®ˆé–€äºº',icon:'ğŸ§ª',req:[5]},
  {id:'builder',name:'å¯¦ä½œå·¥ç¨‹å¸«',icon:'ğŸ”¨',req:[6]},
  {id:'architect',name:'é¦–å¸­æ¶æ§‹å¸«',icon:'ğŸ‘‘',req:[1,2,3,4,5,6,7]}
];
const TOTAL_XP = 1750;

// ============================================================
// UTILITIES
// ============================================================
function hl(code){
  let c = code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return c.replace(/(\/\/.*$)|("(?:[^"\\]|\\.)*")|(@\w+)|(\b(?:fun|val|var|class|interface|sealed|suspend|override|private|abstract|object|data|return|if|else|when|is|in|for|while|try|catch|throw|import|package|operator|by|get|set|this|super|null|true|false|internal|open|lateinit)\b)|(\b(?:Flow|StateFlow|MutableStateFlow|MutableSharedFlow|ViewModel|Repository|Context|String|Int|Boolean|List|Map|Set|Unit|Result|Bundle|Activity|Composable|Modifier|LazyColumn|Column|Row|Box|Text|Button|TopicEntity|NewsResource|NewsResourceEntity|Topic|NiaDatabase|TopicDao|Plugin|Project|Synchronizer|CoroutineWorker|WorkerParameters|SavedStateHandle|SingletonComponent|ApplicationContext|Singleton|Module|InstallIn|Provides|Binds|HiltViewModel|Inject|AssistedInject|Assisted|UserNewsResource|BookmarkedNews|BookmarksRepository|BookmarksUiState|BookmarksViewModel|SharingStarted|Notifier|ChangeListVersions|NetworkTopic)\b)/gm,
    (m,cm,st,an,kw,ty)=>{
      if(cm)return'<span class="hl-cm">'+cm+'</span>';if(st)return'<span class="hl-st">'+st+'</span>';
      if(an)return'<span class="hl-an">'+an+'</span>';if(kw)return'<span class="hl-kw">'+kw+'</span>';
      if(ty)return'<span class="hl-ty">'+ty+'</span>';return m;
    });
}
function codeBlock(code){ return '<div class="code-wrap"><code>'+hl(code)+'</code></div>' }
function escapeHtmlAttr(s){return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function updateStreak(){
  const today=new Date().toISOString().split('T')[0];
  if(S.lastDate===today)return;
  const y=new Date(Date.now()-864e5).toISOString().split('T')[0];
  S.streak = S.lastDate===y ? S.streak+1 : 1;
  S.lastDate=today; save();
}
function showToast(text,type='xp'){
  const w=document.getElementById('toast-wrap');
  const t=document.createElement('div');t.className='toast '+type;t.textContent=text;
  w.appendChild(t);setTimeout(()=>t.remove(),3000);
}

// ============================================================
// GAMIFICATION
// ============================================================
function addXP(amount,msg){
  S.xp=Math.min(S.xp+amount,TOTAL_XP);save();
  showToast('+'+ amount+' XP â€” '+msg,'xp');
  renderTopbar();
}
function checkBadges(){
  BADGES.forEach(b=>{
    if(S.badges.includes(b.id))return;
    if(b.req.every(r=>S.completedParts.includes(r))){
      S.badges.push(b.id);save();
      showToast(b.icon+' ç²å¾—å¾½ç« ï¼š'+b.name,'badge-t');
    }
  });
  renderTopbar();renderSidebar();
}
function markRead(partId){
  if(S.readParts.includes(partId))return;
  const p=PARTS.find(x=>x.id===partId);
  S.readParts.push(partId);save();
  if(p.xpRead>0)addXP(p.xpRead,'å®Œæˆ Part '+partId+' é–±è®€');
  render();
}
function completePart(partId){
  if(S.completedParts.includes(partId))return;
  const p=PARTS.find(x=>x.id===partId);
  S.completedParts.push(partId);
  const next=partId+1;
  if(next<=PARTS.length&&!S.unlockedParts.includes(next))S.unlockedParts.push(next);
  save();
  if(p.xpQuiz>0)addXP(p.xpQuiz,'é€šé Part '+partId+' æ¸¬é©—');
  checkBadges();render();
}
function expandInsight(id){
  const body=document.getElementById('insight-body-'+id);
  if(!body)return;
  body.classList.toggle('open');
  if(body.classList.contains('open')&&!S.expandedInsights.includes(id)){
    S.expandedInsights.push(id);save();addXP(25,'å±•é–‹æ·±å…¥äº†è§£');
  }
}
function markBriefingRead(partId){
  if(!S.briefingsRead.includes(partId)){S.briefingsRead.push(partId);save();}
}

// ============================================================
// RENDERING
// ============================================================
function render(){renderTopbar();renderSidebar();renderMain();}

function renderTopbar(){
  const pct=Math.round(S.completedParts.length/PARTS.length*100);
  document.getElementById('progress-fill').style.width=pct+'%';
  document.getElementById('xp-num').textContent=S.xp;
  const br=document.getElementById('badge-row');
  br.innerHTML=BADGES.map(b=>'<div class="badge-icon'+(S.badges.includes(b.id)?' earned':'')+'" title="'+b.name+'">'+b.icon+'</div>').join('');
  const st=document.getElementById('streak-tag');
  if(S.streak>0){st.style.display='';st.textContent='ğŸ”¥ é€£çºŒ '+S.streak+' å¤©';}
}

function renderSidebar(){
  const sb=document.getElementById('sidebar');
  sb.innerHTML='<h3>ç« ç¯€</h3>'+PARTS.map(p=>{
    const locked=!S.unlockedParts.includes(p.id);
    const done=S.completedParts.includes(p.id);
    const active=S.currentPart===p.id;
    let cls='side-item';if(active)cls+=' active';if(done)cls+=' completed';if(locked)cls+=' locked';
    return '<div class="'+cls+'" onclick="'+(locked?'':'navigateTo('+p.id+')')+'">'+
      '<span>'+p.icon+'</span><span>Part '+p.id+'</span><span style="flex:1;font-size:.8rem;color:var(--txt2)">'+p.title+'</span>'+
      (locked?'<span class="lock">ğŸ”’</span>':'')+'</div>';
  }).join('')+'<div class="side-sep"></div><h3>æˆå°±</h3><div class="side-badges">'+
  BADGES.map(b=>'<span class="side-badge'+(S.badges.includes(b.id)?' earned':'')+'" title="'+b.name+'">'+b.icon+'</span>').join('')+
  '</div><div class="side-sep"></div><div class="side-stats">'+
  'ğŸ“Š é€²åº¦ï¼š'+S.completedParts.length+' / '+PARTS.length+'<br>âš¡ XPï¼š'+S.xp+' / '+TOTAL_XP+
  '<br>ğŸ… å¾½ç« ï¼š'+S.badges.length+' / '+BADGES.length+'</div>';
}

function renderMain(){
  const c=document.getElementById('main-content');
  const fns=[null, getPart1,getPart2,getPart3,getPart4,getPart5,getPart6,getPart7];
  const fn=fns[S.currentPart];
  c.innerHTML=fn?fn():'';
  c.innerHTML+=getRadarHTML();
  window.scrollTo({top:0,behavior:'smooth'});
}

// ============================================================
// NAVIGATION
// ============================================================
function navigateTo(id){
  if(!S.unlockedParts.includes(id))return;
  S.currentPart=id;save();render();
}
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
}
function startJourney(){
  S.openingDone=true;save();
  document.getElementById('opening').classList.add('hide');
  setTimeout(()=>document.getElementById('opening').style.display='none',800);
}

// ============================================================
// SHARED UI HELPERS
// ============================================================
function insightBlock(id,text){
  const opened=S.expandedInsights.includes(id);
  return '<div class="insight-block"><button class="insight-head" onclick="expandInsight('+id+')">'+
    '<span>â˜… æ·±å…¥äº†è§£ '+(opened?'':'<span class="insight-xp">+25 XP</span>')+'</span><span>'+(opened?'â–²':'â–¼')+'</span></button>'+
    '<div class="insight-body'+(opened?' open':'')+'" id="insight-body-'+id+'"><div class="insight-inner">'+text+'</div></div></div>';
}

function briefCard(part,title,points,q,a){
  return '<div class="brief-card" onclick="markBriefingRead('+part+')"><h3>ğŸ’¼ å‘ä¸»ç®¡ç°¡å ± â€” Part '+part+': '+title+'</h3>'+
    points.map(p=>'<div class="brief-point"><span class="pin">ğŸ“Œ</span><span>'+p+'</span></div>').join('')+
    '<div class="brief-qa"><div class="q">ğŸ’¡ å¦‚æœä¸»ç®¡å•ï¼šã€Œ'+q+'ã€</div><div>ä½ å¯ä»¥å›ç­”ï¼šã€Œ'+a+'ã€</div></div></div>';
}

function toggleAcc(btn){
  btn.classList.toggle('open');
  btn.nextElementSibling.classList.toggle('open');
}

// ============================================================
// RADAR CHART (Octalysis)
// ============================================================
function getRadarHTML(){
  const drives=[
    {name:'ä½¿å‘½æ„Ÿ',val:S.openingDone?1:0},
    {name:'æˆå°±æ„Ÿ',val:Math.min(S.xp/TOTAL_XP,1)},
    {name:'å‰µé€ åŠ›',val:S.completedParts.includes(PARTS.length-1)?1:0},
    {name:'æ“æœ‰æ„Ÿ',val:S.badges.length/BADGES.length},
    {name:'ç¤¾äº¤å½±éŸ¿',val:S.briefingsRead.length/PARTS.length},
    {name:'ç¨€ç¼ºæ€§',val:S.unlockedParts.length/PARTS.length},
    {name:'å¥½å¥‡å¿ƒ',val:S.expandedInsights.length/Math.max(PARTS.length-1,1)},
    {name:'é¿æå¿ƒç†',val:S.streak>0?Math.min(S.streak/7,1):0}
  ];
  const cx=150,cy=150,r=110;
  let pts=[],labelHtml='';
  drives.forEach((d,i)=>{
    const angle=-Math.PI/2+i*Math.PI/4;
    const x=cx+r*Math.cos(angle),y=cy+r*Math.sin(angle);
    const vx=cx+r*d.val*Math.cos(angle),vy=cy+r*d.val*Math.sin(angle);
    pts.push(vx+','+vy);
    const lx=cx+(r+25)*Math.cos(angle),ly=cy+(r+25)*Math.sin(angle);
    labelHtml+='<text x="'+lx+'" y="'+ly+'" text-anchor="middle" dominant-baseline="middle" font-size="10" fill="#8E8A9E">'+d.name+'</text>';
    labelHtml+='<line x1="'+cx+'" y1="'+cy+'" x2="'+x+'" y2="'+y+'" stroke="#e0dce8" stroke-width="1"/>';
  });
  let gridHtml='';
  [0.25,0.5,0.75,1].forEach(s=>{
    let gp=[];
    for(let i=0;i<8;i++){const a=-Math.PI/2+i*Math.PI/4;gp.push((cx+r*s*Math.cos(a))+','+(cy+r*s*Math.sin(a)))}
    gridHtml+='<polygon points="'+gp.join(' ')+'" fill="none" stroke="#e0dce8" stroke-width="0.5"/>';
  });

  return '<div class="radar-section"><h2>å…«è§’éŠæˆ²åŒ–æ¡†æ¶ï¼ˆOctalysisï¼‰</h2>'+
    '<svg viewBox="0 0 300 300" width="300" height="300" style="max-width:100%">'+gridHtml+labelHtml+
    '<polygon points="'+pts.join(' ')+'" fill="rgba(184,169,232,0.2)" stroke="var(--lav)" stroke-width="2"/></svg>'+
    '<div class="footer-summary">'+
    '<div class="foot-stat"><div class="val">'+S.completedParts.length+'/'+PARTS.length+'</div><div class="label">å®Œæˆç« ç¯€</div></div>'+
    '<div class="foot-stat"><div class="val">'+S.xp+'</div><div class="label">ç¸½ XP</div></div>'+
    '<div class="foot-stat"><div class="val">'+S.badges.length+'</div><div class="label">å¾½ç« </div></div>'+
    '<div class="foot-stat"><div class="val">'+Math.round(S.completedParts.length/PARTS.length*100)+'%</div><div class="label">å®Œæˆç‡</div></div>'+
    '</div></div>';
}

// ============================================================
// PART CONTENT FUNCTIONS (generated by Agent Team)
// ============================================================
// ============================================================
// Part 1: NIA å…¨è²Œèˆ‡å­¸ç¿’åœ°åœ–
// ============================================================
function getPart1() {
  const done = S.completedParts.includes(1);
  const read = S.readParts.includes(1);
  let h = '<div class="part-hdr"><span class="tag">Part 1</span><h1>\uD83D\uDDFA\uFE0F NIA å…¨è²Œèˆ‡å­¸ç¿’åœ°åœ–</h1><p class="desc">å¾æ··æ²Œåˆ°ç§©åº â€” ç¬¬ä¸€æ€§åŸç†ï¼šç‚ºä»€éº¼éœ€è¦æ¶æ§‹ï¼Ÿ</p></div>';

  // --- åä¾‹ accordion: God Activity ---
  h += '<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">\u274C åä¾‹ï¼šGod Activityï¼ˆæ‰€æœ‰é‚è¼¯æ··åœ¨ä¸€èµ·ï¼‰</div><div class="acc-body"><div class="acc-inner">';
  h += '<p>ç•¶æ‰€æœ‰é‚è¼¯éƒ½æ“ åœ¨ä¸€å€‹ Activity è£¡ï¼ŒUIã€ç¶²è·¯ã€è³‡æ–™åº«å…¨éƒ¨æ··åœ¨ä¸€èµ·ï¼Œçµæœå°±æ˜¯ä¸€å€‹ç„¡æ³•ç¶­è­·çš„å·¨å¤§æª”æ¡ˆï¼š</p>';
  h += codeBlock(
    '// GodActivity.kt â€” \u2620\uFE0F åé¢æ•™æ\n' +
    'class GodActivity : AppCompatActivity() {\n' +
    '    private val db = Room.databaseBuilder(...).build()\n' +
    '    private val api = Retrofit.Builder().baseUrl("https://api.example.com").build()\n' +
    '        .create(ApiService::class.java)\n\n' +
    '    override fun onCreate(savedInstanceState: Bundle?) {\n' +
    '        super.onCreate(savedInstanceState)\n' +
    '        // UI \u904F\u8F2F\u76F4\u63A5\u5BEB\u5728\u9019\u88E1\n' +
    '        val recyclerView = findViewById<RecyclerView>(R.id.list)\n\n' +
    '        // \u7DB2\u8DEF\u547C\u53EB\u4E5F\u5728\u9019\u88E1\n' +
    '        lifecycleScope.launch {\n' +
    '            try {\n' +
    '                val news = api.getNews()\n' +
    '                // \u8CC7\u6599\u5EAB\u64CD\u4F5C\u4E5F\u5728\u9019\u88E1\n' +
    '                db.newsDao().insertAll(news)\n' +
    '                // UI \u66F4\u65B0\u4E5F\u5728\u9019\u88E1\n' +
    '                recyclerView.adapter = NewsAdapter(news)\n' +
    '            } catch (e: Exception) {\n' +
    '                Toast.makeText(this@GodActivity, e.message, Toast.LENGTH_LONG).show()\n' +
    '            }\n' +
    '        }\n' +
    '    }\n' +
    '    // ... \u9084\u6709 500+ \u884C\u985E\u4F3C\u7684\u7A0B\u5F0F\u78BC\n' +
    '}'
  );
  h += '<p><strong>\u554F\u984C\uFF1A</strong>\u7121\u6CD5\u6E2C\u8A66\u3001\u7121\u6CD5\u91CD\u7528\u3001\u4E00\u500B\u6539\u52D5\u5F71\u97FF\u5168\u90E8\u3001\u591A\u4EBA\u5354\u4F5C\u5FC5\u5B9A\u885D\u7A81\u3002</p>';
  h += '</div></div></div>';

  // --- æ­£ä¾‹ accordion: NIA åˆ†å±¤æ¶æ§‹ ---
  h += '<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">\u2705 \u6B63\u4F8B\uFF1ANIA \u5206\u5C64\u67B6\u69CB\uFF08\u5404\u5C64\u8077\u8CAC\u6E05\u6670\uFF09</div><div class="acc-body"><div class="acc-inner">';
  h += '<p>NIA \u5C07\u61C9\u7528\u7A0B\u5F0F\u5206\u6210\u4E09\u5C64\uFF0C\u6BCF\u5C64\u5404\u53F8\u5176\u8077\uFF1A</p>';
  h += '<ul><li><strong>UI Layer</strong>\uFF1ACompose + ViewModel\uFF0C\u8CA0\u8CAC\u986F\u793A\u548C\u4F7F\u7528\u8005\u4E92\u52D5</li>';
  h += '<li><strong>Domain Layer</strong>\uFF1AUseCase\uFF08\u53EF\u9078\uFF09\uFF0C\u5C01\u88DD\u53EF\u91CD\u7528\u7684\u696D\u52D9\u908F\u8F2F</li>';
  h += '<li><strong>Data Layer</strong>\uFF1ARepository + DataSource\uFF0C\u7BA1\u7406\u8CC7\u6599\u5B58\u53D6</li></ul>';
  h += '<p>\u6BCF\u500B\u5C64\u53EA\u77E5\u9053\u4E0B\u4E00\u5C64\u7684\u4ECB\u9762\uFF0C\u4E0D\u77E5\u9053\u5176\u5BE6\u4F5C\u7D30\u7BC0\u3002</p>';
  h += '</div></div></div>';

  // --- NIA æŠ€è¡“æ£§ç°¡ä»‹ ---
  h += '<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">\uD83D\uDEE0\uFE0F NIA \u6280\u8853\u68E7\u7C21\u4ECB</div><div class="acc-body"><div class="acc-inner">';
  h += '<ul>';
  h += '<li><strong>Jetpack Compose</strong>\uFF1A\u5BA3\u544A\u5F0F UI \u6846\u67B6\uFF0C\u53D6\u4EE3\u50B3\u7D71 XML Layout</li>';
  h += '<li><strong>Kotlin Flow</strong>\uFF1A\u97FF\u61C9\u5F0F\u8CC7\u6599\u6D41\uFF0C\u9A45\u52D5 UI \u66F4\u65B0</li>';
  h += '<li><strong>Hilt</strong>\uFF1A\u4F9D\u8CF4\u6CE8\u5165\u6846\u67B6\uFF0C\u7C21\u5316\u7269\u4EF6\u5EFA\u7ACB\u548C\u7BA1\u7406</li>';
  h += '<li><strong>Room</strong>\uFF1A\u672C\u5730\u8CC7\u6599\u5EAB\uFF0C\u4F5C\u70BA Single Source of Truth</li>';
  h += '<li><strong>DataStore</strong>\uFF1A\u5132\u5B58\u4F7F\u7528\u8005\u504F\u597D\u8A2D\u5B9A\uFF08\u53D6\u4EE3 SharedPreferences\uFF09</li>';
  h += '<li><strong>WorkManager</strong>\uFF1A\u80CC\u666F\u4EFB\u52D9\u8655\u7406\uFF0C\u8CA0\u8CAC\u8CC7\u6599\u540C\u6B65</li>';
  h += '</ul>';
  h += '</div></div></div>';

  // --- æ¶æ§‹å…¨æ™¯åœ– ---
  h += '<div class="glass-card"><h3>\uD83C\uDFD7\uFE0F \u67B6\u69CB\u5168\u666F\u5716\uFF1A\u4F9D\u8CF4\u65B9\u5411</h3>';
  h += '<div class="dep-diagram">';
  h += '<div class="dep-outer"><div class="dep-layer">app \u6A21\u7D44</div><div class="dep-arrow">\u2193 \u4F9D\u8CF4</div>';
  h += '<div class="dep-mid"><div class="dep-layer">feature:foryou &nbsp; feature:bookmarks &nbsp; feature:interests</div><div class="dep-arrow">\u2193 \u4F9D\u8CF4</div>';
  h += '<div class="dep-inner"><div class="dep-layer">core:data &nbsp; core:model &nbsp; core:network &nbsp; core:ui &nbsp; core:designsystem</div>';
  h += '</div></div></div></div>';
  h += '<p style="text-align:center;opacity:.7">\u4F9D\u8CF4\u53EA\u80FD\u5411\u4E0B\uFF0C\u7D55\u4E0D\u53CD\u5411</p></div>';

  // --- Insight Blocks ---
  h += insightBlock(1, '\u70BA\u4EC0\u9EBC Google \u8981\u505A NIA\uFF1F\u56E0\u70BA\u904E\u53BB\u7684\u7BC4\u4F8B App\uFF08\u5982 Sunflower\uFF09\u5DF2\u904E\u6642\uFF0C\u7121\u6CD5\u5C55\u793A\u73FE\u4EE3 Android \u958B\u767C\u7684\u5168\u8C8C\u3002NIA \u662F\u5B98\u65B9\u6700\u4F73\u5BE6\u8E10\u7684\u793A\u7BC4\u61C9\u7528\uFF0C\u6DB5\u84CB\u67B6\u69CB\u3001\u6E2C\u8A66\u3001CI/CD\u3001\u7121\u969C\u7919\u7B49\u65B9\u9762\u3002');
  h += insightBlock(2, 'Convention over Configuration \u7406\u5FF5\uFF1ANIA \u900F\u904E Convention Plugin \u8B93\u6BCF\u500B\u6A21\u7D44\u4E0D\u7528\u91CD\u8907\u8A2D\u5B9A Gradle\uFF0C\u53EA\u8981\u5957\u7528\u5805\u5B9A\u597D\u7684\u6163\u4F8B\u5373\u53EF\u3002\u9019\u548C Rails \u7684\u300CCoC\u300D\u54F2\u5B78\u76F8\u540C\u3002');

  // --- é–±è®€å®ŒæˆæŒ‰éˆ• ---
  h += '<div class="read-done' + (read ? ' done' : '') + '"><button class="btn ' + (read ? 'btn-sec' : 'btn-pri') + '" onclick="markRead(1)">' + (read ? '\u2713 \u5DF2\u95B1\u8B80' : '\uD83D\uDCD6 \u6A19\u8A18\u5DF2\u95B1\u8B80') + '</button></div>';

  // --- æ¸¬é©—ï¼šé…å°é¡Œ ---
  h += '<div class="quiz-box' + (done ? ' done' : '') + '"><h3>\uD83E\uDDE9 \u914D\u5C0D\u984C\uFF1A\u554F\u984C \u2194 NIA \u89E3\u6CD5</h3>';
  var q1problems = [
    'Activity \u592A\u80A5\uFF0C\u96E3\u4EE5\u7DAD\u8B77',
    '\u6A21\u7D44\u9593\u4E92\u76F8\u4F9D\u8CF4\u6210\u7FA9\u5927\u5229\u9EAB',
    '\u96E2\u7DDA\u6642 App \u5B8C\u5168\u4E0D\u80FD\u7528',
    '\u6E2C\u8A66\u9700\u8981\u771F\u5BE6 API \u592A\u6162',
    '\u6BCF\u500B\u6A21\u7D44 build.gradle \u91CD\u8907\u8A2D\u5B9A'
  ];
  var q1answers = [
    '\u4E09\u5C64\u67B6\u69CB\uFF08UI/Domain/Data\uFF09',
    '\u56B4\u683C\u7684\u6A21\u7D44\u4F9D\u8CF4\u65B9\u5411',
    'Offline-first + Room \u4F5C SSOT',
    'Fake Repository \u53D6\u4EE3 Mock',
    'Convention Plugins'
  ];
  for (var i = 0; i < 5; i++) {
    h += '<div class="quiz-row"><span class="quiz-tag">' + q1problems[i] + '</span>';
    h += '<select class="quiz-select" onchange="S.part1Matches[' + i + ']=this.value" ' + (done ? 'disabled' : '') + '>';
    h += '<option value="">\u8ACB\u9078\u64C7\u2026</option>';
    for (var j = 0; j < 5; j++) {
      var sel = (S.part1Matches && S.part1Matches[i] === q1answers[j]) ? ' selected' : '';
      h += '<option value="' + escapeHtmlAttr(q1answers[j]) + '"' + sel + '>' + q1answers[j] + '</option>';
    }
    h += '</select></div>';
  }
  h += '<div id="quiz1-result"></div>';
  h += '<button class="btn btn-pri" onclick="checkQuiz1()"' + (done ? ' disabled' : '') + '>\u63D0\u4EA4\u7B54\u6848</button></div>';

  // --- ç°¡å ±å¡ ---
  h += briefCard(1,
    'NIA \u5168\u8C8C\u8207\u5B78\u7FD2\u5730\u5716',
    ['NIA \u662F Google \u5B98\u65B9\u7684 Android \u6700\u4F73\u5BE6\u8E10\u53C3\u8003\u61C9\u7528','\u63A1\u7528\u4E09\u5C64\u67B6\u69CB + \u6A21\u7D44\u5316','\u6280\u8853\u68E7\u6DB5\u84CB Compose/Flow/Hilt/Room'],
    '\u300C\u6211\u5011\u70BA\u4EC0\u9EBC\u8981\u53C3\u8003 NIA \u800C\u4E0D\u662F\u81EA\u5DF1\u8A2D\u8A08\uFF1F\u300D',
    'NIA \u7531 Google Android \u5718\u968A\u7DAD\u8B77\uFF0C\u4EE3\u8868\u4E86 Android \u958B\u767C\u7684\u5B98\u65B9\u63A8\u85A6\u67B6\u69CB\u6A21\u5F0F\uFF0C\u7D93\u904E\u5927\u91CF\u5BE6\u6230\u9A57\u8B49\uFF0C\u53EF\u4EE5\u5927\u5E45\u964D\u4F4E\u6211\u5011\u7684\u67B6\u69CB\u6C7A\u7B56\u98A8\u96AA\u3002'
  );

  return h;
}

function checkQuiz1() {
  var correct = [
    '\u4E09\u5C64\u67B6\u69CB\uFF08UI/Domain/Data\uFF09',
    '\u56B4\u683C\u7684\u6A21\u7D44\u4F9D\u8CF4\u65B9\u5411',
    'Offline-first + Room \u4F5C SSOT',
    'Fake Repository \u53D6\u4EE3 Mock',
    'Convention Plugins'
  ];
  var allRight = true;
  for (var i = 0; i < 5; i++) {
    if (!S.part1Matches || S.part1Matches[i] !== correct[i]) { allRight = false; break; }
  }
  var el = document.getElementById('quiz1-result');
  if (allRight) {
    el.innerHTML = '<p style="color:#4ade80;font-weight:700">\u2705 \u5168\u90E8\u6B63\u78BA\uFF01\u4F60\u5DF2\u638C\u63E1 NIA \u89E3\u6C7A\u7684\u6838\u5FC3\u554F\u984C\u3002</p>';
    completePart(1);
    addXP(50, 'Part 1 \u914D\u5C0D\u984C\u5168\u5C0D');
  } else {
    el.innerHTML = '<p style="color:#f87171">\u274C \u6709\u914D\u5C0D\u932F\u8AA4\uFF0C\u8ACB\u518D\u60F3\u60F3\u6BCF\u500B\u554F\u984C\u5C0D\u61C9\u54EA\u500B NIA \u89E3\u6CD5\u3002</p>';
  }
}

// ============================================================
// Part 2: ä¸‰å±¤æ¶æ§‹
// ============================================================
function getPart2() {
  const done = S.completedParts.includes(2);
  const read = S.readParts.includes(2);
  let h = '<div class="part-hdr"><span class="tag">Part 2</span><h1>\uD83C\uDFD7\uFE0F \u4E09\u5C64\u67B6\u69CB</h1><p class="desc">\u8CC7\u6599\u5982\u4F55\u5F9E DB \u6D41\u5411\u87A2\u5E55 \u2014 \u7B2C\u4E00\u6027\u539F\u7406\uFF1A\u55AE\u5411\u8CC7\u6599\u6D41</p></div>';

  // --- UI Layer accordion ---
  h += '<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">\uD83D\uDDA5\uFE0F UI Layer\uFF1AViewModel + Compose</div><div class="acc-body"><div class="acc-inner">';
  h += '<p>UI Layer \u7684\u6838\u5FC3\u662F <strong>ViewModel</strong> \u6301\u6709 <strong>UiState</strong>\uFF08\u4EE5 sealed interface \u5EFA\u6A21\uFF09\uFF0CCompose \u900F\u904E <code>collectAsState</code> \u89C0\u5BDF StateFlow\uFF0C\u7576\u72C0\u614B\u8B8A\u66F4\u6642\u81EA\u52D5\u91CD\u7D44\u3002</p>';
  h += codeBlock(
    'sealed interface ForYouUiState {\n' +
    '    data object Loading : ForYouUiState\n' +
    '    data class Success(\n' +
    '        val feed: List<UserNewsResource>\n' +
    '    ) : ForYouUiState\n' +
    '}\n\n' +
    '@HiltViewModel\n' +
    'class ForYouViewModel @Inject constructor(\n' +
    '    private val getUserNewsResources: GetUserNewsResourcesUseCase\n' +
    ') : ViewModel() {\n' +
    '    val uiState: StateFlow<ForYouUiState> = \n' +
    '        getUserNewsResources()\n' +
    '            .map(ForYouUiState::Success)\n' +
    '            .stateIn(\n' +
    '                scope = viewModelScope,\n' +
    '                started = SharingStarted.WhileSubscribed(5_000),\n' +
    '                initialValue = ForYouUiState.Loading\n' +
    '            )\n' +
    '}'
  );
  h += '</div></div></div>';

  // --- Domain Layer accordion ---
  h += '<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">\u2699\uFE0F Domain Layer\uFF1AUseCase\uFF08\u53EF\u9078\uFF09</div><div class="acc-body"><div class="acc-inner">';
  h += '<p>Domain Layer \u662F<strong>\u53EF\u9078\u7684</strong>\u3002\u53EA\u6709\u7576\u696D\u52D9\u908F\u8F2F\u88AB\u591A\u500B ViewModel \u5171\u7528\u6642\uFF0C\u624D\u6703\u62BD\u51FA\u70BA UseCase\u3002NIA \u4F7F\u7528 <code>operator fun invoke</code> \u6163\u4F8B\uFF0C\u8B93 UseCase \u53EF\u4EE5\u50CF\u51FD\u5F0F\u4E00\u6A23\u547C\u53EB\u3002</p>';
  h += codeBlock(
    'class GetUserNewsResourcesUseCase @Inject constructor(\n' +
    '    private val newsRepository: NewsRepository,\n' +
    '    private val userDataRepository: UserDataRepository\n' +
    ') {\n' +
    '    operator fun invoke(): Flow<List<UserNewsResource>> =\n' +
    '        newsRepository.getNewsResources()\n' +
    '            .combine(userDataRepository.userData) { news, userData ->\n' +
    '                news.mapToUserNewsResources(userData)\n' +
    '            }\n' +
    '}'
  );
  h += '</div></div></div>';

  // --- Data Layer accordion ---
  h += '<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">\uD83D\uDCBE Data Layer\uFF1ARepository + DataSource</div><div class="acc-body"><div class="acc-inner">';
  h += '<p>Data Layer \u63A1\u7528 <strong>Repository \u4ECB\u9762 + \u5BE6\u4F5C\u5206\u96E2</strong>\u7684\u6A21\u5F0F\u3002\u4ECB\u9762\u5B9A\u7FA9\u5728 core:data\uFF0C\u5BE6\u4F5C\u53EF\u4EE5\u88AB\u66FF\u63DB\uFF08\u4F8B\u5982\u6E2C\u8A66\u6642\u7528 Fake\uFF09\u3002DataSource \u5C01\u88DD\u5177\u9AD4\u7684\u8CC7\u6599\u4F86\u6E90\u3002</p>';
  h += codeBlock(
    'interface NewsRepository {\n' +
    '    fun getNewsResources(): Flow<List<NewsResource>>\n' +
    '    fun getNewsResource(id: String): Flow<NewsResource>\n' +
    '}\n\n' +
    'class OfflineFirstNewsRepository @Inject constructor(\n' +
    '    private val newsResourceDao: NewsResourceDao,\n' +
    '    private val network: NiaNetworkDataSource\n' +
    ') : NewsRepository {\n' +
    '    override fun getNewsResources(): Flow<List<NewsResource>> =\n' +
    '        newsResourceDao.getNewsResources()\n' +
    '            .map { it.map(NewsResourceEntity::asExternalModel) }\n' +
    '}'
  );
  h += '</div></div></div>';

  // --- Insight Blocks ---
  h += insightBlock(3, 'WhileSubscribed(5_000) \u7684 5 \u79D2\u9B54\u6CD5\u6578\u5B57\uFF1A\u7576\u6C92\u6709\u8A02\u95B1\u8005\u6642\uFF0CStateFlow \u6703\u7B49 5 \u79D2\u624D\u505C\u6B62\u4E0A\u904A\u7684 Flow\u3002\u9019\u8B93\u87A2\u5E55\u65CB\u8F49\uFF08\u901A\u5E38 < 5 \u79D2\uFF09\u6642\u4E0D\u6703\u91CD\u65B0\u89F8\u767C\u6578\u64DA\u8ACB\u6C42\uFF0C\u53C8\u4E0D\u6703\u6C38\u9060\u4FDD\u6301\u6D3B\u8E8D\u6D6A\u8CBB\u8CC7\u6E90\u3002');
  h += insightBlock(4, 'sealed interface vs sealed class\uFF1AKotlin 1.5+ \u5F15\u5165 sealed interface\uFF0C\u6BD4 sealed class \u66F4\u5F48\u6027\u2014\u2014\u56E0\u70BA\u4E00\u500B\u985E\u53EF\u4EE5\u5BE6\u4F5C\u591A\u500B sealed interface\uFF0C\u4F46\u53EA\u80FD\u7E7C\u627F\u4E00\u500B sealed class\u3002NIA \u5168\u9762\u63A1\u7528 sealed interface \u4F86\u5EFA\u6A21 UiState\u3002');
  h += insightBlock(5, 'operator fun invoke \u8B93 UseCase \u53EF\u4EE5\u50CF\u51FD\u5F0F\u4E00\u6A23\u547C\u53EB\uFF1AgetUserNewsResources() \u800C\u4E0D\u662F getUserNewsResources.execute()\u3002\u9019\u662F Kotlin \u7684\u904B\u7B97\u5B50\u591A\u8F09\u6163\u4F8B\uFF0C\u8B93\u7A0B\u5F0F\u78BC\u66F4\u7C21\u6F54\u3002');

  // --- é–±è®€å®ŒæˆæŒ‰éˆ• ---
  h += '<div class="read-done' + (read ? ' done' : '') + '"><button class="btn ' + (read ? 'btn-sec' : 'btn-pri') + '" onclick="markRead(2)">' + (read ? '\u2713 \u5DF2\u95B1\u8B80' : '\uD83D\uDCD6 \u6A19\u8A18\u5DF2\u95B1\u8B80') + '</button></div>';

  // --- æ¸¬é©—ï¼šæ’åºé¡Œ ---
  var sortLabels = [
    '\u4F7F\u7528\u8005\u9EDE\u64CA\u300CFollow\u300D\u6309\u9215',
    'Compose onClick \u89F8\u767C ViewModel \u65B9\u6CD5',
    'ViewModel \u547C\u53EB Repository.toggleFollow()',
    'Repository \u66F4\u65B0 Room Database',
    'Room \u7684 Flow \u81EA\u52D5\u767C\u5C04\u65B0\u8CC7\u6599',
    'ViewModel \u7684 StateFlow \u6536\u5230\u66F4\u65B0',
    'Compose \u91CD\u65B0\u7D44\u5408\u986F\u793A\u65B0\u72C0\u614B'
  ];
  h += '<div class="quiz-box' + (done ? ' done' : '') + '"><h3>\uD83D\uDD22 \u6392\u5E8F\u984C\uFF1A\u8CC7\u6599\u6D41\u6B63\u78BA\u9806\u5E8F</h3>';
  h += '<p>\u5C07\u4EE5\u4E0B 7 \u500B\u6B65\u9A5F\u6392\u6210\u6B63\u78BA\u7684\u8CC7\u6599\u6D41\u9806\u5E8F\uFF08\u7528 \u25B2 \u25BC \u79FB\u52D5\uFF09\uFF1A</p>';
  h += '<div id="sort-container">';
  for (var si = 0; si < S.part2Order.length; si++) {
    var idx = S.part2Order[si];
    h += '<div class="sort-item" data-pos="' + si + '">';
    h += '<span class="sort-label">' + sortLabels[idx] + '</span>';
    if (!done) {
      h += '<button class="sort-btn" onclick="moveSortItem(' + si + ',-1)">\u25B2</button>';
      h += '<button class="sort-btn" onclick="moveSortItem(' + si + ',1)">\u25BC</button>';
    }
    h += '</div>';
  }
  h += '</div>';
  h += '<div id="quiz2-result"></div>';
  h += '<button class="btn btn-pri" onclick="checkQuiz2()"' + (done ? ' disabled' : '') + '>\u63D0\u4EA4\u7B54\u6848</button></div>';

  // --- ç°¡å ±å¡ ---
  h += briefCard(2,
    '\u4E09\u5C64\u67B6\u69CB',
    ['UI Layer \u7528 sealed interface \u5EFA\u6A21\u72C0\u614B','Domain Layer \u7684 UseCase \u662F\u53EF\u9078\u7684','Data Layer \u7528 Repository \u4ECB\u9762\u9694\u96E2\u5BE6\u4F5C'],
    '\u300CDomain Layer \u662F\u4E0D\u662F\u591A\u6B64\u4E00\u8209\uFF1F\u300D',
    'Domain Layer \u662F\u53EF\u9078\u7684\u3002\u53EA\u6709\u7576\u591A\u500B ViewModel \u9700\u8981\u5171\u7528\u540C\u4E00\u6BB5\u696D\u52D9\u908F\u8F2F\u6642\u624D\u62BD\u51FA UseCase\uFF0C\u5426\u5247\u76F4\u63A5\u5728 ViewModel \u4E2D\u547C\u53EB Repository \u5373\u53EF\u3002'
  );

  return h;
}

function moveSortItem(pos, dir) {
  var newPos = pos + dir;
  if (newPos < 0 || newPos >= S.part2Order.length) return;
  var tmp = S.part2Order[pos];
  S.part2Order[pos] = S.part2Order[newPos];
  S.part2Order[newPos] = tmp;
  save();render();
}

function checkQuiz2() {
  var correct = [0, 1, 2, 3, 4, 5, 6];
  var allRight = true;
  for (var i = 0; i < 7; i++) {
    if (S.part2Order[i] !== correct[i]) { allRight = false; break; }
  }
  var el = document.getElementById('quiz2-result');
  if (allRight) {
    el.innerHTML = '<p style="color:#4ade80;font-weight:700">\u2705 \u5B8C\u7F8E\uFF01\u4F60\u5DF2\u638C\u63E1\u55AE\u5411\u8CC7\u6599\u6D41\u7684\u6B63\u78BA\u9806\u5E8F\u3002</p>';
    completePart(2);
    addXP(50, 'Part 2 \u6392\u5E8F\u984C\u5168\u5C0D');
  } else {
    el.innerHTML = '<p style="color:#f87171">\u274C \u9806\u5E8F\u4E0D\u6B63\u78BA\uFF0C\u8ACB\u60F3\u60F3\u8CC7\u6599\u5F9E\u4F7F\u7528\u8005\u64CD\u4F5C\u5230\u756B\u9762\u66F4\u65B0\u7684\u5B8C\u6574\u6D41\u7A0B\u3002</p>';
  }
}

// ============================================================
// Part 3: æ¨¡çµ„åŒ–è¨­è¨ˆ
// ============================================================
function getPart3() {
  const done = S.completedParts.includes(3);
  const read = S.readParts.includes(3);
  let h = '<div class="part-hdr"><span class="tag">Part 3</span><h1>\uD83E\uDDE9 \u6A21\u7D44\u5316\u8A2D\u8A08</h1><p class="desc">\u7528\u6A21\u7D44\u908A\u754C\u964D\u4F4E\u8907\u96DC\u5EA6 \u2014 \u7B2C\u4E00\u6027\u539F\u7406\uFF1A\u5206\u800C\u6CBB\u4E4B</p></div>';

  // --- ä¸‰ç¨®æ¨¡çµ„é¡å‹ accordion ---
  h += '<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">\uD83D\uDCE6 \u4E09\u7A2E\u6A21\u7D44\u985E\u578B</div><div class="acc-body"><div class="acc-inner">';
  h += '<ul>';
  h += '<li><strong>app \u6A21\u7D44</strong>\uFF1A\u61C9\u7528\u7A0B\u5F0F\u5165\u53E3\u9EDE\uFF0C\u8CA0\u8CAC\u4E32\u63A5\u6240\u6709 feature \u6A21\u7D44\uFF0C\u8A2D\u5B9A Navigation\u3001Hilt Application \u7B49</li>';
  h += '<li><strong>feature \u6A21\u7D44</strong>\uFF1A\u7368\u7ACB\u529F\u80FD\u55AE\u5143\uFF0C\u5982 <code>feature:foryou</code>\u3001<code>feature:bookmarks</code>\u3001<code>feature:interests</code>\uFF0C\u5305\u542B\u8A72\u529F\u80FD\u7684 UI + ViewModel</li>';
  h += '<li><strong>core \u6A21\u7D44</strong>\uFF1A\u5171\u7528\u57FA\u790E\u8A2D\u65BD\uFF0C\u5982 <code>core:data</code>\u3001<code>core:model</code>\u3001<code>core:network</code>\u3001<code>core:ui</code>\u3001<code>core:designsystem</code></li>';
  h += '</ul>';
  h += '</div></div></div>';

  // --- ä¾è³´æ–¹å‘è¦å‰‡ dep-diagram ---
  h += '<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">\u2B07\uFE0F \u4F9D\u8CF4\u65B9\u5411\u898F\u5247</div><div class="acc-body"><div class="acc-inner">';
  h += '<div class="dep-diagram">';
  h += '<div class="dep-outer"><div class="dep-layer"><strong>app</strong></div><div class="dep-arrow">\u2193 \u53EF\u4EE5\u4F9D\u8CF4</div>';
  h += '<div class="dep-mid"><div class="dep-layer"><strong>feature:*</strong></div><div class="dep-arrow">\u2193 \u53EF\u4EE5\u4F9D\u8CF4</div>';
  h += '<div class="dep-inner"><div class="dep-layer"><strong>core:*</strong></div>';
  h += '</div></div></div></div>';
  h += '<ul>';
  h += '<li>\u2705 app \u2192 feature \u2192 core\uFF08\u53EA\u80FD\u5411\u4E0B\u4F9D\u8CF4\uFF09</li>';
  h += '<li>\u274C feature \u4E0D\u80FD\u4F9D\u8CF4 feature\uFF08\u907F\u514D\u5FAA\u74B0\u4F9D\u8CF4\uFF09</li>';
  h += '<li>\u274C core \u4E0D\u80FD\u4F9D\u8CF4 feature\uFF08\u4E0D\u80FD\u53CD\u5411\uFF09</li>';
  h += '</ul>';
  h += '</div></div></div>';

  // --- Convention Plugins accordion ---
  h += '<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">\uD83D\uDD27 Convention Plugins</div><div class="acc-body"><div class="acc-inner">';
  h += '<p>NIA \u4F7F\u7528 <strong>Convention Plugins</strong> \u53D6\u4EE3 buildSrc\uFF0C\u7D71\u4E00\u6240\u6709\u6A21\u7D44\u7684 Gradle \u8A2D\u5B9A\u3002\u65B0\u589E\u4E00\u500B feature \u6A21\u7D44\u6642\uFF0C\u53EA\u9700\u5957\u7528\u5C0D\u61C9\u7684 plugin\uFF1A</p>';
  h += codeBlock(
    '// build-logic/convention/src/main/kotlin/\n' +
    '// AndroidFeatureConventionPlugin.kt\n' +
    'class AndroidFeatureConventionPlugin : Plugin<Project> {\n' +
    '    override fun apply(target: Project) {\n' +
    '        with(target) {\n' +
    '            pluginManager.apply {\n' +
    '                apply("nowinandroid.android.library")\n' +
    '                apply("nowinandroid.hilt")\n' +
    '            }\n' +
    '            dependencies {\n' +
    '                add("implementation", project(":core:ui"))\n' +
    '                add("implementation", project(":core:designsystem"))\n' +
    '            }\n' +
    '        }\n' +
    '    }\n' +
    '}'
  );
  h += '</div></div></div>';

  // --- æ¯”è¼ƒè¡¨ ---
  h += '<div class="glass-card"><h3>\uD83D\uDCCA \u6A21\u7D44\u5316 vs \u55AE\u6A21\u7D44</h3>';
  h += '<table class="cmp-table"><thead><tr><th>\u9762\u5411</th><th>\u55AE\u6A21\u7D44</th><th class="cmp-hl">NIA \u6A21\u7D44\u5316</th></tr></thead><tbody>';
  h += '<tr><td>\u7DE8\u8B6F\u6642\u9593</td><td>\u5168\u90E8\u91CD\u7DE8</td><td class="cmp-hl">\u53EA\u7DE8\u8B8A\u66F4\u6A21\u7D44</td></tr>';
  h += '<tr><td>\u5718\u968A\u5354\u4F5C</td><td>\u5BB9\u6613\u885D\u7A81</td><td class="cmp-hl">\u5404\u6A21\u7D44\u7368\u7ACB\u958B\u767C</td></tr>';
  h += '<tr><td>\u7A0B\u5F0F\u78BC\u91CD\u7528</td><td>\u8907\u88FD\u8CBC\u4E0A</td><td class="cmp-hl">core \u6A21\u7D44\u5171\u7528</td></tr>';
  h += '<tr><td>\u6E2C\u8A66\u9694\u96E2</td><td>\u56F0\u96E3</td><td class="cmp-hl">\u6A21\u7D44\u7D1A\u5225\u9694\u96E2</td></tr>';
  h += '</tbody></table></div>';

  // --- Insight Blocks ---
  h += insightBlock(6, 'NIA \u6709\u591A\u5C11\u500B\u6A21\u7D44\uFF1F\u7D04 30+ \u500B\uFF01\u4F46\u5225\u88AB\u6578\u5B57\u5687\u5230\u2014\u2014\u5927\u90E8\u5206\u6A21\u7D44\u7684 build.gradle.kts \u53EA\u67094-5 \u884C\uFF0C\u56E0\u70BA Convention Plugin \u5DF2\u7D93\u8655\u7406\u4E86\u6240\u6709\u91CD\u8907\u8A2D\u5B9A\u3002');
  h += insightBlock(7, '\u70BA\u4EC0\u9EBC feature \u4E0D\u80FD\u4F9D\u8CF4 feature\uFF1F\u5169\u500B\u539F\u56E0\uFF1A1) \u907F\u514D\u5FAA\u74B0\u4F9D\u8CF4\u5C0E\u81F4\u7DE8\u8B6F\u5931\u6557\uFF1B2) \u4FDD\u6301\u6A21\u7D44\u7368\u7ACB\u6027\uFF0C\u8B93\u4E26\u884C\u7DE8\u8B6F\u66F4\u6709\u6548\u3002\u5982\u679C\u5169\u500B feature \u9700\u8981\u5171\u7528\u908F\u8F2F\uFF0C\u8ACB\u62BD\u5230 core \u6A21\u7D44\u3002');
  h += insightBlock(8, 'Convention Plugin vs buildSrc\uFF1AbuildSrc \u7684\u4EFB\u4F55\u6539\u52D5\u6703\u89F8\u767C\u6240\u6709\u6A21\u7D44\u91CD\u65B0\u7DE8\u8B6F\uFF0C\u800C Convention Plugin \u4F5C\u70BA\u7368\u7ACB\u7684\u5B50\u5C08\u6848\uFF08included build\uFF09\uFF0C\u53EA\u6709\u76F4\u63A5\u4F9D\u8CF4\u5B83\u7684\u6A21\u7D44\u624D\u6703\u91CD\u7DE8\u3002');
  h += insightBlock(9, 'api vs implementation \u4F9D\u8CF4\u7684\u5DEE\u7570\uFF1Aimplementation \u4E0D\u6703\u5C07\u4F9D\u8CF4\u50B3\u905E\u7D66\u4E0A\u5C64\u6A21\u7D44\uFF0C\u800C api \u6703\u3002NIA \u9810\u8A2D\u7528 implementation \u4EE5\u6E1B\u5C11\u7DE8\u8B6F\u7684\u300C\u6CE2\u53CA\u7BC4\u570D\u300D\uFF0C\u53EA\u5728\u5FC5\u8981\u6642\u624D\u7528 api\u3002');

  // --- é–±è®€å®ŒæˆæŒ‰éˆ• ---
  h += '<div class="read-done' + (read ? ' done' : '') + '"><button class="btn ' + (read ? 'btn-sec' : 'btn-pri') + '" onclick="markRead(3)">' + (read ? '\u2713 \u5DF2\u95B1\u8B80' : '\uD83D\uDCD6 \u6A19\u8A18\u5DF2\u95B1\u8B80') + '</button></div>';

  // --- æ¸¬é©—ï¼šæ˜¯éé¡Œ ---
  var tfQuestions = [
    'Feature \u6A21\u7D44\u53EF\u4EE5\u4F9D\u8CF4\u53E6\u4E00\u500B Feature \u6A21\u7D44',
    'Core \u6A21\u7D44\u53EF\u4EE5\u4F9D\u8CF4 App \u6A21\u7D44',
    'Convention Plugin \u7684\u76EE\u7684\u662F\u7D71\u4E00 Gradle \u8A2D\u5B9A',
    'NIA \u4F7F\u7528 buildSrc \u4F86\u7BA1\u7406\u5171\u7528\u8A2D\u5B9A',
    'app \u6A21\u7D44\u8CA0\u8CAC\u4E32\u63A5\u6240\u6709 feature \u6A21\u7D44'
  ];
  h += '<div class="quiz-box' + (done ? ' done' : '') + '"><h3>\u2753 \u662F\u975E\u984C</h3>';
  for (var ti = 0; ti < 5; ti++) {
    h += '<div class="tf-row"><span class="tf-code">' + tfQuestions[ti] + '</span>';
    h += '<button class="tf-btn' + (S.part3Answers[ti] === true ? ' selected' : '') + '" onclick="setPart3Answer(' + ti + ',true)"' + (done ? ' disabled' : '') + '>\u2705 \u662F</button>';
    h += '<button class="tf-btn' + (S.part3Answers[ti] === false ? ' selected' : '') + '" onclick="setPart3Answer(' + ti + ',false)"' + (done ? ' disabled' : '') + '>\u274C \u5426</button>';
    h += '</div>';
  }
  h += '<div id="quiz3-result"></div>';
  h += '<button class="btn btn-pri" onclick="checkQuiz3()"' + (done ? ' disabled' : '') + '>\u63D0\u4EA4\u7B54\u6848</button></div>';

  // --- ç°¡å ±å¡ ---
  h += briefCard(3,
    '\u6A21\u7D44\u5316\u8A2D\u8A08',
    ['\u4E09\u7A2E\u6A21\u7D44\u985E\u578B\u5404\u6709\u8077\u8CAC','\u4F9D\u8CF4\u53EA\u80FD\u5411\u4E0B','Convention Plugin \u7D71\u4E00\u8A2D\u5B9A'],
    '\u300C\u6A21\u7D44\u5316\u6703\u4E0D\u6703\u8B93\u5C08\u6848\u7D50\u69CB\u592A\u8907\u96DC\uFF1F\u300D',
    '\u521D\u671F\u78BA\u5BE6\u9700\u8981\u5B78\u7FD2\u6210\u672C\uFF0C\u4F46 NIA \u900F\u904E Convention Plugin \u81EA\u52D5\u5957\u7528\u8A2D\u5B9A\uFF0C\u65B0\u589E\u6A21\u7D44\u53EA\u9700\u6975\u5C11\u8A2D\u5B9A\u3002\u9577\u671F\u4F86\u770B\uFF0C\u6A21\u7D44\u5316\u5E36\u4F86\u7684\u7DE8\u8B6F\u52A0\u901F\u548C\u5718\u968A\u5354\u4F5C\u6548\u7387\u63D0\u5347\u9060\u8D85\u521D\u59CB\u6210\u672C\u3002'
  );

  return h;
}

function setPart3Answer(idx, v) {
  S.part3Answers[idx] = v;
  save();render();
}

function checkQuiz3() {
  var correct = [false, false, true, false, true];
  var allRight = true;
  for (var i = 0; i < 5; i++) {
    if (S.part3Answers[i] !== correct[i]) { allRight = false; break; }
  }
  var el = document.getElementById('quiz3-result');
  if (allRight) {
    el.innerHTML = '<p style="color:#4ade80;font-weight:700">\u2705 \u5168\u90E8\u6B63\u78BA\uFF01\u4F60\u5DF2\u638C\u63E1\u6A21\u7D44\u5316\u7684\u6838\u5FC3\u898F\u5247\u3002</p>';
    completePart(3);
    addXP(50, 'Part 3 \u662F\u975E\u984C\u5168\u5C0D');
  } else {
    el.innerHTML = '<p style="color:#f87171">\u274C \u6709\u7B54\u6848\u932F\u8AA4\uFF0C\u8ACB\u518D\u60F3\u60F3\u6A21\u7D44\u9593\u7684\u4F9D\u8CF4\u898F\u5247\u3002</p>';
  }
}

// ============================================================
// Part 4: æ•¸æ“šæµèˆ‡é›¢ç·šå„ªå…ˆ
// ============================================================
function getPart4() {
  const done = S.completedParts.includes(4);
  const read = S.readParts.includes(4);
  let h = '<div class="part-hdr"><span class="tag">Part 4</span><h1>\uD83D\uDD04 \u6578\u64DA\u6D41\u8207\u96E2\u7DDA\u512A\u5148</h1><p class="desc">\u8B93 App \u96E2\u7DDA\u4E5F\u80FD\u7528 \u2014 \u7B2C\u4E00\u6027\u539F\u7406\uFF1A\u672C\u5730\u8CC7\u6599\u5EAB\u624D\u662F\u552F\u4E00\u771F\u76F8</p></div>';

  // --- Offline-first ç­–ç•¥ accordion ---
  h += '<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">\uD83D\uDCF4 Offline-first \u7B56\u7565</div><div class="acc-body"><div class="acc-inner">';
  h += '<p>NIA \u63A1\u7528 <strong>Offline-first</strong> \u67B6\u69CB\uFF1ARoom Database \u4F5C\u70BA <strong>Single Source of Truth (SSOT)</strong>\u3002UI \u6C38\u9060\u5F9E\u672C\u5730 DB \u8B80\u53D6\u8CC7\u6599\uFF0C\u4E0D\u76F4\u63A5\u5B58\u53D6\u7DB2\u8DEF\u3002\u7DB2\u8DEF\u53EA\u8CA0\u8CAC\u540C\u6B65\u8CC7\u6599\u5230\u672C\u5730\u3002</p>';
  h += codeBlock(
    'class OfflineFirstTopicsRepository @Inject constructor(\n' +
    '    private val topicDao: TopicDao,\n' +
    '    private val network: NiaNetworkDataSource,\n' +
    '    private val notifier: Notifier\n' +
    ') : TopicsRepository {\n\n' +
    '    override fun getTopics(): Flow<List<Topic>> =\n' +
    '        topicDao.getTopicEntities()\n' +
    '            .map { it.map(TopicEntity::asExternalModel) }\n\n' +
    '    override suspend fun syncWith(\n' +
    '        synchronizer: Synchronizer\n' +
    '    ): Boolean =\n' +
    '        synchronizer.changeListSync(\n' +
    '            versionReader = ChangeListVersions::topicVersion,\n' +
    '            changeListFetcher = { \n' +
    '                network.getTopicChangeList(after = it) \n' +
    '            },\n' +
    '            modelUpdater = { changedIds ->\n' +
    '                val networkTopics = network.getTopics(\n' +
    '                    ids = changedIds\n' +
    '                )\n' +
    '                topicDao.upsertTopics(\n' +
    '                    networkTopics.map(NetworkTopic::asEntity)\n' +
    '                )\n' +
    '            }\n' +
    '        )\n' +
    '}'
  );
  h += '</div></div></div>';

  // --- WorkManager èƒŒæ™¯åŒæ­¥ accordion ---
  h += '<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">\u23F0 WorkManager \u80CC\u666F\u540C\u6B65</div><div class="acc-body"><div class="acc-inner">';
  h += '<p>NIA \u4F7F\u7528 <strong>WorkManager</strong> \u5728\u80CC\u666F\u5B9A\u671F\u540C\u6B65\u8CC7\u6599\u3002\u540C\u6B65\u5931\u6557\u6642\u56DE\u50B3 <code>Result.retry()</code>\uFF0C\u8B93\u7CFB\u7D71\u81EA\u52D5\u6392\u7A0B\u91CD\u8A66\uFF08\u4F7F\u7528\u6307\u6578\u9000\u907F\u7B56\u7565\uFF09\u3002</p>';
  h += codeBlock(
    'class SyncWorker @AssistedInject constructor(\n' +
    '    @Assisted appContext: Context,\n' +
    '    @Assisted workerParams: WorkerParameters,\n' +
    '    private val syncManager: SyncManager\n' +
    ') : CoroutineWorker(appContext, workerParams) {\n\n' +
    '    override suspend fun doWork(): Result =\n' +
    '        if (syncManager.sync()) Result.success()\n' +
    '        else Result.retry()\n' +
    '}'
  );
  h += '</div></div></div>';

  // --- æ¨¡å‹è½‰æ›éˆ accordion ---
  h += '<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">\uD83D\uDD04 \u6A21\u578B\u8F49\u63DB\u93C8\uFF1ANetworkModel \u2192 Entity \u2192 ExternalModel</div><div class="acc-body"><div class="acc-inner">';
  h += '<p>NIA \u4F7F\u7528\u4E09\u7A2E Model\uFF0C\u5404\u53F8\u5176\u8077\uFF1A</p>';
  h += '<ul>';
  h += '<li><strong>NetworkXxx</strong>\uFF1A\u5C0D\u61C9 API \u56DE\u61C9\u7684 JSON \u7D50\u69CB</li>';
  h += '<li><strong>XxxEntity</strong>\uFF1ARoom \u8CC7\u6599\u5EAB\u7684\u8868\u683C\u7D50\u69CB</li>';
  h += '<li><strong>Xxx</strong>\uFF08ExternalModel\uFF09\uFF1AUI \u5C64\u548C Domain \u5C64\u4F7F\u7528\u7684\u4E7E\u6DE8\u6A21\u578B</li>';
  h += '</ul>';
  h += '<div class="dep-diagram">';
  h += '<div class="dep-layer">NetworkTopic</div><div class="dep-arrow">\u2193 asEntity()</div>';
  h += '<div class="dep-layer">TopicEntity</div><div class="dep-arrow">\u2193 asExternalModel()</div>';
  h += '<div class="dep-layer">Topic</div>';
  h += '</div>';
  h += codeBlock(
    '// Network \u2192 Entity\n' +
    'fun NetworkTopic.asEntity() = TopicEntity(\n' +
    '    id = id,\n' +
    '    name = name,\n' +
    '    shortDescription = shortDescription,\n' +
    '    longDescription = longDescription,\n' +
    '    url = url,\n' +
    '    imageUrl = imageUrl\n' +
    ')\n\n' +
    '// Entity \u2192 ExternalModel\n' +
    'fun TopicEntity.asExternalModel() = Topic(\n' +
    '    id = id,\n' +
    '    name = name,\n' +
    '    shortDescription = shortDescription,\n' +
    '    longDescription = longDescription,\n' +
    '    url = url,\n' +
    '    imageUrl = imageUrl\n' +
    ')'
  );
  h += '</div></div></div>';

  // --- Insight Blocks ---
  h += insightBlock(10, '\u70BA\u4EC0\u9EBC\u4E0D\u76F4\u63A5 cache API response\uFF1F\u56E0\u70BA Room \u63D0\u4F9B\u7D50\u69CB\u5316\u8CC7\u6599\u5B58\u53D6\u3001\u652F\u63F4\u589E\u91CF\u66F4\u65B0\u548C\u8907\u96DC\u67E5\u8A62\u3002\u76F4\u63A5\u5FEB\u53D6 JSON \u5247\u7121\u6CD5\u505A\u5230\u9019\u4E9B\uFF0C\u800C\u4E14\u6BCF\u6B21\u90FD\u8981\u53CD\u5E8F\u5217\u5316\u6574\u500B\u56DE\u61C9\u3002');
  h += insightBlock(11, 'Change List Sync \u6A21\u5F0F\uFF1ANIA \u4E0D\u6703\u6BCF\u6B21\u90FD\u62C9\u53D6\u5168\u90E8\u8CC7\u6599\uFF0C\u800C\u662F\u900F\u904E version number \u8FFD\u8E64\u4E0A\u6B21\u540C\u6B65\u4F4D\u7F6E\uFF0C\u53EA\u62C9\u53D6\u8B8A\u66F4\u7684\u90E8\u5206\u3002\u9019\u5927\u5E45\u7BC0\u7701\u7DB2\u8DEF\u6D41\u91CF\u548C\u4F3A\u670D\u5668\u8CA0\u64D4\u3002');
  h += insightBlock(12, '\u4E09\u7A2E Model \u7684\u547D\u540D\u6163\u4F8B\uFF1ANetworkXxx\uFF08API \u5C64\uFF09\u3001XxxEntity\uFF08DB \u5C64\uFF09\u3001Xxx\uFF08Domain/UI \u5C64\uFF09\u3002\u9019\u500B\u547D\u540D\u898F\u5247\u8B93\u4F60\u4E00\u773C\u5C31\u77E5\u9053\u6A21\u578B\u5C6C\u65BC\u54EA\u4E00\u5C64\u3002');
  h += insightBlock(13, '\u70BA\u4EC0\u9EBC\u7528 upsert \u800C\u4E0D\u662F insert\uFF1Fupsert = insert or update\u3002\u7576\u8CC7\u6599\u5DF2\u5B58\u5728\u6642\u81EA\u52D5\u66F4\u65B0\uFF0C\u4E0D\u5B58\u5728\u6642\u81EA\u52D5\u65B0\u589E\uFF0C\u907F\u514D\u4E3B\u9375\u885D\u7A81\u5C0E\u81F4 crash\u3002Room 2.5+ \u539F\u751F\u652F\u63F4 @Upsert \u6CE8\u89E3\u3002');

  // --- é–±è®€å®ŒæˆæŒ‰éˆ• ---
  h += '<div class="read-done' + (read ? ' done' : '') + '"><button class="btn ' + (read ? 'btn-sec' : 'btn-pri') + '" onclick="markRead(4)">' + (read ? '\u2713 \u5DF2\u95B1\u8B80' : '\uD83D\uDCD6 \u6A19\u8A18\u5DF2\u95B1\u8B80') + '</button></div>';

  // --- æ¸¬é©—ï¼šé¸æ“‡é¡Œ ---
  var mcQuestions = [
    {
      q: '\u5728 NIA \u4E2D\uFF0CUI \u7684\u8CC7\u6599\u4F86\u6E90\u662F\uFF1F',
      opts: ['\u76F4\u63A5\u5F9E API \u53D6\u5F97', '\u5F9E Room Database \u8B80\u53D6', '\u5F9E SharedPreferences', '\u5F9E\u8A18\u61B6\u9AD4\u5FEB\u53D6']
    },
    {
      q: '\u7576\u7DB2\u8DEF\u4E0D\u53EF\u7528\u6642\uFF0COfflineFirstTopicsRepository \u6703\uFF1F',
      opts: ['\u62CB\u51FA\u4F8B\u5916', '\u8FD4\u56DE\u7A7A\u5217\u8868', '\u8FD4\u56DE\u672C\u5730\u5FEB\u53D6\u8CC7\u6599', '\u986F\u793A\u932F\u8AA4\u756B\u9762']
    },
    {
      q: 'WorkManager \u540C\u6B65\u5931\u6557\u6642\u7684\u7B56\u7565\u662F\uFF1F',
      opts: ['\u653E\u68C4\u540C\u6B65', '\u7ACB\u5373\u91CD\u8A66', '\u56DE\u50B3 Result.retry() \u8B93\u7CFB\u7D71\u6392\u7A0B\u91CD\u8A66', '\u901A\u77E5\u4F7F\u7528\u8005']
    },
    {
      q: 'NIA \u7684 Model \u8F49\u63DB\u93C8\u6B63\u78BA\u9806\u5E8F\u662F\uFF1F',
      opts: ['Entity \u2192 NetworkModel \u2192 ExternalModel', 'NetworkModel \u2192 Entity \u2192 ExternalModel', 'ExternalModel \u2192 Entity \u2192 NetworkModel', 'NetworkModel \u2192 ExternalModel \u2192 Entity']
    },
    {
      q: 'NIA \u4F7F\u7528 Change List Sync \u800C\u975E\u5B8C\u6574\u540C\u6B65\u7684\u4E3B\u8981\u539F\u56E0\u662F\uFF1F',
      opts: ['\u5BE6\u4F5C\u66F4\u7C21\u55AE', '\u6E1B\u5C11\u7DB2\u8DEF\u6D41\u91CF\u548C\u4F3A\u670D\u5668\u8CA0\u64D4', '\u76F8\u5BB9 GraphQL', 'Android \u5E73\u53F0\u9650\u5236']
    }
  ];
  var correctMC = [1, 2, 2, 1, 1];

  h += '<div class="quiz-box' + (done ? ' done' : '') + '"><h3>\uD83D\uDCDD \u9078\u64C7\u984C</h3>';
  for (var qi = 0; qi < 5; qi++) {
    h += '<div class="quiz-row"><p><strong>Q' + (qi + 1) + '. ' + mcQuestions[qi].q + '</strong></p>';
    for (var oi = 0; oi < 4; oi++) {
      var selClass = S.part4Answers[qi] === oi ? ' selected' : '';
      h += '<button class="quiz-opt' + selClass + '" onclick="setPart4Answer(' + qi + ',' + oi + ')"' + (done ? ' disabled' : '') + '>' + String.fromCharCode(65 + oi) + '. ' + mcQuestions[qi].opts[oi] + '</button>';
    }
    h += '</div>';
  }
  h += '<div id="quiz4-result"></div>';
  h += '<button class="btn btn-pri" onclick="checkQuiz4()"' + (done ? ' disabled' : '') + '>\u63D0\u4EA4\u7B54\u6848</button></div>';

  // --- ç°¡å ±å¡ ---
  h += briefCard(4,
    '\u6578\u64DA\u6D41\u8207\u96E2\u7DDA\u512A\u5148',
    ['Room \u4F5C\u70BA\u552F\u4E00\u8CC7\u6599\u4F86\u6E90','WorkManager \u8655\u7406\u80CC\u666F\u540C\u6B65','\u4E09\u5C64 Model \u8F49\u63DB\u78BA\u4FDD\u95DC\u6CE8\u9EDE\u5206\u96E2'],
    '\u300C\u96E2\u7DDA\u512A\u5148\u6703\u4E0D\u6703\u8B93\u5BE6\u4F5C\u66F4\u8907\u96DC\uFF1F\u300D',
    '\u78BA\u5BE6\u589E\u52A0\u4E86\u521D\u59CB\u958B\u767C\u6210\u672C\uFF0C\u4F46 NIA \u7684 OfflineFirst Repository \u6A21\u5F0F\u5DF2\u7D93\u5EFA\u7ACB\u4E86\u6E05\u6670\u7684\u6A23\u677F\u3002\u4E00\u65E6\u57FA\u790E\u8A2D\u65BD\u5C31\u4F4D\uFF0C\u65B0\u529F\u80FD\u53EA\u9700\u9075\u5FAA\u76F8\u540C\u6A21\u5F0F\uFF0C\u800C\u4F7F\u7528\u8005\u7372\u5F97\u7684\u96E2\u7DDA\u9AD4\u9A57\u63D0\u5347\u662F\u5DE8\u5927\u7684\u3002'
  );

  return h;
}

function setPart4Answer(qi, oi) {
  S.part4Answers[qi] = oi;
  save();render();
}

function checkQuiz4() {
  var correct = [1, 2, 2, 1, 1];
  var allRight = true;
  for (var i = 0; i < 5; i++) {
    if (S.part4Answers[i] !== correct[i]) { allRight = false; break; }
  }
  var el = document.getElementById('quiz4-result');
  if (allRight) {
    el.innerHTML = '<p style="color:#4ade80;font-weight:700">\u2705 \u5168\u90E8\u6B63\u78BA\uFF01\u4F60\u5DF2\u638C\u63E1\u96E2\u7DDA\u512A\u5148\u67B6\u69CB\u7684\u6838\u5FC3\u6982\u5FF5\u3002</p>';
    completePart(4);
    addXP(50, 'Part 4 \u9078\u64C7\u984C\u5168\u5C0D');
  } else {
    el.innerHTML = '<p style="color:#f87171">\u274C \u6709\u7B54\u6848\u932F\u8AA4\uFF0C\u8ACB\u518D\u5FA9\u7FD2\u96E2\u7DDA\u512A\u5148\u548C\u8CC7\u6599\u6D41\u7684\u76F8\u95DC\u5167\u5BB9\u3002</p>';
  }
}


// ===== Part 5: ä¾è³´æ³¨å…¥èˆ‡æ¸¬è©¦ç­–ç•¥ =====
function getPart5(){
  const done=S.completedParts.includes(5);
  const read=S.readParts.includes(5);
  let h='<div class="part-hdr"><span class="tag">Part 5</span><h1>\u{1F9EA} ä¾è³´æ³¨å…¥èˆ‡æ¸¬è©¦ç­–ç•¥</h1><p class="desc">Hilt DI + Fake-based Testing â€” ç¬¬ä¸€æ€§åŸç†ï¼šå¯æ¸¬è©¦æ€§æ±ºå®šæ¶æ§‹å“è³ª</p></div>';

  // --- Accordion 1: Hilt DI ---
  h+='<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">Hilt DIï¼š@Binds vs @Provides</div><div class="acc-body"><div class="acc-inner">';
  h+='<p><strong>@Binds</strong> ç”¨æ–¼å‘Šè¨´ Hilt æŸå€‹ä»‹é¢å°æ‡‰å“ªå€‹å¯¦ä½œé¡åˆ¥ã€‚å®ƒæ˜¯ä¸€å€‹ <code>abstract</code> å‡½å¼ï¼Œä¸éœ€è¦å¯«å‡½å¼æœ¬é«”ã€‚</p>';
  h+='<p><strong>@Provides</strong> ç”¨æ–¼éœ€è¦æ‰‹å‹•å»ºæ§‹ç‰©ä»¶çš„æƒ…å¢ƒï¼Œä¾‹å¦‚å»ºç«‹ Room Database å¯¦ä¾‹æˆ–ç¬¬ä¸‰æ–¹å‡½å¼åº«ç‰©ä»¶ã€‚</p>';
  h+='<p><strong>@HiltViewModel</strong> æ­é… <code>@Inject constructor</code>ï¼Œè®“ Hilt è‡ªå‹•æä¾› ViewModel æ‰€éœ€çš„ä¾è³´ã€‚</p>';
  h+=codeBlock(
    '@Module\n' +
    '@InstallIn(SingletonComponent::class)\n' +
    'abstract class DataModule {\n' +
    '    @Binds\n' +
    '    abstract fun bindsTopicsRepository(\n' +
    '        impl: OfflineFirstTopicsRepository\n' +
    '    ): TopicsRepository\n' +
    '}'
  );
  h+=codeBlock(
    '@Module\n' +
    '@InstallIn(SingletonComponent::class)\n' +
    'object DatabaseModule {\n' +
    '    @Provides\n' +
    '    @Singleton\n' +
    '    fun providesNiaDatabase(\n' +
    '        @ApplicationContext context: Context\n' +
    '    ): NiaDatabase = Room.databaseBuilder(\n' +
    '        context,\n' +
    '        NiaDatabase::class.java,\n' +
    '        "nia-database"\n' +
    '    ).build()\n' +
    '}'
  );
  h+=insightBlock(14,'<strong>@Binds vs @Provides çš„é¸æ“‡æº–å‰‡</strong><br>æœ‰ä»‹é¢å°æ‡‰å¯¦ä½œ â†’ ç”¨ <code>@Binds</code>ï¼ˆabstract functionï¼Œé›¶æˆæœ¬ï¼‰<br>éœ€è¦è‡ªå·± new / å»ºæ§‹ç‰©ä»¶ â†’ ç”¨ <code>@Provides</code>ï¼ˆéœ€è¦å¯«å‡½å¼æœ¬é«”ï¼‰<br>ç°¡å–®è¦å‰‡ï¼šå¦‚æœä½ åªæ˜¯ã€ŒæŒ‡è·¯ã€ç”¨ Bindsï¼Œå¦‚æœä½ è¦ã€Œé€ æ±è¥¿ã€ç”¨ Providesã€‚');
  h+=insightBlock(17,'<strong>@HiltViewModel èƒŒå¾Œåšäº†ä»€éº¼</strong><br>Hilt æœƒç‚ºæ¯å€‹æ¨™è¨» @HiltViewModel çš„ ViewModel ç”¢ç”Ÿä¸€å€‹ <code>ViewModelProvider.Factory</code>ï¼Œé€é <code>SavedStateHandle</code> å·¥å» è‡ªå‹•æ³¨å…¥æ‰€æœ‰ constructor åƒæ•¸ã€‚é€™å°±æ˜¯ç‚ºä»€éº¼ä½ å¯ä»¥åœ¨ Compose è£¡ç›´æ¥ç”¨ <code>hiltViewModel()</code> å–å¾—å®Œæ•´æ³¨å…¥çš„ ViewModelã€‚');
  h+='</div></div></div>';

  // --- Accordion 2: Fakes over Mocks ---
  h+='<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">Fakes over Mocksï¼šNIA çš„æ¸¬è©¦å“²å­¸</div><div class="acc-body"><div class="acc-inner">';
  h+='<p>NIA <strong>ä¸ä½¿ç”¨ Mockito</strong>ï¼Œè€Œæ˜¯ç‚ºæ¯å€‹ Repository ä»‹é¢å»ºç«‹ <strong>Fake</strong> å¯¦ä½œã€‚</p>';
  h+='<p><strong>Fake</strong> æ˜¯å®Œæ•´çš„ä»‹é¢å¯¦ä½œï¼Œå…·æœ‰å¯é æ¸¬çš„è¡Œç‚ºã€‚å®ƒä¸åªæ˜¯å›å‚³é è¨­å€¼ï¼Œè€Œæ˜¯æ¨¡æ“¬çœŸå¯¦çš„è³‡æ–™æµã€‚</p>';
  h+=codeBlock(
    'class TestNewsRepository : NewsRepository {\n' +
    '    private val newsResourcesFlow =\n' +
    '        MutableSharedFlow<List<NewsResource>>()\n' +
    '\n' +
    '    override fun getNewsResources():\n' +
    '        Flow<List<NewsResource>> = newsResourcesFlow\n' +
    '\n' +
    '    fun sendNewsResources(\n' +
    '        resources: List<NewsResource>\n' +
    '    ) {\n' +
    '        newsResourcesFlow.tryEmit(resources)\n' +
    '    }\n' +
    '}'
  );
  h+=insightBlock(15,'<strong>ç‚ºä»€éº¼ Fake æ¯” Mock å¥½ï¼Ÿ</strong><br>Mock åƒä¸€å°ã€ŒéŒ„æ”¾æ©Ÿã€ï¼šä½ å‘Šè¨´å®ƒæ”¶åˆ°ä»€éº¼å°±å›ä»€éº¼ï¼Œå®ƒæ²’æœ‰é‚è¼¯ã€‚<br>Fake æ˜¯çœŸå¯¦è¡Œç‚ºçš„ã€Œç°¡åŒ–ç‰ˆã€ï¼šå®ƒå¯¦ä½œäº†å®Œæ•´ä»‹é¢ï¼Œæœ‰è‡ªå·±çš„å…§éƒ¨ç‹€æ…‹å’Œé‚è¼¯ã€‚<br>å¥½è™•ï¼š(1) å¯ä»¥è·¨å¤šå€‹æ¸¬è©¦é‡ç”¨ (2) é‡æ§‹ä»‹é¢æ™‚ Fake æœƒç·¨è­¯å¤±æ•—æé†’ä½  (3) æ¸¬è©¦æ›´æ¥è¿‘çœŸå¯¦è¡Œç‚ºã€‚');
  h+='</div></div></div>';

  // --- Accordion 3: ViewModel æ¸¬è©¦ ---
  h+='<div class="accordion"><div class="acc-head" onclick="toggleAcc(this)">ViewModel æ¸¬è©¦ï¼šTurbine + Fake</div><div class="acc-body"><div class="acc-inner">';
  h+='<p>NIA ä½¿ç”¨ <strong>Turbine</strong> å‡½å¼åº«æ¸¬è©¦ Flow çš„ç™¼å°„å€¼ï¼Œæ­é…æ³¨å…¥ Fake Repositoryã€‚</p>';
  h+=codeBlock(
    'class ForYouViewModelTest {\n' +
    '    private val newsRepository = TestNewsRepository()\n' +
    '    private lateinit var viewModel: ForYouViewModel\n' +
    '\n' +
    '    @Before\n' +
    '    fun setup() {\n' +
    '        viewModel = ForYouViewModel(\n' +
    '            getUserNewsResources =\n' +
    '                GetUserNewsResourcesUseCase(\n' +
    '                    newsRepository = newsRepository,\n' +
    '                    userDataRepository =\n' +
    '                        TestUserDataRepository()\n' +
    '                )\n' +
    '        )\n' +
    '    }\n' +
    '\n' +
    '    @Test\n' +
    '    fun stateIsInitiallyLoading() = runTest {\n' +
    '        assertEquals(\n' +
    '            ForYouUiState.Loading,\n' +
    '            viewModel.uiState.value\n' +
    '        )\n' +
    '    }\n' +
    '}'
  );
  h+=insightBlock(16,'<strong>Turbine æ¸¬è©¦ Flow çš„åŸç†</strong><br>Turbine æä¾› <code>flow.test { }</code> æ“´å……å‡½å¼ï¼Œå®ƒæœƒå•Ÿå‹•ä¸€å€‹æ”¶é›†å™¨ä¾†ç›£è½ Flow ç™¼å°„çš„å€¼ã€‚<br>ä½ å¯ä»¥ç”¨ <code>awaitItem()</code> å–å¾—ä¸‹ä¸€å€‹å€¼ï¼Œç”¨ <code>expectNoEvents()</code> ç¢ºèªæ²’æœ‰å¤šé¤˜ç™¼å°„ã€‚<br>å…§å»ºé€¾æ™‚æ©Ÿåˆ¶ï¼šå¦‚æœ Flow æ²’æœ‰åœ¨æŒ‡å®šæ™‚é–“å…§ç™¼å°„å€¼ï¼Œæ¸¬è©¦æœƒè‡ªå‹•å¤±æ•—ã€‚');
  h+='</div></div></div>';

  // --- è²»æ›¼é©—è­‰ ---
  h+='<div class="quiz-box"><div class="quiz-row"><span class="quiz-tag">\u{1F9E0} è²»æ›¼é©—è­‰</span></div>';
  h+='<p>ç”¨ä½ è‡ªå·±çš„è©±è§£é‡‹ä»¥ä¸‹æ¦‚å¿µï¼Œå¯«å®Œå¾Œçµ¦è‡ªå·±æ‰“å€‹æ˜Ÿæ˜Ÿè‡ªè©•ã€‚</p>';

  var feynmanQs=[
    {q:'è«‹ç”¨ä½ è‡ªå·±çš„è©±è§£é‡‹ï¼šç‚ºä»€éº¼ NIA é¸æ“‡ Fake è€Œä¸æ˜¯ Mock ä¾†åšæ¸¬è©¦ï¼Ÿ',ref:'Fake æ˜¯ä»‹é¢çš„çœŸå¯¦ä½†ç°¡åŒ–å¯¦ä½œï¼Œå…·æœ‰å¯é æ¸¬çš„è¡Œç‚ºã€‚Mock å‰‡åªæ˜¯è¨˜éŒ„å’Œå›æ”¾å‘¼å«ï¼Œä¸åŒ…å«çœŸæ­£çš„é‚è¼¯ã€‚Fake å¯ä»¥è·¨æ¸¬è©¦é‡ç”¨ï¼Œç¶­è­·æˆæœ¬æ›´ä½ã€‚'},
    {q:'è«‹ç”¨ä½ è‡ªå·±çš„è©±è§£é‡‹ï¼š@Binds å’Œ @Provides çš„å·®åˆ¥æ˜¯ä»€éº¼ï¼Ÿä»€éº¼æ™‚å€™ç”¨å“ªå€‹ï¼Ÿ',ref:'@Binds ç”¨æ–¼å‘Šè¨´ Hilt æŸå€‹ä»‹é¢çš„å¯¦ä½œæ˜¯å“ªå€‹é¡åˆ¥ï¼Œä¸éœ€è¦å¯«å‡½å¼æœ¬é«”ã€‚@Provides ç”¨æ–¼éœ€è¦æ‰‹å‹•å»ºæ§‹ç‰©ä»¶çš„æƒ…æ³ï¼Œä¾‹å¦‚å»ºç«‹ Room Databaseã€‚'},
    {q:'è«‹ç”¨ä½ è‡ªå·±çš„è©±è§£é‡‹ï¼šsealed interface UiState åœ¨ NIA ä¸­æ‰®æ¼”ä»€éº¼è§’è‰²ï¼Ÿ',ref:'sealed interface ç”¨æ–¼å®šç¾©ç•«é¢çš„æ‰€æœ‰å¯èƒ½ç‹€æ…‹ï¼ˆå¦‚ Loadingã€Successã€Errorï¼‰ï¼Œè®“ Compose å¯ä»¥é€é when è¡¨é”å¼çª®èˆ‰æ‰€æœ‰ç‹€æ…‹ï¼Œç¢ºä¿ä¸æœƒéºæ¼ä»»ä½•æƒ…æ³ã€‚'}
  ];

  for(var i=0;i<3;i++){
    h+='<div class="feynman-q"><p><strong>Q'+(i+1)+':</strong> '+feynmanQs[i].q+'</p>';
    h+='<textarea class="feynman-ta" rows="4" placeholder="ç”¨ä½ è‡ªå·±çš„è©±å¯«ä¸‹ç†è§£..." oninput="S.part5Answers['+i+']=this.value;save()">'+escapeHtmlAttr(S.part5Answers[i])+'</textarea>';
    // è‡ªè©•æ˜Ÿæ˜Ÿ
    h+='<div class="rating">';
    for(var s=1;s<=5;s++){
      h+='<span class="rating-star'+(S.part5Ratings[i]>=s?' lit':'')+'" onclick="S.part5Ratings['+i+']='+s+';save();render()">\u2605</span>';
    }
    h+='<span style="margin-left:8px;opacity:0.7">'+(S.part5Ratings[i]>0?S.part5Ratings[i]+' / 5':'æœªè©•åˆ†')+'</span>';
    h+='</div>';
    // åƒè€ƒç­”æ¡ˆ
    h+='<div class="feynman-ref"><strong>åƒè€ƒç­”æ¡ˆï¼š</strong>'+feynmanQs[i].ref+'</div>';
    h+='</div>';
  }

  h+='<button class="btn btn-pri" onclick="checkFeynman5()" '+(done?'disabled':'')+'>'+( done?'\u2705 å·²å®Œæˆé©—è­‰':'\u{1F50D} é©—è­‰æˆ‘çš„ç†è§£')+'</button>';
  h+='</div>';

  // --- é–±è®€å®ŒæˆæŒ‰éˆ• ---
  h+='<div class="read-done'+(read?' done':'')+'"><button class="btn '+(read?'btn-sec':'btn-pri')+'" onclick="markRead(5)">'+(read?'\u2713 å·²é–±è®€':'\u{1F4D6} æ¨™è¨˜å·²é–±è®€')+'</button></div>';

  // --- ç°¡å ±å¡ ---
  h+=briefCard(5,
    'ä¾è³´æ³¨å…¥èˆ‡æ¸¬è©¦ç­–ç•¥',
    ['Hilt é€é @Binds/@Provides ç®¡ç†ä¾è³´','Fake å„ªæ–¼ Mock æ˜¯ NIA çš„æ ¸å¿ƒæ¸¬è©¦ç­–ç•¥','ViewModel æ¸¬è©¦ä½¿ç”¨ Turbine + æ³¨å…¥ Fake'],
    'Fake ç¶­è­·æˆæœ¬ä¸æ˜¯æ›´é«˜å—ï¼Ÿ',
    'åˆå§‹æˆæœ¬ç¢ºå¯¦è¼ƒé«˜ï¼Œä½† Fake å¯ä»¥è·¨å¤šå€‹æ¸¬è©¦é‡ç”¨ï¼Œä¸”èˆ‡çœŸå¯¦ä»‹é¢è¡Œç‚ºä¸€è‡´ï¼Œé‡æ§‹æ™‚æ›´ä¸å®¹æ˜“å› ç‚º Mock è¨­å®šéåº¦è€¦åˆè€Œå¤§é‡å¤±æ•—ã€‚NIA è­‰æ˜äº†é€™å€‹ç­–ç•¥åœ¨ä¸­å¤§å‹å°ˆæ¡ˆä¸­æ›´å¯æŒçºŒã€‚'
  );

  return h;
}

// --- checkFeynman5 ---
function checkFeynman5(){
  var keywords=[
    ['ä»‹é¢','å¯¦ä½œ','è¡Œç‚º','é‡ç”¨'],
    ['ä»‹é¢','å¯¦ä½œ','å»ºæ§‹'],
    ['ç‹€æ…‹','when','çª®èˆ‰']
  ];
  var minMatch=[2,2,2];
  var allPass=true;
  var msgs=[];

  for(var i=0;i<3;i++){
    var ans=S.part5Answers[i]||'';
    var rating=S.part5Ratings[i]||0;
    var matched=0;
    for(var k=0;k<keywords[i].length;k++){
      if(ans.indexOf(keywords[i][k])!==-1) matched++;
    }
    var lenOk=ans.length>=10;
    var kwOk=matched>=minMatch[i];
    var rtOk=rating>=3;
    if(!lenOk) msgs.push('Q'+(i+1)+'ï¼šå›ç­”å¤ªçŸ­ï¼ˆè‡³å°‘ 10 å­—ï¼‰');
    if(!kwOk) msgs.push('Q'+(i+1)+'ï¼šè«‹åŒ…å«æ›´å¤šé—œéµæ¦‚å¿µï¼ˆéœ€è¦è‡³å°‘ '+minMatch[i]+' å€‹é—œéµå­—ï¼‰');
    if(!rtOk) msgs.push('Q'+(i+1)+'ï¼šè‡ªè©•éœ€è¦è‡³å°‘ 3 æ˜Ÿ');
    if(!lenOk||!kwOk||!rtOk) allPass=false;
  }

  if(allPass){
    completePart(5);
    addXP(50,'è²»æ›¼é©—è­‰å…¨æ•¸é€šéï¼');
    alert('\u{1F389} å¤ªæ£’äº†ï¼ä½ å·²é€šé Part 5 çš„è²»æ›¼é©—è­‰ï¼');
  }else{
    alert('\u274C å°šæœªé€šéï¼š\n'+msgs.join('\n'));
  }
  render();
}


// ===== Part 6: æ¨¡æ“¬åŠŸèƒ½å¯¦ä½œ =====
function getPart6(){
  const done=S.completedParts.includes(6);
  const read=S.readParts.includes(6);
  let h='<div class="part-hdr"><span class="tag">Part 6</span><h1>\u{1F6E0}\uFE0F æ¨¡æ“¬åŠŸèƒ½å¯¦ä½œ</h1><p class="desc">å¯¦ä½œç°¡åŒ–ç‰ˆ Bookmarks åŠŸèƒ½ â€” ç¬¬ä¸€æ€§åŸç†ï¼šåšä¸­å­¸æ˜¯æœ€å¥½çš„å­¸ç¿’</p></div>';

  var step=S.part6Step||0;

  // Step definitions
  var steps=[];

  // Step 0: Domain Model
  steps.push({
    title:'å®šç¾© Domain Model',
    file:'core/model/BookmarkedNews.kt',
    content:function(){
      var s='<p>ç¬¬ä¸€æ­¥ï¼šå®šç¾©é ˜åŸŸæ¨¡å‹ã€‚é€™æ˜¯æ•´å€‹åŠŸèƒ½çš„è³‡æ–™åŸºç¤ã€‚</p>';
      s+=codeBlock(
        'data class BookmarkedNews(\n' +
        '    val id: String,\n' +
        '    val title: String,\n' +
        '    val description: String,\n' +
        '    val isBookmarked: Boolean\n' +
        ')'
      );
      return s;
    }
  });

  // Step 1: Repository ä»‹é¢ (ç¨‹å¼ç¢¼ç·¨è¼¯é¡Œ 1)
  var code1Default=
    'interface BookmarksRepository {\n' +
    '    // TODO: å®šç¾©å–å¾—æ›¸ç±¤æ–°èçš„æ–¹æ³•ï¼ˆå›å‚³ Flowï¼‰\n' +
    '    \n' +
    '    // TODO: å®šç¾©åˆ‡æ›æ›¸ç±¤ç‹€æ…‹çš„æ–¹æ³•ï¼ˆsuspendï¼‰\n' +
    '}';
  steps.push({
    title:'å®šç¾© Repository ä»‹é¢',
    file:'core/data/BookmarksRepository.kt',
    content:function(){
      var s='<p>å®šç¾©ä¸€å€‹ <code>BookmarksRepository</code> ä»‹é¢ï¼ŒåŒ…å« <code>getBookmarkedNews()</code>ï¼ˆå›å‚³ Flowï¼‰å’Œ <code>toggleBookmark()</code>ï¼ˆsuspendï¼‰æ–¹æ³•ã€‚</p>';
      s+='<textarea class="code-editor" rows="8" oninput="S.part6Code1=this.value;save()">'+ escapeHtmlAttr(S.part6Code1||code1Default)+'</textarea>';
      s+=insightBlock(18,'<strong>Repository ä»‹é¢å®šç¾©çš„è¨­è¨ˆæ€ç¶­</strong><br>NIA çš„åšæ³•æ˜¯ã€Œå…ˆå®šåˆç´„å†å¯«å¯¦ä½œã€ï¼ˆContract-firstï¼‰ã€‚<br>å…ˆå®šç¾©ä»‹é¢ï¼Œæ‰€æœ‰ä¾è³´æ–¹éƒ½é¢å‘ä»‹é¢ç·¨ç¨‹ï¼Œå¯¦ä½œå¯ä»¥éš¨æ™‚æ›¿æ›ï¼ˆæ­£å¼ç‰ˆã€æ¸¬è©¦ç‰ˆã€é›¢ç·šç‰ˆï¼‰ã€‚é€™ä¹Ÿæ˜¯ Dependency Inversion Principle çš„é«”ç¾ã€‚');
      return s;
    }
  });

  // Step 2: UiState (ç¨‹å¼ç¢¼ç·¨è¼¯é¡Œ 2)
  var code2Default=
    'sealed interface BookmarksUiState {\n' +
    '    // TODO: å®šç¾© Loading ç‹€æ…‹\n' +
    '    \n' +
    '    // TODO: å®šç¾© Success ç‹€æ…‹ï¼ˆåŒ…å« bookmarks åˆ—è¡¨ï¼‰\n' +
    '}';
  steps.push({
    title:'å®šç¾© UiState',
    file:'feature/bookmarks/BookmarksUiState.kt',
    content:function(){
      var s='<p>å®šç¾© <code>BookmarksUiState</code> sealed interfaceï¼ŒåŒ…å« <code>Loading</code> å’Œ <code>Success</code>ï¼ˆå¸¶æœ‰ <code>BookmarkedNews</code> åˆ—è¡¨ï¼‰å…©ç¨®ç‹€æ…‹ã€‚</p>';
      s+='<textarea class="code-editor" rows="8" oninput="S.part6Code2=this.value;save()">'+escapeHtmlAttr(S.part6Code2||code2Default)+'</textarea>';
      return s;
    }
  });

  // Step 3: Fake Repository (ç¨‹å¼ç¢¼ç·¨è¼¯é¡Œ 3)
  var code3Default=
    'class TestBookmarksRepository : BookmarksRepository {\n' +
    '    // TODO: ä½¿ç”¨ MutableStateFlow å„²å­˜æ›¸ç±¤è³‡æ–™\n' +
    '    \n' +
    '    // TODO: å¯¦ä½œ getBookmarkedNews()\n' +
    '    \n' +
    '    // TODO: å¯¦ä½œ toggleBookmark()\n' +
    '}';
  steps.push({
    title:'å¯¦ä½œ Fake Repository',
    file:'core/testing/TestBookmarksRepository.kt',
    content:function(){
      var s='<p>å¯¦ä½œä¸€å€‹ <code>TestBookmarksRepository</code>ï¼Œä½¿ç”¨ <code>MutableStateFlow</code> å„²å­˜è³‡æ–™ã€‚é€™å°±æ˜¯ NIA çš„ Fake ç­–ç•¥ã€‚</p>';
      s+='<textarea class="code-editor" rows="12" oninput="S.part6Code3=this.value;save()">'+escapeHtmlAttr(S.part6Code3||code3Default)+'</textarea>';
      s+=insightBlock(19,'<strong>MutableStateFlow vs MutableSharedFlow</strong><br><code>MutableStateFlow</code>ï¼šä¿ç•™æœ€æ–°å€¼ï¼Œæ–°è¨‚é–±è€…æœƒç«‹å³æ”¶åˆ°æœ€æ–°å€¼ï¼ˆconflatedï¼‰ã€‚é©åˆè¡¨ç¤ºã€Œç‹€æ…‹ã€ã€‚<br><code>MutableSharedFlow</code>ï¼šä¸ä¿ç•™å€¼ï¼Œåªæœ‰åœ¨ emit æ™‚æ‰æ”¶åˆ°ã€‚é©åˆè¡¨ç¤ºã€Œäº‹ä»¶ã€ã€‚<br>åœ¨ Fake Repository ä¸­é€šå¸¸ç”¨ StateFlowï¼Œå› ç‚º Repository ä»£è¡¨çš„æ˜¯è³‡æ–™ç‹€æ…‹ã€‚');
      return s;
    }
  });

  // Step 4: ViewModel
  steps.push({
    title:'å¯¦ä½œ ViewModel',
    file:'feature/bookmarks/BookmarksViewModel.kt',
    content:function(){
      var s='<p>ViewModel å°‡ Repository çš„ Flow è½‰æ›ç‚º UI å¯è§€å¯Ÿçš„ StateFlowï¼Œä¸¦è™•ç†ä½¿ç”¨è€…äº’å‹•ã€‚</p>';
      s+=codeBlock(
        '@HiltViewModel\n' +
        'class BookmarksViewModel @Inject constructor(\n' +
        '    private val bookmarksRepository: BookmarksRepository\n' +
        ') : ViewModel() {\n' +
        '    val uiState: StateFlow<BookmarksUiState> =\n' +
        '        bookmarksRepository.getBookmarkedNews()\n' +
        '            .map(BookmarksUiState::Success)\n' +
        '            .stateIn(\n' +
        '                scope = viewModelScope,\n' +
        '                started = SharingStarted\n' +
        '                    .WhileSubscribed(5_000),\n' +
        '                initialValue =\n' +
        '                    BookmarksUiState.Loading\n' +
        '            )\n' +
        '\n' +
        '    fun toggleBookmark(newsId: String) {\n' +
        '        viewModelScope.launch {\n' +
        '            bookmarksRepository\n' +
        '                .toggleBookmark(newsId)\n' +
        '        }\n' +
        '    }\n' +
        '}'
      );
      return s;
    }
  });

  // Step 5: Compose UI
  steps.push({
    title:'Compose UI',
    file:'feature/bookmarks/BookmarksScreen.kt',
    content:function(){
      var s='<p>æœ€å¾Œä¸€æ­¥ï¼šç”¨ Compose å»ºç«‹ UIï¼Œé€£æ¥ ViewModelã€‚</p>';
      s+=codeBlock(
        '@Composable\n' +
        'fun BookmarksScreen(\n' +
        '    viewModel: BookmarksViewModel =\n' +
        '        hiltViewModel()\n' +
        ') {\n' +
        '    val uiState by viewModel.uiState\n' +
        '        .collectAsStateWithLifecycle()\n' +
        '\n' +
        '    when (uiState) {\n' +
        '        is BookmarksUiState.Loading -> {\n' +
        '            CircularProgressIndicator()\n' +
        '        }\n' +
        '        is BookmarksUiState.Success -> {\n' +
        '            LazyColumn {\n' +
        '                items(\n' +
        '                    (uiState as\n' +
        '                        BookmarksUiState.Success\n' +
        '                    ).bookmarks\n' +
        '                ) { news ->\n' +
        '                    BookmarkItem(\n' +
        '                        news = news,\n' +
        '                        onToggle = {\n' +
        '                            viewModel\n' +
        '                                .toggleBookmark(\n' +
        '                                    news.id\n' +
        '                                )\n' +
        '                        }\n' +
        '                    )\n' +
        '                }\n' +
        '            }\n' +
        '        }\n' +
        '    }\n' +
        '}'
      );
      return s;
    }
  });

  // Render current step
  h+='<div class="step-card"><div class="step-num">Step '+(step+1)+' / '+steps.length+'</div>';
  h+='<h3>'+steps[step].title+'</h3>';
  h+='<div class="step-file"><code>'+steps[step].file+'</code></div>';
  h+=steps[step].content();
  h+='</div>';

  // Step navigation
  h+='<div class="step-nav">';
  if(step>0){
    h+='<button class="btn btn-sec" onclick="S.part6Step='+(step-1)+';save();render()">\u2190 ä¸Šä¸€æ­¥</button>';
  }else{
    h+='<button class="btn btn-sec" disabled>\u2190 ä¸Šä¸€æ­¥</button>';
  }
  h+='<span style="opacity:0.7">Step '+(step+1)+' / '+steps.length+'</span>';
  if(step<steps.length-1){
    h+='<button class="btn btn-pri" onclick="S.part6Step='+(step+1)+';save();render()">ä¸‹ä¸€æ­¥ \u2192</button>';
  }else{
    h+='<button class="btn btn-pri" onclick="checkCode6()" '+(done?'disabled':'')+'>'+( done?'\u2705 å·²å®Œæˆé©—è­‰':'\u{1F50D} é©—è­‰ç¨‹å¼ç¢¼')+'</button>';
  }
  h+='</div>';

  // --- é–±è®€å®ŒæˆæŒ‰éˆ• ---
  h+='<div class="read-done'+(read?' done':'')+'"><button class="btn '+(read?'btn-sec':'btn-pri')+'" onclick="markRead(6)">'+(read?'\u2713 å·²é–±è®€':'\u{1F4D6} æ¨™è¨˜å·²é–±è®€')+'</button></div>';

  // --- ç°¡å ±å¡ ---
  h+=briefCard(6,
    'æ¨¡æ“¬åŠŸèƒ½å¯¦ä½œ',
    ['æŒ‰ç…§ NIA æ¨¡å¼å¯¦ä½œå®Œæ•´åŠŸèƒ½æµç¨‹','å¾ Model \u2192 Repository \u2192 UiState \u2192 ViewModel \u2192 Compose'],
    'é€™å€‹æµç¨‹ä¸æœƒå¤ªå†—é•·å—ï¼Ÿ',
    'åˆçœ‹æ­¥é©Ÿå¤šï¼Œä½†æ¯ä¸€æ­¥éƒ½æœ‰æ˜ç¢ºè·è²¬å’Œå¯æ¸¬è©¦æ€§ã€‚å¯¦éš›é–‹ç™¼ä¸­ï¼Œé€™å€‹æ¨¡å¼è®“æ–°åŠŸèƒ½çš„é–‹ç™¼è®Šæˆå¡«ç©ºé¡Œï¼Œé™ä½äº†èªçŸ¥è² æ“”ã€‚'
  );

  return h;
}

// --- checkCode6 ---
function checkCode6(){
  var checks=[
    {code:S.part6Code1||'',keywords:['fun getBookmarkedNews','Flow','fun toggleBookmark','suspend'],label:'Repository ä»‹é¢'},
    {code:S.part6Code2||'',keywords:['Loading','Success','BookmarkedNews'],label:'UiState å®šç¾©'},
    {code:S.part6Code3||'',keywords:['MutableStateFlow','override','getBookmarkedNews','toggleBookmark'],label:'Fake Repository'}
  ];
  var allPass=true;
  var msgs=[];

  for(var i=0;i<checks.length;i++){
    var missing=[];
    for(var k=0;k<checks[i].keywords.length;k++){
      if(checks[i].code.indexOf(checks[i].keywords[k])===-1){
        missing.push(checks[i].keywords[k]);
      }
    }
    if(missing.length>0){
      allPass=false;
      msgs.push(checks[i].label+'ï¼šç¼ºå°‘é—œéµå­— â†’ '+missing.join(', '));
    }
  }

  if(allPass){
    completePart(6);
    addXP(60,'ç¨‹å¼ç¢¼å¯¦ä½œå…¨æ•¸é€šéï¼');
    alert('\u{1F389} å¤ªæ£’äº†ï¼ä½ å·²å®Œæˆ Part 6 çš„åŠŸèƒ½å¯¦ä½œï¼');
  }else{
    alert('\u274C å°šæœªé€šéï¼š\n'+msgs.join('\n'));
  }
  render();
}


// ===== Part 7: ç¶œåˆé©—è­‰ â€” 20 é¡Œé¸æ“‡é¡Œ =====
function getPart7(){
  const done=S.completedParts.includes(7);
  let h='<div class="part-hdr"><span class="tag">Part 7</span><h1>\u{1F3C6} ç¶œåˆé©—è­‰</h1><p class="desc">20 é¡Œé¸æ“‡é¡Œï¼Œæ¶µè“‹æ‰€æœ‰ç« ç¯€ â€” ç¬¬ä¸€æ€§åŸç†ï¼šé©—è­‰æ‰æ˜¯å­¸ç¿’çš„çµ‚é»</p></div>';

  h+='<p>é€™æ˜¯æœ€çµ‚é©—è­‰ï¼Œ20 é¡Œæ¶µè“‹æ‰€æœ‰ç« ç¯€çš„æ ¸å¿ƒæ¦‚å¿µã€‚<strong>ç­”å° 16 é¡Œä»¥ä¸Šå³é€šéã€‚</strong></p>';

  var questions=[
    {q:'NIA çš„ä¸»è¦ç›®çš„æ˜¯ä»€éº¼ï¼Ÿ',opts:['ä¸€å€‹ä¸Šæ¶çš„æ–°è App','Android é–‹ç™¼æœ€ä½³å¯¦è¸çš„åƒè€ƒå¯¦ä½œ','Google å…§éƒ¨å·¥å…·','Kotlin æ•™å­¸ç¯„ä¾‹']},
    {q:'NIA çš„ä¸‰å±¤æ¶æ§‹ä¸åŒ…å«å“ªä¸€å±¤ï¼Ÿ',opts:['UI Layer','Domain Layer','Data Layer','Network Layer']},
    {q:'åœ¨ NIA ä¸­ï¼ŒViewModel æš´éœ²çµ¦ UI çš„è³‡æ–™å‹åˆ¥é€šå¸¸æ˜¯ï¼Ÿ',opts:['LiveData','StateFlow','Observable','Channel']},
    {q:'sealed interface ç›¸æ¯” sealed class çš„å„ªå‹¢æ˜¯ï¼Ÿ',opts:['æ•ˆèƒ½æ›´å¥½','å¯ä»¥å¯¦ä½œå¤šå€‹ sealed interface','èªæ³•æ›´ç°¡å–®','æ”¯æ´ Java']},
    {q:'NIA çš„æ¨¡çµ„ä¾è³´æ–¹å‘æ˜¯ï¼Ÿ',opts:['core \u2192 feature \u2192 app','app \u2192 feature \u2192 core','ä»»æ„ä¾è³´','é›™å‘ä¾è³´']},
    {q:'Feature æ¨¡çµ„ä¹‹é–“çš„ä¾è³´è¦å‰‡æ˜¯ï¼Ÿ',opts:['å¯ä»¥äº’ç›¸ä¾è³´','ä¸èƒ½äº’ç›¸ä¾è³´','åªèƒ½å–®å‘ä¾è³´','é€é app æ¨¡çµ„ä¸­ç¹¼']},
    {q:'Convention Plugin çš„ä¸»è¦ç”¨é€”æ˜¯ï¼Ÿ',opts:['ç®¡ç†ç‰ˆæœ¬è™Ÿ','çµ±ä¸€æ¨¡çµ„çš„ Gradle è¨­å®š','è‡ªå‹•ç”Ÿæˆç¨‹å¼ç¢¼','åŸ·è¡Œæ¸¬è©¦']},
    {q:'NIA å¤§ç´„æœ‰å¤šå°‘å€‹æ¨¡çµ„ï¼Ÿ',opts:['5-10 å€‹','10-20 å€‹','30+ å€‹','100+ å€‹']},
    {q:'NIA çš„ Offline-first ç­–ç•¥ä¸­ï¼ŒSingle Source of Truth æ˜¯ï¼Ÿ',opts:['API Server','Room Database','SharedPreferences','DataStore']},
    {q:'æ¨¡å‹è½‰æ›éˆçš„æ­£ç¢ºé †åºæ˜¯ï¼Ÿ',opts:['NetworkModel \u2192 ExternalModel \u2192 Entity','NetworkModel \u2192 Entity \u2192 ExternalModel','Entity \u2192 NetworkModel \u2192 ExternalModel','ExternalModel \u2192 Entity \u2192 NetworkModel']},
    {q:'WorkManager åœ¨ NIA ä¸­è² è²¬ä»€éº¼ï¼Ÿ',opts:['UI æ¸²æŸ“','èƒŒæ™¯è³‡æ–™åŒæ­¥','ä¾è³´æ³¨å…¥','è·¯ç”±å°èˆª']},
    {q:'Change List Sync çš„å¥½è™•æ˜¯ï¼Ÿ',opts:['æ¸›å°‘æœ¬åœ°å„²å­˜','åªåŒæ­¥è®Šæ›´éƒ¨åˆ†ï¼Œæ¸›å°‘æµé‡','åŠ å¿« UI æ¸²æŸ“','ç°¡åŒ–ç¨‹å¼ç¢¼']},
    {q:'@Binds ç”¨æ–¼ä»€éº¼å ´æ™¯ï¼Ÿ',opts:['å»ºç«‹è³‡æ–™åº«','å‘Šè¨´ Hilt ä»‹é¢å°æ‡‰çš„å¯¦ä½œ','å•Ÿå‹• Worker','å®šç¾©è·¯ç”±']},
    {q:'NIA ç‚ºä»€éº¼åå¥½ Fake è€Œé Mockï¼Ÿ',opts:['Fake å¯«èµ·ä¾†æ›´å¿«','Fake æœ‰çœŸå¯¦è¡Œç‚ºä¸”å¯é‡ç”¨','Mock ä¸æ”¯æ´ Kotlin','Google è¦å®š']},
    {q:'ViewModel æ¸¬è©¦ä¸­ï¼ŒTurbine çš„ç”¨é€”æ˜¯ï¼Ÿ',opts:['æ•ˆèƒ½æ¸¬è©¦','æ¸¬è©¦ Flow çš„ç™¼å°„å€¼','UI æ¸¬è©¦','ç¶²è·¯æ¨¡æ“¬']},
    {q:'@HiltViewModel åšäº†ä»€éº¼ï¼Ÿ',opts:['è‡ªå‹•å»ºç«‹ ViewModel å·¥å» ','è®“ Hilt æä¾› ViewModel çš„ä¾è³´æ³¨å…¥','åŠ å¿«ç·¨è­¯','å•Ÿç”¨ Compose']},
    {q:'WhileSubscribed(5_000) ä¸­çš„ 5 ç§’æ˜¯ï¼Ÿ',opts:['API é€¾æ™‚','åœæ­¢ä¸Šæ¸¸ Flow å‰çš„ç­‰å¾…æ™‚é–“','é‡è©¦é–“éš”','å‹•ç•«æ™‚é•·']},
    {q:'operator fun invoke åœ¨ UseCase ä¸­çš„å¥½è™•æ˜¯ï¼Ÿ',opts:['æå‡æ•ˆèƒ½','è®“ UseCase å¯ä»¥åƒå‡½å¼ä¸€æ¨£è¢«å‘¼å«','æ”¯æ´ Java','è‡ªå‹•å¿«å–']},
    {q:'NIA çš„ Navigation ä½¿ç”¨ä»€éº¼æ¡†æ¶ï¼Ÿ',opts:['Fragment Navigation','Compose Navigation','è‡ªè£½è·¯ç”±','Deep Link only']},
    {q:'å¦‚æœè¦åœ¨ NIA ä¸­æ–°å¢ä¸€å€‹åŠŸèƒ½ï¼Œç¬¬ä¸€æ­¥æ‡‰è©²ï¼Ÿ',opts:['ä¿®æ”¹ app æ¨¡çµ„','å»ºç«‹æ–°çš„ feature æ¨¡çµ„','ä¿®æ”¹ core:network','ç›´æ¥åœ¨ç¾æœ‰ feature ä¸­åŠ ']}
  ];

  var correctAnswers=[1,3,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1];

  // Render questions in groups of 4
  for(var i=0;i<questions.length;i++){
    if(i%4===0) h+='<div class="glass-card" style="margin-bottom:16px">';
    h+='<div class="quiz-box" style="margin-bottom:12px">';
    h+='<div class="quiz-row"><span class="quiz-tag">Q'+(i+1)+'</span> '+questions[i].q+'</div>';
    for(var j=0;j<questions[i].opts.length;j++){
      var selected=S.part7Answers[i]===j;
      var cls='quiz-opt';
      if(S.part7Submitted){
        if(j===correctAnswers[i]) cls+=' correct';
        else if(selected && j!==correctAnswers[i]) cls+=' wrong';
      }else if(selected){
        cls+=' selected';
      }
      h+='<div class="'+cls+'" onclick="'+(S.part7Submitted?'':'S.part7Answers['+i+']='+j+';save();render()')+'"><span style="font-weight:600;margin-right:8px">'+String.fromCharCode(65+j)+')</span>'+questions[i].opts[j]+'</div>';
    }
    h+='</div>';
    if(i%4===3||i===questions.length-1) h+='</div>';
  }

  // çµæœé¡¯ç¤º
  if(S.part7Submitted){
    var score=0;
    var wrongList=[];
    for(var i=0;i<correctAnswers.length;i++){
      if(S.part7Answers[i]===correctAnswers[i]) score++;
      else wrongList.push('Q'+(i+1)+': æ­£ç¢ºç­”æ¡ˆæ˜¯ '+String.fromCharCode(65+correctAnswers[i])+') '+questions[i].opts[correctAnswers[i]]);
    }
    h+='<div class="glass-card" style="text-align:center;padding:24px">';
    h+='<h2>'+( score>=16?'\u{1F389}':'\u{1F4AA}')+' å¾—åˆ†ï¼š'+score+' / 20</h2>';
    if(score>=16){
      h+='<p style="color:#4caf50;font-weight:600">\u2705 æ­å–œé€šéæœ€çµ‚é©—è­‰ï¼</p>';
    }else{
      h+='<p style="color:#ff9800;font-weight:600">\u274C éœ€è¦ 16 é¡Œä»¥ä¸Šæ‰èƒ½é€šéï¼Œå†åŠ æ²¹ï¼</p>';
    }
    if(wrongList.length>0){
      h+='<div style="text-align:left;margin-top:16px"><strong>éŒ¯èª¤é¡Œç›®çš„æ­£ç¢ºç­”æ¡ˆï¼š</strong><ul>';
      for(var w=0;w<wrongList.length;w++){
        h+='<li>'+wrongList[w]+'</li>';
      }
      h+='</ul></div>';
    }
    h+='</div>';
  }

  // æäº¤æŒ‰éˆ•
  if(!S.part7Submitted){
    h+='<div style="text-align:center;margin:24px 0"><button class="btn btn-pri" onclick="checkQuiz7()">\u{1F4E4} æäº¤ç­”æ¡ˆ</button></div>';
  }else if(!done){
    h+='<div style="text-align:center;margin:24px 0"><button class="btn btn-sec" onclick="S.part7Submitted=false;S.part7Answers=Array(20).fill(null);save();render()">\u{1F504} é‡æ–°ä½œç­”</button></div>';
  }

  // Insight
  h+=insightBlock(20,'<strong>æŒçºŒå­¸ç¿’å»ºè­°</strong><br>æ¨è–¦é–±è®€ NIA åŸå§‹ç¢¼çš„é †åºï¼š<br>1\uFE0F\u20E3 <code>core:model</code> â€” äº†è§£è³‡æ–™çµæ§‹<br>2\uFE0F\u20E3 <code>core:data</code> â€” äº†è§£è³‡æ–™æµèˆ‡ Repository æ¨¡å¼<br>3\uFE0F\u20E3 <code>feature:foryou</code> â€” äº†è§£å®Œæ•´çš„ UI Layer å¦‚ä½•ä¸²æ¥<br>é€™å€‹é †åºå¾åº•å±¤å¾€ä¸Šï¼Œè®“ä½ è‡ªç„¶å»ºç«‹å®Œæ•´çš„å¿ƒæ™ºæ¨¡å‹ã€‚');

  return h;
}

// --- checkQuiz7 ---
function checkQuiz7(){
  var correctAnswers=[1,3,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1];
  var unanswered=[];
  for(var i=0;i<20;i++){
    if(S.part7Answers[i]===null||S.part7Answers[i]===undefined){
      unanswered.push('Q'+(i+1));
    }
  }
  if(unanswered.length>0){
    alert('\u26A0\uFE0F é‚„æœ‰ '+unanswered.length+' é¡Œæœªä½œç­”ï¼š'+unanswered.join(', '));
    return;
  }

  S.part7Submitted=true;
  save();

  var score=0;
  for(var i=0;i<correctAnswers.length;i++){
    if(S.part7Answers[i]===correctAnswers[i]) score++;
  }

  if(score>=16){
    completePart(7);
    addXP(100,'é€šéæœ€çµ‚é©—è­‰ï¼ç­”å° '+score+' / 20 é¡Œ');
  }

  render();
}


// ============================================================
// INIT
// ============================================================
function init(){
  load();
  updateStreak();
  if(S.openingDone){
    document.getElementById('opening').style.display='none';
  }
  render();
  
  // Close sidebar on main click (mobile)
  document.getElementById('main-content').addEventListener('click',()=>{
    document.getElementById('sidebar').classList.remove('open');
  });
}
window.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
